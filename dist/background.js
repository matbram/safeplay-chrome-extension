(()=>{"use strict";var e={167(e,t,r){r.d(t,{B3:()=>_,D4:()=>I,I4:()=>T,c4:()=>b,dF:()=>w,hD:()=>k,lX:()=>m,m_:()=>F,rz:()=>G,setAuthToken:()=>S,setCreditInfo:()=>C,setSubscriptionTier:()=>P,setUserCredits:()=>x,setUserId:()=>E,setUserProfile:()=>U,setUserSubscription:()=>R,uj:()=>A,v_:()=>v,wR:()=>O});var s=r(574);const a="safeplay_preferences",n="safeplay_auth_token",o="safeplay_refresh_token",c="safeplay_token_expires_at",i="safeplay_user_id",u="safeplay_subscription_tier",l="safeplay_credit_info",d="safeplay_credit_cache_time",h="safeplay_cached_transcripts",f="safeplay_user_profile",p="safeplay_user_subscription",g="safeplay_user_credits",y="safeplay_profile_cache_time";async function m(){return(await chrome.storage.local.get(a))[a]||s.d}async function w(e){const t={...await m(),...e};return await chrome.storage.local.set({[a]:t}),t}async function _(){const e=(await chrome.storage.local.get(o))[o];if(!e)return console.log("[SafePlay Storage] No refresh token available"),null;try{console.log("[SafePlay Storage] Attempting to refresh auth token...");const t=await fetch("https://astonishing-youthfulness-production.up.railway.app/api/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})});if(!t.ok)return console.log("[SafePlay Storage] Token refresh failed, clearing auth data"),await chrome.storage.local.remove([n,o,c]),null;const r=await t.json();return await chrome.storage.local.set({[n]:r.access_token,[o]:r.refresh_token,[c]:r.expires_at}),console.log("[SafePlay Storage] Token refreshed successfully"),r.access_token}catch(e){return console.error("[SafePlay Storage] Token refresh error:",e),null}}async function b(){const e=await chrome.storage.local.get([n,o,c]),t=e[n],r=e[o],s=e[c];if(!t)return null;if(s&&1e3*s<Date.now()+3e5){if(console.log("[SafePlay Storage] Token expired or expiring soon, attempting refresh..."),r){const e=await _();if(e)return e}return console.log("[SafePlay Storage] Token refresh failed, user needs to re-login"),null}return t}async function S(e,t,r){const s={[n]:e};t&&(s[o]=t),r&&(s[c]=r),await chrome.storage.local.set(s)}async function E(e){await chrome.storage.local.set({[i]:e})}async function P(e){await chrome.storage.local.set({[u]:e})}async function T(){try{const e=await chrome.storage.local.get([l,d]),t=e[d],r=e[l];return t&&r&&Date.now()-t<3e5?r:null}catch(e){return console.error("[SafePlay Storage] Error getting credit info:",e),null}}async function C(e){try{await chrome.storage.local.set({[l]:e,[d]:Date.now()})}catch(e){console.error("[SafePlay Storage] Error setting credit info:",e)}}async function A(e){try{const t=await T();if(t){const r={...t,available:Math.max(0,t.available-e),used_this_period:t.used_this_period+e,percent_consumed:Math.min(100,(t.used_this_period+e)/t.plan_allocation*100)};await C(r)}}catch(e){console.error("[SafePlay Storage] Error updating credits after filter:",e)}}async function v(e){try{const t=(await chrome.storage.local.get(h))[h]||{},r=t[e];if(!r)return null;if(r.transcript)return r.timestamp=Date.now(),await chrome.storage.local.set({[h]:t}),r.transcript;if(r.segments){const s=r;return t[e]={transcript:s,timestamp:Date.now()},await chrome.storage.local.set({[h]:t}),s}return null}catch(e){return console.error("[SafePlay Storage] Error getting cached transcript:",e),null}}async function k(e,t){try{let r=(await chrome.storage.local.get(h))[h]||{};r[e]={transcript:t,timestamp:Date.now()};const s=Object.entries(r);if(s.length>15){s.sort((e,t)=>e[1].timestamp-t[1].timestamp);const e=s.slice(-15);r=Object.fromEntries(e),console.log("[SafePlay Storage] Trimmed transcript cache to 15 entries")}await chrome.storage.local.set({[h]:r})}catch(r){if(r instanceof Error&&r.message.includes("quota")){console.warn("[SafePlay Storage] Quota exceeded, clearing transcript cache..."),await I();try{const r={[e]:{transcript:t,timestamp:Date.now()}};await chrome.storage.local.set({[h]:r}),console.log("[SafePlay Storage] Cache cleared and new transcript saved")}catch(e){console.error("[SafePlay Storage] Failed to save transcript after clearing cache:",e)}}else console.error("[SafePlay Storage] Error caching transcript:",r)}}async function I(){await chrome.storage.local.remove(h)}async function O(){return null!==await b()}async function U(e){try{await chrome.storage.local.set({[f]:e,[y]:Date.now()})}catch(e){console.error("[SafePlay Storage] Error setting user profile:",e)}}async function R(e){try{e?await chrome.storage.local.set({[p]:e}):await chrome.storage.local.remove(p)}catch(e){console.error("[SafePlay Storage] Error setting user subscription:",e)}}async function x(e){try{e?await chrome.storage.local.set({[g]:e}):await chrome.storage.local.remove(g)}catch(e){console.error("[SafePlay Storage] Error setting user credits:",e)}}async function F(){try{await chrome.storage.local.remove([n,o,c,i,u,l,d,f,p,g,y]),console.log("[SafePlay Storage] Auth data cleared")}catch(e){console.error("[SafePlay Storage] Error clearing auth data:",e)}}async function G(){const e=await b();return{isAuthenticated:null!==e,profile:await async function(){try{const e=await chrome.storage.local.get([f,y]),t=e[y],r=e[f];return t&&r&&Date.now()-t<6e5?r:null}catch(e){return console.error("[SafePlay Storage] Error getting user profile:",e),null}}(),subscription:await async function(){try{return(await chrome.storage.local.get(p))[p]||null}catch(e){return console.error("[SafePlay Storage] Error getting user subscription:",e),null}}(),credits:await async function(){try{return(await chrome.storage.local.get(g))[g]||null}catch(e){return console.error("[SafePlay Storage] Error getting user credits:",e),null}}(),token:e}}},574(e,t,r){r.d(t,{d:()=>s});const s={enabled:!0,filterMode:"mute",severityLevels:{mild:!1,moderate:!0,severe:!0,religious:!1},customBlacklist:[],customWhitelist:[],paddingMs:50,paddingBeforeMs:100,paddingAfterMs:30,mergeThresholdMs:100,autoEnableForFilteredVideos:!0}}},t={};function r(s){var a=t[s];if(void 0!==a)return a.exports;var n=t[s]={exports:{}};return e[s](n,n.exports,r),n.exports}r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var s=r(167);function a(...e){console.log("[SafePlay API]",...e)}class n extends Error{constructor(e,t,r,s){super(e),this.statusCode=t,this.response=r,this.errorCode=s,this.name="ApiError"}}async function o(e,t={}){const{method:r="GET",body:c,requiresAuth:i=!0,_isRetry:u=!1}=t,l=`https://astonishing-youthfulness-production.up.railway.app${e}`;a(`>>> ${r} ${l}`,c?JSON.stringify(c):"");const d={"Content-Type":"application/json"};if(i){const e=await(0,s.c4)();a("Auth token:",e?`${e.substring(0,20)}...`:"none"),e&&(d.Authorization=`Bearer ${e}`)}try{const h=await fetch(l,{method:r,headers:d,body:c?JSON.stringify(c):void 0});if(a(`<<< ${h.status} ${h.statusText}`),!h.ok){const r=await h.text();a("Error response body:",r);let c={};try{c=JSON.parse(r)}catch{c={rawError:r}}if(401===h.status&&i&&!u){if(a("Got 401, attempting token refresh..."),await(0,s.B3)())return a("Token refreshed, retrying request..."),o(e,{...t,_isRetry:!0});throw a("Token refresh failed, user needs to re-login"),new n("Session expired. Please sign in again.",401,c,"SESSION_EXPIRED")}throw new n(c.message||c.error||`Request failed with status ${h.status}`,h.status,c,c.error_code)}const f=await h.json();return a("Response data:",JSON.stringify(f).substring(0,500)),f}catch(e){if(e instanceof n)throw e;const t=e instanceof Error?e.message:"Network error";throw a("Request failed:",t),new n(t,0,{networkError:!0,originalError:String(e)})}}async function c(e,t="mute",r){return a("=== startFilter ===",e,t),o("/api/filter/start",{method:"POST",body:{youtube_id:e,filter_type:t,custom_words:r},requiresAuth:!0})}function i(...e){console.log("[SafePlay BG]",...e)}function u(...e){console.error("[SafePlay BG ERROR]",...e)}async function l(){i("handleLogout called"),await(0,s.m_)();const e=await chrome.tabs.query({});for(const t of e)t.id&&chrome.tabs.sendMessage(t.id,{type:"AUTH_STATE_CHANGED",payload:{isAuthenticated:!1}}).catch(()=>{});return{success:!0}}chrome.runtime.onMessage.addListener((e,t,r)=>(async function(e){i("Received message:",e.type);try{switch(e.type){case"GET_FILTER":return await async function(e){const{youtubeId:t}=e;i("handleGetFilter called with youtubeId:",t);const r=await(0,s.v_)(t);if(r)return i("Found in local cache, returning cached transcript"),{success:!0,data:{status:"cached",transcript:r}};i("Not in local cache, making API request...");try{i("Calling requestFilter API...");const e=await async function(e){a("=== requestFilter (legacy) ===",e);try{const t=await c(e);return{status:t.status,cached:t.cached,transcript:t.transcript,job_id:t.job_id,error:t.error,error_code:t.error_code}}catch(e){if(e instanceof n)return{status:"failed",error:e.message,error_code:e.errorCode};throw e}}(t);if(i("API response:",JSON.stringify(e).substring(0,200)),"completed"===e.status&&e.transcript){i("API returned completed/cached transcript, saving locally");const r=e.transcript;if(i("Transcript structure:",{id:r.id,segmentCount:r.segments?.length,firstSegment:r.segments?.[0]?{text:r.segments[0].text,start_time:r.segments[0].start_time,end_time:r.segments[0].end_time,hasCharacters:!!r.segments[0].characters,characterCount:r.segments[0].characters?.length,firstChar:r.segments[0].characters?.[0],lastChar:r.segments[0].characters?.[r.segments[0].characters?.length-1]}:null}),r.segments&&r.segments.length>0)for(let e=0;e<Math.min(3,r.segments.length);e++){const t=r.segments[e];i(`Segment ${e}: "${t.text}" (${t.start_time}s - ${t.end_time}s)`,{characters:t.characters?.slice(0,5),totalChars:t.characters?.length})}return await(0,s.hD)(t,e.transcript),{success:!0,data:{status:"completed",transcript:e.transcript}}}return"processing"===e.status&&e.job_id?(i("API returned processing status, job_id:",e.job_id),{success:!0,data:{status:"processing",jobId:e.job_id}}):"failed"===e.status?(i("API returned failed status, error_code:",e.error_code),{success:!0,data:{status:"failed",error:e.error,error_code:e.error_code}}):(u("Unexpected API response:",e),{success:!1,error:"Unexpected API response: "+JSON.stringify(e)})}catch(e){return u("handleGetFilter error:",e),{success:!1,error:e instanceof Error?e.message:"Failed to request filter"}}}(e.payload);case"GET_PREVIEW":return await async function(e){const{youtubeId:t}=e;if(i("handleGetPreview called with youtubeId:",t),await(0,s.v_)(t)){i("Found in local cache, preview shows 0 cost");let e=0;const r=await(0,s.I4)();return r&&(e=r.available),{success:!0,data:{video:{youtube_id:t,title:"Cached Video",duration:0},creditCost:0,userCredits:e,hasSufficientCredits:!0,isCached:!0}}}i("Not in local cache, fetching preview from API...");try{const e=await async function(e){return a("=== getPreview ===",e),o("/api/filter/preview",{method:"POST",body:{youtube_id:e},requiresAuth:!0})}(t);if(i("Preview response:",JSON.stringify(e).substring(0,300)),e.error||e.error_code)return{success:!1,error:e.error||`Error: ${e.error_code}`,data:void 0};if(void 0!==e.user_credits){const t=await(0,s.I4)();t&&await(0,s.setCreditInfo)({...t,available:e.user_credits})}return{success:!0,data:{video:{youtube_id:e.youtube_id,title:e.title,duration:e.duration_seconds,thumbnail:e.thumbnail_url,channel:e.channel_name},creditCost:e.credit_cost,userCredits:e.user_credits,hasSufficientCredits:e.has_sufficient_credits,isCached:e.cached||e.has_transcript}}}catch(e){return u("handleGetPreview error:",e),{success:!1,error:e instanceof Error?e.message:"Failed to get preview"}}}(e.payload);case"START_FILTER":return await async function(e){const{youtubeId:t,filterType:r="mute",customWords:a}=e;i("handleStartFilter called:",{youtubeId:t,filterType:r});const n=await(0,s.v_)(t);if(n)return i("Found in local cache, returning cached transcript"),{success:!0,data:{status:"cached",transcript:n}};try{const e=await c(t,r,a);return i("Start filter response:",JSON.stringify(e).substring(0,300)),e.success?"completed"===e.status&&e.transcript?(i("API returned completed/cached transcript, saving locally"),await(0,s.hD)(t,e.transcript),{success:!0,data:{status:"completed",transcript:e.transcript}}):"processing"===e.status&&e.job_id?(i("API returned processing status, job_id:",e.job_id),{success:!0,data:{status:"processing",jobId:e.job_id}}):{success:!0,data:{status:"failed",error:e.error||"Unexpected response",error_code:e.error_code}}:{success:!0,data:{status:"failed",error:e.error,error_code:e.error_code}}}catch(e){return u("handleStartFilter error:",e),{success:!1,error:e instanceof Error?e.message:"Failed to start filter"}}}(e.payload);case"CHECK_JOB":return await async function(e){const{jobId:t}=e;i("handleCheckJob called with jobId:",t);try{i("Calling checkJobStatus API...");const e=await async function(e){return a("=== checkJobStatus ===",e),o(`/api/filter/status/${e}`,{method:"GET",requiresAuth:!0})}(t);if(i("Job status response:",JSON.stringify(e).substring(0,300)),"completed"===e.status&&e.transcript){const t=e.video?.youtube_id||e.transcript.id;i("Job completed, caching transcript for:",t);const r=e.transcript;i("Job transcript structure:",{id:r.id,segmentCount:r.segments?.length,firstSegment:r.segments?.[0]?{text:r.segments[0].text,start_time:r.segments[0].start_time,end_time:r.segments[0].end_time,hasCharacters:!!r.segments[0].characters,characterCount:r.segments[0].characters?.length,sampleChars:r.segments[0].characters?.slice(0,3)}:null}),await(0,s.hD)(t,e.transcript),await(0,s.uj)(1)}return{success:!0,data:e}}catch(e){return u("handleCheckJob error:",e),{success:!1,error:e instanceof Error?e.message:"Failed to check job status"}}}(e.payload);case"GET_CREDITS":return await async function(){i("handleGetCredits called");const e=await(0,s.I4)();if(e)return i("Returning cached credit info:",e),{success:!0,data:e};try{const e=await async function(){return a("=== getCreditBalance ==="),o("/api/credits/balance",{method:"GET",requiresAuth:!0})}();return i("Credit balance response:",JSON.stringify(e)),e.success?(await(0,s.setCreditInfo)(e.credits),{success:!0,data:e.credits}):{success:!1,error:e.error||"Failed to get credits"}}catch(e){return u("handleGetCredits error:",e),{success:!1,error:e instanceof Error?e.message:"Failed to get credits"}}}();case"GET_PREFERENCES":return await async function(){return{success:!0,data:await(0,s.lX)()}}();case"SET_PREFERENCES":return await async function(e){const t=await(0,s.dF)(e),r=await chrome.tabs.query({url:"*://www.youtube.com/*"});for(const e of r)e.id&&chrome.tabs.sendMessage(e.id,{type:"PREFERENCES_UPDATED",payload:t}).catch(()=>{});return{success:!0,data:t}}(e.payload);case"GET_AUTH_STATUS":return await async function(){const e=await(0,s.wR)();return{success:!0,data:{authenticated:e,token:e&&await(0,s.c4)()||void 0}}}();case"GET_USER_PROFILE":return await async function(){i("handleGetUserProfile called");const e=await(0,s.c4)();if(!e)return i("Not authenticated, returning empty auth state"),{success:!0,data:{isAuthenticated:!1,user:null,subscription:null,credits:null,token:null}};try{const t=await async function(){return a("=== getUserProfile ==="),o("/api/user/profile",{method:"GET",requiresAuth:!0})}();if(i("User profile response:",JSON.stringify(t).substring(0,300)),t.user&&await(0,s.setUserProfile)(t.user),t.subscription&&await(0,s.setUserSubscription)(t.subscription),t.credits){await(0,s.setUserCredits)(t.credits);const e=t.subscription?.plans?.name?.toLowerCase()||"free",r=t.subscription?.plans?.monthly_credits||30,a=t.credits.available_credits,n=t.credits.used_this_period;await(0,s.setCreditInfo)({available:a,used_this_period:n,plan_allocation:r,percent_consumed:r>0?n/r*100:0,plan:e})}return{success:!0,data:{isAuthenticated:!0,user:t.user,subscription:t.subscription,credits:t.credits,token:e}}}catch(e){if(u("handleGetUserProfile error:",e),e instanceof Error&&e.message.includes("401"))return i("Token invalid, clearing auth data"),await(0,s.m_)(),{success:!0,data:{isAuthenticated:!1,user:null,subscription:null,credits:null,token:null}};const t=await(0,s.rz)();return{success:!0,data:{isAuthenticated:t.isAuthenticated,user:t.profile,subscription:t.subscription,credits:t.credits,token:t.token}}}}();case"LOGOUT":return await l();case"OPEN_LOGIN":return await async function(){i("handleOpenLogin called");const e=chrome.runtime.id,t=`${d}/extension/auth?extensionId=${e}`;return await chrome.tabs.create({url:t}),{success:!0}}();case"CLEAR_CACHE":return await async function(){return await(0,s.D4)(),{success:!0}}();default:return{success:!1,error:"Unknown message type"}}}catch(e){const t=e instanceof Error?e.message:"Unknown error";return i("Message handler error:",t),{success:!1,error:t}}}(e).then(r),!0));const d="https://astonishing-youthfulness-production.up.railway.app";chrome.action.onClicked.addListener(e=>{i("Extension icon clicked")}),chrome.runtime.onInstalled.addListener(e=>{i("Extension installed/updated:",e.reason),e.reason}),chrome.runtime.onMessageExternal.addListener((e,t,s)=>{if(["https://astonishing-youthfulness-production.up.railway.app","https://safeplay.app","http://localhost:3000"].includes(t.origin||"")){if("AUTH_TOKEN"===e.type)return i("Received AUTH_TOKEN from website"),i("Message contains:",{hasToken:!!e.token,hasRefreshToken:!!e.refreshToken,hasExpiresAt:!!e.expiresAt,hasUserId:!!e.userId}),Promise.resolve().then(r.bind(r,167)).then(async({setAuthToken:t,setUserId:r,setSubscriptionTier:a,setCreditInfo:n,setUserProfile:o,setUserSubscription:c,setUserCredits:l})=>{try{await t(e.token,e.refreshToken,e.expiresAt),e.userId&&await r(e.userId),e.tier&&await a(e.tier),e.credits&&await n(e.credits),e.user&&await o(e.user),e.subscription&&await c(e.subscription),e.userCredits&&await l(e.userCredits);const u=await chrome.tabs.query({});for(const t of u)t.id&&chrome.tabs.sendMessage(t.id,{type:"AUTH_STATE_CHANGED",payload:{isAuthenticated:!0,user:e.user}}).catch(()=>{});i("Auth data stored successfully"),s({success:!0})}catch(e){u("Error storing auth data:",e),s({success:!1,error:"Failed to store auth data"})}}),!0;if("CREDIT_UPDATE"===e.type)return Promise.resolve().then(r.bind(r,167)).then(({setCreditInfo:t})=>{t(e.credits).then(()=>{chrome.tabs.query({}).then(t=>{for(const r of t)r.id&&chrome.tabs.sendMessage(r.id,{type:"CREDIT_UPDATE",payload:e.credits}).catch(()=>{})}),s({success:!0})})}),!0;if("LOGOUT"===e.type)return i("Received LOGOUT from website"),l().then(()=>{s({success:!0})}),!0}return!1}),i("SafePlay background service worker initialized")})();
//# sourceMappingURL=background.js.map