(()=>{"use strict";var e={77(e,t,a){a.d(t,{D4:()=>m,c4:()=>l,v_:()=>f,lX:()=>u,wR:()=>g,setAuthToken:()=>p,hD:()=>w,dF:()=>d,setSubscriptionTier:()=>y,setUserId:()=>h});const s={enabled:!0,filterMode:"mute",severityLevels:{mild:!1,moderate:!0,severe:!0},customBlacklist:[],customWhitelist:[],paddingMs:50,mergeThresholdMs:100},r="safeplay_preferences",n="safeplay_auth_token",o="safeplay_user_id",c="safeplay_subscription_tier",i="safeplay_cached_transcripts";async function u(){return(await chrome.storage.local.get(r))[r]||s}async function d(e){const t={...await u(),...e};return await chrome.storage.local.set({[r]:t}),t}async function l(){return(await chrome.storage.local.get(n))[n]||null}async function p(e){await chrome.storage.local.set({[n]:e})}async function h(e){await chrome.storage.local.set({[o]:e})}async function y(e){await chrome.storage.local.set({[c]:e})}async function f(e){return((await chrome.storage.local.get(i))[i]||{})[e]||null}async function w(e,t){const a=(await chrome.storage.local.get(i))[i]||{};a[e]=t,await chrome.storage.local.set({[i]:a})}async function m(){await chrome.storage.local.remove(i)}async function g(){return null!==await l()}}},t={};function a(s){var r=t[s];if(void 0!==r)return r.exports;var n=t[s]={exports:{}};return e[s](n,n.exports,a),n.exports}a.d=(e,t)=>{for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var s=a(77);class r extends Error{constructor(e,t,a){super(e),this.statusCode=t,this.response=a,this.name="ApiError"}}async function n(e,t={}){const{method:a="GET",body:n,requiresAuth:o=!0}=t,c={"Content-Type":"application/json"};if(o){const e=await(0,s.c4)();e&&(c.Authorization=`Bearer ${e}`)}const i=await fetch(`https://api.safeplay.app${e}`,{method:a,headers:c,body:n?JSON.stringify(n):void 0});if(!i.ok){const e=await i.json().catch(()=>({}));throw new r(e.message||`Request failed with status ${i.status}`,i.status,e)}return i.json()}async function o(e){return n(`/api/jobs/${e}`)}function c(...e){console.log("[SafePlay BG]",...e)}chrome.runtime.onMessage.addListener((e,t,a)=>(async function(e,t){c("Received message:",e.type);try{switch(e.type){case"GET_FILTER":return await async function(e,t){const{youtubeId:a}=e,i=await(0,s.v_)(a);if(i)return c("Returning cached transcript for:",a),{success:!0,data:{status:"cached",transcript:i}};try{const e=await async function(e,t){const a=await async function(e){return n("/api/filter",{method:"POST",body:{youtube_id:e}})}(e);if("cached"===a.status&&a.transcript)return a.transcript;if("processing"===a.status&&a.job_id)return async function(e,t,a=120,s=2e3){let n=0;for(;n<a;){const a=await o(e);if(t&&t(a.progress),"completed"===a.status&&a.transcript)return a.transcript;if("failed"===a.status)throw new r(a.error||"Transcription failed",500,a);await new Promise(e=>setTimeout(e,s)),n++}throw new r("Transcription timed out",408)}(a.job_id,t);throw new r("Unexpected response from filter API",500,a)}(a,e=>{t&&chrome.tabs.sendMessage(t,{type:"PROCESSING_PROGRESS",payload:{progress:e}}).catch(()=>{})});return await(0,s.hD)(a,e),t&&chrome.tabs.sendMessage(t,{type:"TRANSCRIPT_RECEIVED",payload:{transcript:e}}).catch(()=>{}),{success:!0,data:{status:"completed",transcript:e}}}catch(e){const a=e instanceof Error?e.message:"Failed to get transcript";return t&&chrome.tabs.sendMessage(t,{type:"PROCESSING_ERROR",payload:{error:a}}).catch(()=>{}),{success:!1,error:a}}}(e.payload,t.tab?.id);case"CHECK_JOB":return await async function(){return{success:!0,data:{message:"Use GET_FILTER instead"}}}(e.payload);case"GET_PREFERENCES":return await async function(){return{success:!0,data:await(0,s.lX)()}}();case"SET_PREFERENCES":return await async function(e){const t=await(0,s.dF)(e),a=await chrome.tabs.query({url:"*://www.youtube.com/*"});for(const e of a)e.id&&chrome.tabs.sendMessage(e.id,{type:"PREFERENCES_UPDATED",payload:t}).catch(()=>{});return{success:!0,data:t}}(e.payload);case"GET_AUTH_STATUS":return await async function(){const e=await(0,s.wR)();return{success:!0,data:{authenticated:e,token:e&&await(0,s.c4)()||void 0}}}();case"CLEAR_CACHE":return await async function(){return await(0,s.D4)(),{success:!0}}();default:return{success:!1,error:"Unknown message type"}}}catch(e){const t=e instanceof Error?e.message:"Unknown error";return c("Message handler error:",t),{success:!1,error:t}}}(e,t).then(a),!0)),chrome.action.onClicked.addListener(e=>{c("Extension icon clicked")}),chrome.runtime.onInstalled.addListener(e=>{c("Extension installed/updated:",e.reason),e.reason}),chrome.runtime.onMessageExternal.addListener((e,t,s)=>"https://safeplay.app"===t.origin&&"AUTH_TOKEN"===e.type&&(Promise.resolve().then(a.bind(a,77)).then(({setAuthToken:t,setUserId:a,setSubscriptionTier:r})=>{Promise.all([t(e.token),a(e.userId),r(e.tier)]).then(()=>{s({success:!0})})}),!0)),c("SafePlay background service worker initialized")})();
//# sourceMappingURL=background.js.map