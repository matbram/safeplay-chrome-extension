(()=>{"use strict";var t={77(t,e,a){a.d(e,{D4:()=>m,c4:()=>l,v_:()=>f,lX:()=>u,wR:()=>g,setAuthToken:()=>p,hD:()=>w,dF:()=>d,setSubscriptionTier:()=>y,setUserId:()=>h});const s={enabled:!0,filterMode:"mute",severityLevels:{mild:!1,moderate:!0,severe:!0},customBlacklist:[],customWhitelist:[],paddingMs:50,mergeThresholdMs:100},r="safeplay_preferences",n="safeplay_auth_token",c="safeplay_user_id",o="safeplay_subscription_tier",i="safeplay_cached_transcripts";async function u(){return(await chrome.storage.local.get(r))[r]||s}async function d(t){const e={...await u(),...t};return await chrome.storage.local.set({[r]:e}),e}async function l(){return(await chrome.storage.local.get(n))[n]||null}async function p(t){await chrome.storage.local.set({[n]:t})}async function h(t){await chrome.storage.local.set({[c]:t})}async function y(t){await chrome.storage.local.set({[o]:t})}async function f(t){return((await chrome.storage.local.get(i))[i]||{})[t]||null}async function w(t,e){const a=(await chrome.storage.local.get(i))[i]||{};a[t]=e,await chrome.storage.local.set({[i]:a})}async function m(){await chrome.storage.local.remove(i)}async function g(){return null!==await l()}}},e={};function a(s){var r=e[s];if(void 0!==r)return r.exports;var n=e[s]={exports:{}};return t[s](n,n.exports,a),n.exports}a.d=(t,e)=>{for(var s in e)a.o(e,s)&&!a.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var s=a(77);class r extends Error{constructor(t,e,a){super(t),this.statusCode=e,this.response=a,this.name="ApiError"}}async function n(t,e={}){const{method:a="GET",body:n,requiresAuth:c=!0}=e,o={"Content-Type":"application/json"};if(c){const t=await(0,s.c4)();t&&(o.Authorization=`Bearer ${t}`)}const i=await fetch(`https://api.safeplay.app${t}`,{method:a,headers:o,body:n?JSON.stringify(n):void 0});if(!i.ok){const t=await i.json().catch(()=>({}));throw new r(t.message||`Request failed with status ${i.status}`,i.status,t)}return i.json()}function c(...t){console.log("[SafePlay BG]",...t)}chrome.runtime.onMessage.addListener((t,e,a)=>(async function(t){c("Received message:",t.type);try{switch(t.type){case"GET_FILTER":return await async function(t){const{youtubeId:e}=t,a=await(0,s.v_)(e);if(a)return c("Returning cached transcript for:",e),{success:!0,data:{status:"cached",transcript:a}};try{const t=await async function(t){return n("/api/filter",{method:"POST",body:{youtube_id:t}})}(e);return"cached"===t.status&&t.transcript?(await(0,s.hD)(e,t.transcript),{success:!0,data:{status:"cached",transcript:t.transcript}}):"processing"===t.status&&t.job_id?{success:!0,data:{status:"processing",jobId:t.job_id}}:{success:!1,error:"Unexpected API response"}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to request filter"}}}(t.payload);case"CHECK_JOB":return await async function(t){const{jobId:e}=t;try{const t=await async function(t){return n(`/api/jobs/${t}`)}(e);return"completed"===t.status&&t.transcript&&await(0,s.hD)(t.transcript.youtube_id,t.transcript),{success:!0,data:t}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to check job status"}}}(t.payload);case"GET_PREFERENCES":return await async function(){return{success:!0,data:await(0,s.lX)()}}();case"SET_PREFERENCES":return await async function(t){const e=await(0,s.dF)(t),a=await chrome.tabs.query({url:"*://www.youtube.com/*"});for(const t of a)t.id&&chrome.tabs.sendMessage(t.id,{type:"PREFERENCES_UPDATED",payload:e}).catch(()=>{});return{success:!0,data:e}}(t.payload);case"GET_AUTH_STATUS":return await async function(){const t=await(0,s.wR)();return{success:!0,data:{authenticated:t,token:t&&await(0,s.c4)()||void 0}}}();case"CLEAR_CACHE":return await async function(){return await(0,s.D4)(),{success:!0}}();default:return{success:!1,error:"Unknown message type"}}}catch(t){const e=t instanceof Error?t.message:"Unknown error";return c("Message handler error:",e),{success:!1,error:e}}}(t).then(a),!0)),chrome.action.onClicked.addListener(t=>{c("Extension icon clicked")}),chrome.runtime.onInstalled.addListener(t=>{c("Extension installed/updated:",t.reason),t.reason}),chrome.runtime.onMessageExternal.addListener((t,e,s)=>"https://safeplay.app"===e.origin&&"AUTH_TOKEN"===t.type&&(Promise.resolve().then(a.bind(a,77)).then(({setAuthToken:e,setUserId:a,setSubscriptionTier:r})=>{Promise.all([e(t.token),a(t.userId),r(t.tier)]).then(()=>{s({success:!0})})}),!0)),c("SafePlay background service worker initialized")})();
//# sourceMappingURL=background.js.map