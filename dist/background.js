(()=>{"use strict";var e={167(e,t,r){r.d(t,{D4:()=>y,c4:()=>d,dF:()=>l,hD:()=>f,lX:()=>u,setAuthToken:()=>h,setSubscriptionTier:()=>m,setUserId:()=>g,v_:()=>p,wR:()=>w});var s=r(574);const a="safeplay_preferences",n="safeplay_auth_token",c="safeplay_user_id",o="safeplay_subscription_tier",i="safeplay_cached_transcripts";async function u(){return(await chrome.storage.local.get(a))[a]||s.d}async function l(e){const t={...await u(),...e};return await chrome.storage.local.set({[a]:t}),t}async function d(){return(await chrome.storage.local.get(n))[n]||null}async function h(e){await chrome.storage.local.set({[n]:e})}async function g(e){await chrome.storage.local.set({[c]:e})}async function m(e){await chrome.storage.local.set({[o]:e})}async function p(e){try{const t=(await chrome.storage.local.get(i))[i]||{},r=t[e];if(!r)return null;if(r.transcript)return r.timestamp=Date.now(),await chrome.storage.local.set({[i]:t}),r.transcript;if(r.segments){const s=r;return t[e]={transcript:s,timestamp:Date.now()},await chrome.storage.local.set({[i]:t}),s}return null}catch(e){return console.error("[SafePlay Storage] Error getting cached transcript:",e),null}}async function f(e,t){try{let r=(await chrome.storage.local.get(i))[i]||{};r[e]={transcript:t,timestamp:Date.now()};const s=Object.entries(r);if(s.length>15){s.sort((e,t)=>e[1].timestamp-t[1].timestamp);const e=s.slice(-15);r=Object.fromEntries(e),console.log("[SafePlay Storage] Trimmed transcript cache to 15 entries")}await chrome.storage.local.set({[i]:r})}catch(r){if(r instanceof Error&&r.message.includes("quota")){console.warn("[SafePlay Storage] Quota exceeded, clearing transcript cache..."),await y();try{const r={[e]:{transcript:t,timestamp:Date.now()}};await chrome.storage.local.set({[i]:r}),console.log("[SafePlay Storage] Cache cleared and new transcript saved")}catch(e){console.error("[SafePlay Storage] Failed to save transcript after clearing cache:",e)}}else console.error("[SafePlay Storage] Error caching transcript:",r)}}async function y(){await chrome.storage.local.remove(i)}async function w(){return null!==await d()}},574(e,t,r){r.d(t,{d:()=>s});const s={enabled:!0,filterMode:"mute",severityLevels:{mild:!1,moderate:!0,severe:!0,religious:!1},customBlacklist:[],customWhitelist:[],paddingMs:50,paddingBeforeMs:100,paddingAfterMs:30,mergeThresholdMs:100,autoEnableForFilteredVideos:!0}}},t={};function r(s){var a=t[s];if(void 0!==a)return a.exports;var n=t[s]={exports:{}};return e[s](n,n.exports,r),n.exports}r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var s=r(167);function a(...e){console.log("[SafePlay API]",...e)}class n extends Error{constructor(e,t,r,s){super(e),this.statusCode=t,this.response=r,this.errorCode=s,this.name="ApiError"}}async function c(e,t={}){const{method:r="GET",body:c,requiresAuth:o=!0}=t,i=`https://safeplay-orchestrator-production.up.railway.app${e}`;a(`>>> ${r} ${i}`,c?JSON.stringify(c):"");const u={"Content-Type":"application/json"};if(o){const e=await(0,s.c4)();a("Auth token:",e?`${e.substring(0,20)}...`:"none"),e&&(u.Authorization=`Bearer ${e}`)}try{const e=await fetch(i,{method:r,headers:u,body:c?JSON.stringify(c):void 0});if(a(`<<< ${e.status} ${e.statusText}`),!e.ok){const t=await e.text();a("Error response body:",t);let r={};try{r=JSON.parse(t)}catch{r={rawError:t}}throw new n(r.message||r.error||`Request failed with status ${e.status}`,e.status,r)}const t=await e.json();return a("Response data:",JSON.stringify(t).substring(0,500)),t}catch(e){if(e instanceof n)throw e;const t=e instanceof Error?e.message:"Network error";throw a("Request failed:",t),new n(t,0,{networkError:!0,originalError:String(e)})}}function o(...e){console.log("[SafePlay BG]",...e)}function i(...e){console.error("[SafePlay BG ERROR]",...e)}chrome.runtime.onMessage.addListener((e,t,r)=>(async function(e){o("Received message:",e.type);try{switch(e.type){case"GET_FILTER":return await async function(e){const{youtubeId:t}=e;o("handleGetFilter called with youtubeId:",t);const r=await(0,s.v_)(t);if(r)return o("Found in local cache, returning cached transcript"),{success:!0,data:{status:"cached",transcript:r}};o("Not in local cache, making API request...");try{o("Calling requestFilter API...");const e=await async function(e){return a("=== requestFilter ===",e),c("/api/filter",{method:"POST",body:{youtube_id:e},requiresAuth:!1})}(t);if(o("API response:",JSON.stringify(e).substring(0,200)),"completed"===e.status&&e.transcript){o("API returned completed/cached transcript, saving locally");const r=e.transcript;if(o("Transcript structure:",{id:r.id,segmentCount:r.segments?.length,firstSegment:r.segments?.[0]?{text:r.segments[0].text,start_time:r.segments[0].start_time,end_time:r.segments[0].end_time,hasCharacters:!!r.segments[0].characters,characterCount:r.segments[0].characters?.length,firstChar:r.segments[0].characters?.[0],lastChar:r.segments[0].characters?.[r.segments[0].characters?.length-1]}:null}),r.segments&&r.segments.length>0)for(let e=0;e<Math.min(3,r.segments.length);e++){const t=r.segments[e];o(`Segment ${e}: "${t.text}" (${t.start_time}s - ${t.end_time}s)`,{characters:t.characters?.slice(0,5),totalChars:t.characters?.length})}return await(0,s.hD)(t,e.transcript),{success:!0,data:{status:"completed",transcript:e.transcript}}}return"processing"===e.status&&e.job_id?(o("API returned processing status, job_id:",e.job_id),{success:!0,data:{status:"processing",jobId:e.job_id}}):"failed"===e.status?(o("API returned failed status, error_code:",e.error_code),{success:!0,data:{status:"failed",error:e.error,error_code:e.error_code}}):(i("Unexpected API response:",e),{success:!1,error:"Unexpected API response: "+JSON.stringify(e)})}catch(e){return i("handleGetFilter error:",e),{success:!1,error:e instanceof Error?e.message:"Failed to request filter"}}}(e.payload);case"CHECK_JOB":return await async function(e){const{jobId:t}=e;o("handleCheckJob called with jobId:",t);try{o("Calling checkJobStatus API...");const e=await async function(e){return a("=== checkJobStatus ===",e),c(`/api/jobs/${e}`,{requiresAuth:!1})}(t);if(o("Job status response:",JSON.stringify(e).substring(0,300)),"completed"===e.status&&e.transcript){const t=e.video?.youtube_id||e.transcript.id;o("Job completed, caching transcript for:",t);const r=e.transcript;o("Job transcript structure:",{id:r.id,segmentCount:r.segments?.length,firstSegment:r.segments?.[0]?{text:r.segments[0].text,start_time:r.segments[0].start_time,end_time:r.segments[0].end_time,hasCharacters:!!r.segments[0].characters,characterCount:r.segments[0].characters?.length,sampleChars:r.segments[0].characters?.slice(0,3)}:null}),await(0,s.hD)(t,e.transcript)}return{success:!0,data:e}}catch(e){return i("handleCheckJob error:",e),{success:!1,error:e instanceof Error?e.message:"Failed to check job status"}}}(e.payload);case"GET_PREFERENCES":return await async function(){return{success:!0,data:await(0,s.lX)()}}();case"SET_PREFERENCES":return await async function(e){const t=await(0,s.dF)(e),r=await chrome.tabs.query({url:"*://www.youtube.com/*"});for(const e of r)e.id&&chrome.tabs.sendMessage(e.id,{type:"PREFERENCES_UPDATED",payload:t}).catch(()=>{});return{success:!0,data:t}}(e.payload);case"GET_AUTH_STATUS":return await async function(){const e=await(0,s.wR)();return{success:!0,data:{authenticated:e,token:e&&await(0,s.c4)()||void 0}}}();case"CLEAR_CACHE":return await async function(){return await(0,s.D4)(),{success:!0}}();default:return{success:!1,error:"Unknown message type"}}}catch(e){const t=e instanceof Error?e.message:"Unknown error";return o("Message handler error:",t),{success:!1,error:t}}}(e).then(r),!0)),chrome.action.onClicked.addListener(e=>{o("Extension icon clicked")}),chrome.runtime.onInstalled.addListener(e=>{o("Extension installed/updated:",e.reason),e.reason}),chrome.runtime.onMessageExternal.addListener((e,t,s)=>"https://safeplay.app"===t.origin&&"AUTH_TOKEN"===e.type&&(Promise.resolve().then(r.bind(r,167)).then(({setAuthToken:t,setUserId:r,setSubscriptionTier:a})=>{Promise.all([t(e.token),r(e.userId),a(e.tier)]).then(()=>{s({success:!0})})}),!0)),o("SafePlay background service worker initialized")})();
//# sourceMappingURL=background.js.map