(()=>{"use strict";var t={77(t,e,s){s.d(e,{D4:()=>y,c4:()=>d,v_:()=>p,lX:()=>u,wR:()=>w,setAuthToken:()=>h,hD:()=>f,dF:()=>l,setSubscriptionTier:()=>m,setUserId:()=>g});const r={enabled:!0,filterMode:"mute",severityLevels:{mild:!1,moderate:!0,severe:!0},customBlacklist:[],customWhitelist:[],paddingMs:50,mergeThresholdMs:100},a="safeplay_preferences",n="safeplay_auth_token",c="safeplay_user_id",o="safeplay_subscription_tier",i="safeplay_cached_transcripts";async function u(){return(await chrome.storage.local.get(a))[a]||r}async function l(t){const e={...await u(),...t};return await chrome.storage.local.set({[a]:e}),e}async function d(){return(await chrome.storage.local.get(n))[n]||null}async function h(t){await chrome.storage.local.set({[n]:t})}async function g(t){await chrome.storage.local.set({[c]:t})}async function m(t){await chrome.storage.local.set({[o]:t})}async function p(t){return((await chrome.storage.local.get(i))[i]||{})[t]||null}async function f(t,e){const s=(await chrome.storage.local.get(i))[i]||{};s[t]=e,await chrome.storage.local.set({[i]:s})}async function y(){await chrome.storage.local.remove(i)}async function w(){return null!==await d()}}},e={};function s(r){var a=e[r];if(void 0!==a)return a.exports;var n=e[r]={exports:{}};return t[r](n,n.exports,s),n.exports}s.d=(t,e)=>{for(var r in e)s.o(e,r)&&!s.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var r=s(77);function a(...t){console.log("[SafePlay API]",...t)}class n extends Error{constructor(t,e,s){super(t),this.statusCode=e,this.response=s,this.name="ApiError"}}async function c(t,e={}){const{method:s="GET",body:c,requiresAuth:o=!0}=e,i=`https://safeplay-orchestrator-production.up.railway.app${t}`;a(`>>> ${s} ${i}`,c?JSON.stringify(c):"");const u={"Content-Type":"application/json"};if(o){const t=await(0,r.c4)();a("Auth token:",t?`${t.substring(0,20)}...`:"none"),t&&(u.Authorization=`Bearer ${t}`)}try{const t=await fetch(i,{method:s,headers:u,body:c?JSON.stringify(c):void 0});if(a(`<<< ${t.status} ${t.statusText}`),!t.ok){const e=await t.text();a("Error response body:",e);let s={};try{s=JSON.parse(e)}catch{s={rawError:e}}throw new n(s.message||s.error||`Request failed with status ${t.status}`,t.status,s)}const e=await t.json();return a("Response data:",JSON.stringify(e).substring(0,500)),e}catch(t){if(t instanceof n)throw t;const e=t instanceof Error?t.message:"Network error";throw a("Request failed:",e),new n(e,0,{networkError:!0,originalError:String(t)})}}function o(...t){console.log("[SafePlay BG]",...t)}function i(...t){console.error("[SafePlay BG ERROR]",...t)}chrome.runtime.onMessage.addListener((t,e,s)=>(async function(t){o("Received message:",t.type);try{switch(t.type){case"GET_FILTER":return await async function(t){const{youtubeId:e}=t;o("handleGetFilter called with youtubeId:",e);const s=await(0,r.v_)(e);if(s)return o("Found in local cache, returning cached transcript"),{success:!0,data:{status:"cached",transcript:s}};o("Not in local cache, making API request...");try{o("Calling requestFilter API...");const t=await async function(t){return a("=== requestFilter ===",t),c("/api/filter",{method:"POST",body:{youtube_id:t},requiresAuth:!1})}(e);if(o("API response:",JSON.stringify(t).substring(0,200)),"completed"===t.status&&t.transcript){o("API returned completed/cached transcript, saving locally");const s=t.transcript;if(o("Transcript structure:",{id:s.id,segmentCount:s.segments?.length,firstSegment:s.segments?.[0]?{text:s.segments[0].text,start_time:s.segments[0].start_time,end_time:s.segments[0].end_time,hasCharacters:!!s.segments[0].characters,characterCount:s.segments[0].characters?.length,firstChar:s.segments[0].characters?.[0],lastChar:s.segments[0].characters?.[s.segments[0].characters?.length-1]}:null}),s.segments&&s.segments.length>0)for(let t=0;t<Math.min(3,s.segments.length);t++){const e=s.segments[t];o(`Segment ${t}: "${e.text}" (${e.start_time}s - ${e.end_time}s)`,{characters:e.characters?.slice(0,5),totalChars:e.characters?.length})}return await(0,r.hD)(e,t.transcript),{success:!0,data:{status:"completed",transcript:t.transcript}}}return"processing"===t.status&&t.job_id?(o("API returned processing status, job_id:",t.job_id),{success:!0,data:{status:"processing",jobId:t.job_id}}):(i("Unexpected API response:",t),{success:!1,error:"Unexpected API response: "+JSON.stringify(t)})}catch(t){return i("handleGetFilter error:",t),{success:!1,error:t instanceof Error?t.message:"Failed to request filter"}}}(t.payload);case"CHECK_JOB":return await async function(t){const{jobId:e}=t;o("handleCheckJob called with jobId:",e);try{o("Calling checkJobStatus API...");const t=await async function(t){return a("=== checkJobStatus ===",t),c(`/api/jobs/${t}`,{requiresAuth:!1})}(e);if(o("Job status response:",JSON.stringify(t).substring(0,300)),"completed"===t.status&&t.transcript){const e=t.video?.youtube_id||t.transcript.id;o("Job completed, caching transcript for:",e);const s=t.transcript;o("Job transcript structure:",{id:s.id,segmentCount:s.segments?.length,firstSegment:s.segments?.[0]?{text:s.segments[0].text,start_time:s.segments[0].start_time,end_time:s.segments[0].end_time,hasCharacters:!!s.segments[0].characters,characterCount:s.segments[0].characters?.length,sampleChars:s.segments[0].characters?.slice(0,3)}:null}),await(0,r.hD)(e,t.transcript)}return{success:!0,data:t}}catch(t){return i("handleCheckJob error:",t),{success:!1,error:t instanceof Error?t.message:"Failed to check job status"}}}(t.payload);case"GET_PREFERENCES":return await async function(){return{success:!0,data:await(0,r.lX)()}}();case"SET_PREFERENCES":return await async function(t){const e=await(0,r.dF)(t),s=await chrome.tabs.query({url:"*://www.youtube.com/*"});for(const t of s)t.id&&chrome.tabs.sendMessage(t.id,{type:"PREFERENCES_UPDATED",payload:e}).catch(()=>{});return{success:!0,data:e}}(t.payload);case"GET_AUTH_STATUS":return await async function(){const t=await(0,r.wR)();return{success:!0,data:{authenticated:t,token:t&&await(0,r.c4)()||void 0}}}();case"CLEAR_CACHE":return await async function(){return await(0,r.D4)(),{success:!0}}();default:return{success:!1,error:"Unknown message type"}}}catch(t){const e=t instanceof Error?t.message:"Unknown error";return o("Message handler error:",e),{success:!1,error:e}}}(t).then(s),!0)),chrome.action.onClicked.addListener(t=>{o("Extension icon clicked")}),chrome.runtime.onInstalled.addListener(t=>{o("Extension installed/updated:",t.reason),t.reason}),chrome.runtime.onMessageExternal.addListener((t,e,r)=>"https://safeplay.app"===e.origin&&"AUTH_TOKEN"===t.type&&(Promise.resolve().then(s.bind(s,77)).then(({setAuthToken:e,setUserId:s,setSubscriptionTier:a})=>{Promise.all([e(t.token),s(t.userId),a(t.tier)]).then(()=>{r({success:!0})})}),!0)),o("SafePlay background service worker initialized")})();
//# sourceMappingURL=background.js.map