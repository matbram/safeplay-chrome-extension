(()=>{"use strict";const e="data-safeplay-processed",t="safeplay-video-page-button-container",i="safeplay-shorts-button",s={idle:{bg:"#ff0000",hoverBg:"#cc0000",text:"SafePlay",shadow:"rgba(255, 0, 0, 0.3)"},connecting:{bg:"#3f3f3f",hoverBg:"#4f4f4f",text:"Connecting...",shadow:"rgba(63, 63, 63, 0.3)"},downloading:{bg:"#212121",hoverBg:"#2a2a2a",text:"Filtering...",shadow:"rgba(59, 130, 246, 0.4)",useWater:!0},transcribing:{bg:"#212121",hoverBg:"#2a2a2a",text:"Filtering...",shadow:"rgba(59, 130, 246, 0.4)",useWater:!0},processing:{bg:"#212121",hoverBg:"#2a2a2a",text:"Filtering...",shadow:"rgba(59, 130, 246, 0.4)",useWater:!0},filtering:{bg:"#3b82f6",hoverBg:"#2563eb",text:"Censored",shadow:"rgba(59, 130, 246, 0.4)"},paused:{bg:"#6b7280",hoverBg:"#4b5563",text:"Paused",shadow:"rgba(107, 114, 128, 0.4)"},error:{bg:"#ff4e45",hoverBg:"#e63e35",text:"Retry",shadow:"rgba(255, 78, 69, 0.4)"},"age-restricted":{bg:"#f59e0b",hoverBg:"#d97706",text:"Age-Restricted",shadow:"rgba(245, 158, 11, 0.4)"}};class n{constructor(e){this.observer=null,this.currentVideoId=null,this.injectionAttempts=0,this.maxAttempts=50,this.retryInterval=null,this.currentState="idle",this.shortsButtonStates=new Map,this.shortsScrollObserver=null,this.options=e}start(){this.log("Starting video page injector"),this.attemptInjection(),this.setupMutationObserver(),this.setupNavigationListener(),this.setupShortsScrollObserver()}stop(){this.observer&&(this.observer.disconnect(),this.observer=null),null!==this.retryInterval&&(clearInterval(this.retryInterval),this.retryInterval=null),this.shortsScrollObserver&&(this.shortsScrollObserver.disconnect(),this.shortsScrollObserver=null),this.log("Stopped video page injector")}isWatchPage(){return"/watch"===window.location.pathname&&window.location.search.includes("v=")}isShortsPage(){return window.location.pathname.startsWith("/shorts")}getVideoId(){return new URLSearchParams(window.location.search).get("v")}getShortsVideoId(){const e=window.location.pathname.match(/\/shorts\/([a-zA-Z0-9_-]+)/);return e?e[1]:null}attemptInjection(){if(this.isShortsPage())return void this.attemptShortsInjection();if(!this.isWatchPage())return;const e=this.getVideoId();if(!e)return void this.log("No video ID found");if(this.currentVideoId===e&&this.isButtonPresent())return void this.log("Button already present for this video");const t=this.findSubscribeButton();t?(this.injectButton(t,e),this.currentVideoId=e,this.injectionAttempts=0,null!==this.retryInterval&&(clearInterval(this.retryInterval),this.retryInterval=null)):(this.injectionAttempts++,this.log(`Subscribe button not found, attempt ${this.injectionAttempts}/${this.maxAttempts}`),this.injectionAttempts<this.maxAttempts&&null===this.retryInterval&&(this.retryInterval=window.setInterval(()=>{this.attemptInjection()},200)))}attemptShortsInjection(){document.querySelectorAll("ytd-reel-video-renderer, ytd-shorts").forEach(t=>{if("true"===t.getAttribute(e))return;const i=this.getShortsVideoIdFromRenderer(t);if(!i)return;const s=this.findShortsActionsContainer(t);s?(this.injectShortsButton(s,i,t),t.setAttribute(e,"true")):this.log("Shorts actions container not found for",i)}),this.injectIntoVisibleShort()}getShortsVideoIdFromRenderer(e){const t=e.querySelector('a[href*="/shorts/"]');if(t){const e=t.getAttribute("href"),i=e?.match(/\/shorts\/([a-zA-Z0-9_-]+)/);if(i)return i[1]}const i=e.querySelector("video");if(i){const e=i.src||i.currentSrc;if(e){const t=e.match(/\/([a-zA-Z0-9_-]{11})\//);if(t)return t[1]}}return null}findShortsActionsContainer(e){const t=["#actions","ytd-reel-player-overlay-renderer #actions","#like-button",'[id="like-button"]',"ytd-like-button-renderer"];for(const i of t){const t=e.querySelector(i);if(t)return this.log(`Found Shorts actions with selector: ${i}`),t}for(const e of t){const t=document.querySelector(`ytd-shorts ${e}, ytd-reel-video-renderer ${e}`);if(t)return this.log(`Found Shorts actions at document level: ${e}`),t}return null}injectIntoVisibleShort(){const e=this.getShortsVideoId();if(!e)return;if(document.querySelector(`.${i}[data-video-id="${e}"]`))return;const t=document.querySelector("ytd-shorts #actions, ytd-reel-video-renderer[is-active] #actions, #shorts-player #actions");if(t&&!t.querySelector(`.${i}`)){const i=t.closest("ytd-reel-video-renderer, ytd-shorts")||document.body;this.injectShortsButton(t,e,i)}}injectShortsButton(e,t,n){const r=n.querySelector(`.${i}[data-video-id="${t}"]`);r&&r.remove(),this.shortsButtonStates.has(t)||this.shortsButtonStates.set(t,"idle");const o=document.createElement("div");o.className=`${i}`,o.setAttribute("data-video-id",t),o.style.cssText="\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      margin-bottom: 16px;\n      cursor: pointer;\n    ";const a=document.createElement("button");a.className="safeplay-shorts-action-button";const l=this.shortsButtonStates.get(t)||"idle",d=s[l];a.style.cssText=`\n      width: 48px;\n      height: 48px;\n      border-radius: 50%;\n      border: none;\n      background: ${d.bg};\n      color: white;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n      position: relative;\n      overflow: hidden;\n    `;const c=document.createElement("div");c.className="safeplay-shorts-icon",c.style.cssText="display: flex; align-items: center; justify-content: center; position: relative; z-index: 1;",c.innerHTML=this.getShortsIconSVG(l),a.appendChild(c);const h=document.createElement("span");h.className="safeplay-shorts-label",h.style.cssText='\n      color: white;\n      font-size: 12px;\n      margin-top: 4px;\n      text-shadow: 0 1px 2px rgba(0,0,0,0.5);\n      font-family: "Roboto", "Arial", sans-serif;\n    ',h.textContent="filtering"===l?"Censored":"idle"===l?"SafePlay":d.text,a.addEventListener("mouseenter",()=>{const e=this.shortsButtonStates.get(t)||"idle",i=s[e];a.style.background=i.hoverBg,a.style.transform="scale(1.1)"}),a.addEventListener("mouseleave",()=>{const e=this.shortsButtonStates.get(t)||"idle",i=s[e];a.style.background=i.bg,a.style.transform="scale(1)"}),a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const i=this.shortsButtonStates.get(t)||"idle";"idle"===i||"error"===i?(this.currentVideoId=t,this.options.onButtonClick(t)):"filtering"!==i&&"paused"!==i||(this.currentVideoId=t,this.options.onToggleFilter&&this.options.onToggleFilter())}),o.appendChild(a),o.appendChild(h),e.insertBefore(o,e.firstChild),this.log(`Injected SafePlay Shorts button for video: ${t}`)}getShortsIconSVG(e){switch(e){case"connecting":case"downloading":case"transcribing":case"processing":return'\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="safeplay-spinner">\n            <style>.safeplay-spinner { animation: safeplay-spin 1s linear infinite; } @keyframes safeplay-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>\n            <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>\n            <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/>\n          </svg>\n        ';case"filtering":return'\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>\n          </svg>\n        ';case"paused":return'\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-1 14H9V9h2v6zm4 0h-2V9h2v6z"/>\n          </svg>\n        ';case"error":return'\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>\n          </svg>\n        ';case"age-restricted":return'\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>\n            <text x="12" y="15" text-anchor="middle" fill="#f59e0b" font-size="8" font-weight="bold" font-family="Arial">18</text>\n          </svg>\n        ';default:return'\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>\n          </svg>\n        '}}setupShortsScrollObserver(){this.shortsScrollObserver&&this.shortsScrollObserver.disconnect(),this.shortsScrollObserver=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target,s=this.getShortsVideoIdFromRenderer(t);s&&(this.log(`Short scrolled into view: ${s}`),this.currentVideoId=s,t.querySelector(`.${i}`)||this.attemptShortsInjection())}})},{threshold:.5}),this.observeShortsRenderers()}observeShortsRenderers(){this.shortsScrollObserver&&document.querySelectorAll("ytd-reel-video-renderer, ytd-shorts").forEach(e=>{this.shortsScrollObserver.observe(e)})}findSubscribeButton(){const e=["#subscribe-button.ytd-watch-metadata","ytd-watch-metadata #subscribe-button","#owner #subscribe-button","#subscribe-button"];for(const t of e){const e=document.querySelector(t);if(e)return this.log(`Found subscribe button with selector: ${t}`),e}return null}isButtonPresent(){return null!==document.querySelector(`.${t}`)}injectButton(i,n){const r=document.querySelector(`.${t}`);r&&r.remove(),this.currentState="idle";const o=document.createElement("div");o.className=`${t} style-scope ytd-watch-metadata`,o.style.cssText="display: inline-flex; align-items: center; margin-left: 8px;",o.setAttribute(e,"true");const a=document.createElement("button");a.className="safeplay-main-button yt-spec-button-shape-next yt-spec-button-shape-next--tonal yt-spec-button-shape-next--mono yt-spec-button-shape-next--size-m yt-spec-button-shape-next--icon-leading",a.title="Filter profanity with SafePlay",a.setAttribute("aria-label","SafePlay Filter"),a.setAttribute("data-video-id",n),o.setAttribute("data-video-id",n);const l=s.idle;a.style.cssText=`\n      border: none;\n      background: ${l.bg};\n      color: #ffffff;\n      border-radius: 18px;\n      padding: 0 16px;\n      height: 36px;\n      font-family: "Roboto", "Arial", sans-serif;\n      font-size: 14px;\n      font-weight: 500;\n      line-height: 36px;\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      gap: 6px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      min-width: 120px;\n      box-shadow: 0 2px 4px ${l.shadow};\n      position: relative;\n      overflow: hidden;\n    `;const d=document.createElement("div");d.className="safeplay-water-fill",d.style.cssText="\n      position: absolute;\n      bottom: 0;\n      left: 0;\n      right: 0;\n      height: 0%;\n      background: linear-gradient(to top, #3b82f6, #60a5fa);\n      transition: height 0.3s ease-out;\n      overflow: hidden;\n      border-radius: 18px;\n      z-index: 0;\n    ";const c=document.createElement("div");c.className="safeplay-icon",c.style.cssText="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; flex-shrink: 0; position: relative; z-index: 1;",c.innerHTML=this.getIconSVG("idle");const h=document.createElement("span");h.className="safeplay-text",h.style.cssText="color: currentColor; font-size: 14px; font-weight: 500; line-height: 1; white-space: nowrap; position: relative; z-index: 1;",h.textContent=l.text,a.appendChild(d),a.appendChild(c),a.appendChild(h),a.addEventListener("mouseenter",()=>{const e=s[this.currentState];a.style.background=e.hoverBg,a.style.boxShadow=`0 4px 8px ${e.shadow}`,a.style.transform="translateY(-1px)"}),a.addEventListener("mouseleave",()=>{const e=s[this.currentState];a.style.background=e.bg,a.style.boxShadow=`0 2px 4px ${e.shadow}`,a.style.transform="translateY(0)"}),a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),"idle"===this.currentState||"error"===this.currentState?this.options.onButtonClick(n):"filtering"!==this.currentState&&"paused"!==this.currentState||this.options.onToggleFilter&&this.options.onToggleFilter()}),o.appendChild(a),i.parentElement?.insertBefore(o,i.nextSibling),this.log(`Injected SafePlay button for video: ${n}`)}getIconSVG(e){switch(e){case"connecting":case"downloading":case"transcribing":case"processing":return'\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="safeplay-spinner">\n            <style>.safeplay-spinner { animation: safeplay-spin 1s linear infinite; } @keyframes safeplay-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>\n            <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>\n            <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/>\n          </svg>\n        ';case"filtering":return'\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>\n          </svg>\n        ';case"paused":return'\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-1 14H9V9h2v6zm4 0h-2V9h2v6z"/>\n          </svg>\n        ';case"error":return'\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>\n          </svg>\n        ';case"age-restricted":return'\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>\n            <text x="12" y="15" text-anchor="middle" fill="#f59e0b" font-size="8" font-weight="bold" font-family="Arial">18</text>\n          </svg>\n        ';default:return'\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>\n          </svg>\n        '}}updateButtonState(e){this.updateWatchPageButton(e);const t=e.videoId||this.currentVideoId;t&&this.updateShortsButton(t,e)}updateWatchPageButton(e){const i=document.querySelector(`.${t}`);if(!i)return;const n=i.getAttribute("data-video-id");if(e.videoId&&n&&e.videoId!==n)return void this.log(`Ignoring state update for ${e.videoId}, button is for ${n}`);const r=i.querySelector(".safeplay-main-button"),o=i.querySelector(".safeplay-text"),a=i.querySelector(".safeplay-icon"),l=i.querySelector(".safeplay-water-fill");if(!r||!o||!a)return;this.currentState=e.state;const d=s[e.state];r.style.background=d.bg,r.style.boxShadow=`0 2px 4px ${d.shadow}`,a.innerHTML=this.getIconSVG(e.state);let c=e.text||d.text;switch(void 0!==e.progress&&e.progress>0&&("downloading"!==e.state&&"transcribing"!==e.state&&"processing"!==e.state||(c=`${d.text.replace("...","")} ${Math.round(e.progress)}%`)),"filtering"===e.state&&void 0!==e.intervalCount&&(c=`Censored (${e.intervalCount})`),o.textContent=c,l&&(d.useWater&&void 0!==e.progress&&e.progress>0?(l.style.height=`${e.progress}%`,l.classList.remove("safeplay-water-full")):"filtering"===e.state?(l.style.height="100%",l.classList.add("safeplay-water-full")):(e.state,l.style.height="0%",l.classList.remove("safeplay-water-full"))),"idle"===e.state||"error"===e.state||"filtering"===e.state||"paused"===e.state?r.style.cursor="pointer":r.style.cursor="default",e.state){case"connecting":r.title="Connecting to SafePlay service...";break;case"downloading":r.title="Filtering: Downloading audio"+(e.progress?` (${Math.round(e.progress)}%)`:"...");break;case"transcribing":r.title="Filtering: Transcribing audio"+(e.progress?` (${Math.round(e.progress)}%)`:"...");break;case"processing":r.title="Filtering: Processing transcript...";break;case"filtering":r.title=`Censored${e.intervalCount?` - ${e.intervalCount} words filtered`:""} - Click to disable`;break;case"paused":r.title="Filter paused - Click to re-enable";break;case"error":r.title=e.error||"Something went wrong - Click to retry";break;case"age-restricted":r.title=e.error||"This video is age-restricted by YouTube. SafePlay cannot filter age-restricted content.";break;default:r.title="Click to filter profanity with SafePlay"}this.log(`Button state updated to: ${e.state}`,e)}setButtonState(e,t,i){this.updateButtonState({state:e,text:t||"",progress:i})}updateShortsButton(e,t){const n=document.querySelector(`.${i}[data-video-id="${e}"]`);if(!n)return;const r=n.querySelector(".safeplay-shorts-action-button"),o=n.querySelector(".safeplay-shorts-icon"),a=n.querySelector(".safeplay-shorts-label");if(!r||!o)return;this.shortsButtonStates.set(e,t.state);const l=s[t.state];if(r.style.background=l.bg,o.innerHTML=this.getShortsIconSVG(t.state),a){let e="idle"===t.state?"SafePlay":l.text;"filtering"===t.state&&void 0!==t.intervalCount?e=`${t.intervalCount}`:"filtering"===t.state&&(e="Censored"),void 0!==t.progress&&t.progress>0&&("downloading"!==t.state&&"transcribing"!==t.state&&"processing"!==t.state||(e=`${Math.round(t.progress)}%`)),a.textContent=e}"idle"===t.state||"error"===t.state||"filtering"===t.state||"paused"===t.state?r.style.cursor="pointer":r.style.cursor="default",this.log(`Shorts button state updated to: ${t.state} for ${e}`)}setupMutationObserver(){this.observer=new MutationObserver(e=>{for(const t of e)if("childList"===t.type&&t.addedNodes.length>0)for(const e of t.addedNodes)if(e instanceof HTMLElement){if("subscribe-button"===e.id||e.querySelector?.("#subscribe-button")||e.closest?.("ytd-watch-metadata"))return this.log("Subscribe button area changed, re-injecting"),void this.attemptInjection();if("YTD-REEL-VIDEO-RENDERER"===e.tagName||"YTD-SHORTS"===e.tagName||e.querySelector?.("ytd-reel-video-renderer"))return this.log("Shorts renderer added, attempting injection"),this.observeShortsRenderers(),void this.attemptShortsInjection();if(("actions"===e.id||e.querySelector?.("#actions"))&&this.isShortsPage())return this.log("Shorts actions container added"),void this.attemptShortsInjection()}}),this.observer.observe(document.body,{childList:!0,subtree:!0})}setupNavigationListener(){const e=history.pushState,t=history.replaceState;history.pushState=(...t)=>{e.apply(history,t),this.onNavigation()},history.replaceState=(...e)=>{t.apply(history,e),this.onNavigation()},window.addEventListener("popstate",()=>{this.onNavigation()}),document.addEventListener("yt-navigate-finish",()=>{this.onNavigation()}),document.addEventListener("yt-page-data-updated",()=>{this.log("Page data updated"),this.onNavigation()})}onNavigation(){this.log("Navigation detected"),this.currentVideoId=null,this.currentState="idle",this.injectionAttempts=0,null!==this.retryInterval&&(clearInterval(this.retryInterval),this.retryInterval=null),this.isShortsPage()&&(document.querySelectorAll(`[${e}]`).forEach(t=>{t.removeAttribute(e)}),document.querySelectorAll(`.${i}`).forEach(e=>{e.remove()}),this.shortsButtonStates.clear()),setTimeout(()=>{this.attemptInjection()},300)}getCurrentVideoId(){return this.currentVideoId}log(...e){this.options.debug&&console.log("[SafePlay Injector]",...e)}}const r=.08;class o{constructor(e){this.video=null,this.muteIntervals=[],this.filterMode="mute",this.isActive=!1,this.checkIntervalId=null,this.isMuted=!1,this.isFading=!1,this.isBleeping=!1,this.audioContext=null,this.sourceNode=null,this.gainNode=null,this.bleepOscillator=null,this.bleepGain=null,this.currentGainTarget=1,this.BLEEP_FREQUENCY=1e3,this.BLEEP_VOLUME=.35,this.BLEEP_ATTACK=.008,this.BLEEP_RELEASE=.025,this.onMuteStart=e?.onMuteStart,this.onMuteEnd=e?.onMuteEnd,this.boundHandleVideoPause=this.handleVideoPause.bind(this),this.boundHandleVideoPlay=this.handleVideoPlay.bind(this),this.boundHandleVideoEnded=this.handleVideoEnded.bind(this),this.boundHandleVideoSeeking=this.handleVideoSeeking.bind(this),this.boundHandleVisibilityChange=this.handleVisibilityChange.bind(this)}initialize(e,t,i="mute"){this.video=e,this.muteIntervals=t,this.filterMode=i,this.muteIntervals.sort((e,t)=>e.start-t.start),this.initializeAudioContext()}initializeAudioContext(){if(this.video&&!this.audioContext)try{this.audioContext=new AudioContext,this.sourceNode=this.audioContext.createMediaElementSource(this.video),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=1,this.sourceNode.connect(this.gainNode),this.gainNode.connect(this.audioContext.destination),"bleep"===this.filterMode&&(this.bleepGain=this.audioContext.createGain(),this.bleepGain.gain.value=0,this.bleepGain.connect(this.audioContext.destination)),this.addVideoEventListeners(),console.log("[SafePlay] Audio context initialized with smooth fading")}catch(e){console.error("[SafePlay] Failed to initialize audio context:",e)}}addVideoEventListeners(){this.video&&(this.video.addEventListener("pause",this.boundHandleVideoPause),this.video.addEventListener("play",this.boundHandleVideoPlay),this.video.addEventListener("ended",this.boundHandleVideoEnded),this.video.addEventListener("seeking",this.boundHandleVideoSeeking),document.addEventListener("visibilitychange",this.boundHandleVisibilityChange))}removeVideoEventListeners(){this.video&&(this.video.removeEventListener("pause",this.boundHandleVideoPause),this.video.removeEventListener("play",this.boundHandleVideoPlay),this.video.removeEventListener("ended",this.boundHandleVideoEnded),this.video.removeEventListener("seeking",this.boundHandleVideoSeeking)),document.removeEventListener("visibilitychange",this.boundHandleVisibilityChange)}handleVideoPause(){this.isBleeping&&this.stopBleep()}handleVideoPlay(){if(!this.video||!this.isActive)return;const e=this.video.currentTime;this.findActiveInterval(e)&&this.isMuted&&"bleep"===this.filterMode&&this.startBleep()}handleVideoEnded(){this.isBleeping&&this.stopBleep(),this.isMuted=!1,this.isBleeping=!1}handleVideoSeeking(){this.isBleeping&&this.stopBleep()}handleVisibilityChange(){if(!document.hidden&&this.video&&!this.video.paused&&this.isMuted&&"bleep"===this.filterMode){const e=this.video.currentTime;this.findActiveInterval(e)&&!this.bleepOscillator&&this.startBleep()}}start(){!this.isActive&&this.video&&(this.isActive=!0,"suspended"===this.audioContext?.state&&this.audioContext.resume(),this.checkIntervalId=window.setInterval(()=>{this.checkCurrentTime()},5),console.log("[SafePlay] Audio filter started with",this.muteIntervals.length,"intervals (smooth fading enabled)"))}stop(){if(this.isActive){if(this.isActive=!1,this.isBleeping=!1,null!==this.checkIntervalId&&(clearInterval(this.checkIntervalId),this.checkIntervalId=null),this.fadeToVolume(1),this.bleepOscillator){try{this.bleepOscillator.stop()}catch(e){}this.bleepOscillator=null}console.log("[SafePlay] Audio filter stopped")}}destroy(){this.stop(),this.removeVideoEventListeners(),this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null)}checkCurrentTime(){if(!this.video||!this.isActive)return;if(this.video.paused||this.video.ended||this.video.readyState<2)return;const e=this.video.currentTime,t=this.findActiveInterval(e),i=this.findApproachingInterval(e);t?this.isMuted||this.startMute(t):i?this.isMuted||this.isFading||this.startFadeOut(i):this.isMuted&&this.endMute()}findActiveInterval(e){for(const t of this.muteIntervals){if(e>=t.start&&e<=t.end)return t;if(t.start>e+r)break}return null}findApproachingInterval(e){for(const t of this.muteIntervals){if(e>=t.start-r&&e<t.start)return t;if(t.start>e+r)break}return null}startFadeOut(e){this.isFading=!0,this.fadeToVolume(0,()=>{this.isFading=!1,this.isMuted=!0,this.onMuteStart&&this.onMuteStart(e)}),"bleep"===this.filterMode&&this.startBleep()}startMute(e){this.isMuted=!0,this.fadeToVolume(0),"bleep"===this.filterMode&&this.startBleep(),this.onMuteStart&&this.onMuteStart(e)}endMute(){this.isMuted=!1,this.fadeToVolume(1),"bleep"===this.filterMode&&this.stopBleep(),this.onMuteEnd&&this.onMuteEnd()}fadeToVolume(e,t){if(this.currentGainTarget!==e)if(this.currentGainTarget=e,this.gainNode&&this.audioContext){const i=this.audioContext.currentTime;this.gainNode.gain.cancelScheduledValues(i),this.gainNode.gain.setValueAtTime(this.gainNode.gain.value,i),this.gainNode.gain.linearRampToValueAtTime(e,i+.05),t&&setTimeout(t,50)}else this.video&&(this.video.muted=0===e),t?.();else t?.()}startBleep(){if(!this.audioContext||!this.bleepGain)return;if(this.video&&(this.video.paused||this.video.ended))return;if(this.bleepOscillator)return;this.isBleeping=!0,"suspended"===this.audioContext.state&&this.audioContext.resume(),this.bleepOscillator=this.audioContext.createOscillator(),this.bleepOscillator.type="sine",this.bleepOscillator.frequency.value=this.BLEEP_FREQUENCY;const e=this.audioContext.createOscillator();e.type="sine",e.frequency.value=1.001*this.BLEEP_FREQUENCY;const t=this.audioContext.createGain();t.gain.value=.5,this.bleepOscillator.connect(this.bleepGain),e.connect(t),t.connect(this.bleepGain);const i=this.audioContext.currentTime;this.bleepGain.gain.setValueAtTime(0,i),this.bleepGain.gain.linearRampToValueAtTime(this.BLEEP_VOLUME,i+this.BLEEP_ATTACK),this.bleepOscillator.start(i),e.start(i),this.bleepOscillator._secondOscillator=e,this.bleepOscillator._mixer=t}stopBleep(){if(this.isBleeping=!1,!this.audioContext||!this.bleepGain||!this.bleepOscillator)return;const e=this.audioContext.currentTime;this.bleepGain.gain.setValueAtTime(this.bleepGain.gain.value,e),this.bleepGain.gain.linearRampToValueAtTime(0,e+this.BLEEP_RELEASE);const t=this.bleepOscillator,i=t._secondOscillator,s=t._mixer;setTimeout(()=>{try{t.stop(),t.disconnect(),i&&(i.stop(),i.disconnect()),s&&s.disconnect()}catch(e){}},1e3*this.BLEEP_RELEASE+10),this.bleepOscillator=null}updateIntervals(e){this.muteIntervals=e,this.muteIntervals.sort((e,t)=>e.start-t.start)}updateMode(e){this.filterMode=e,"bleep"===e&&this.audioContext&&!this.bleepGain&&(this.bleepGain=this.audioContext.createGain(),this.bleepGain.gain.value=0,this.bleepGain.connect(this.audioContext.destination))}getState(){return{isActive:this.isActive,isMuted:this.isMuted,intervalCount:this.muteIntervals.length,filterMode:this.filterMode}}isFiltering(){return this.isActive}getIntervals(){return[...this.muteIntervals]}}const a=new Map([{word:"jesus",severity:"religious"},{word:"jesus christ",severity:"religious"},{word:"jesus fucking christ",severity:"religious"},{word:"christ",severity:"religious"},{word:"christ almighty",severity:"religious"},{word:"god",severity:"religious"},{word:"oh my god",severity:"religious"},{word:"omg",severity:"religious"},{word:"oh god",severity:"religious"},{word:"my god",severity:"religious"},{word:"for gods sake",severity:"religious"},{word:"for god's sake",severity:"religious"},{word:"god almighty",severity:"religious"},{word:"swear to god",severity:"religious"},{word:"i swear to god",severity:"religious"},{word:"goddamn",severity:"religious"},{word:"goddamned",severity:"religious"},{word:"goddamnit",severity:"religious"},{word:"goddammit",severity:"religious"},{word:"goddamit",severity:"religious"},{word:"goddam",severity:"religious"},{word:"goddams",severity:"religious"},{word:"god damn",severity:"religious"},{word:"god damned",severity:"religious"},{word:"god damnit",severity:"religious"},{word:"god dammit",severity:"religious"},{word:"god damn it",severity:"religious"},{word:"god-damn",severity:"religious"},{word:"god-damned",severity:"religious"},{word:"god-damnit",severity:"religious"},{word:"god-dammit",severity:"religious"},{word:"godd*mn",severity:"religious"},{word:"g*ddamn",severity:"religious"},{word:"gd",severity:"religious"},{word:"gdamn",severity:"religious"},{word:"gotdamn",severity:"religious"},{word:"gotdam",severity:"religious"},{word:"got damn",severity:"religious"},{word:"got dam",severity:"religious"},{word:"gahdamn",severity:"religious"},{word:"gawddamn",severity:"religious"},{word:"gahdam",severity:"religious"},{word:"lord",severity:"religious"},{word:"oh lord",severity:"religious"},{word:"dear lord",severity:"religious"},{word:"good lord",severity:"religious"},{word:"lord almighty",severity:"religious"},{word:"lord have mercy",severity:"religious"},{word:"lordy",severity:"religious"},{word:"lawdy",severity:"religious"},{word:"lawd",severity:"religious"},{word:"oh lawd",severity:"religious"},{word:"holy",severity:"religious"},{word:"holy shit",severity:"religious"},{word:"holy crap",severity:"religious"},{word:"holy hell",severity:"religious"},{word:"holy fuck",severity:"religious"},{word:"holy cow",severity:"religious"},{word:"holy smokes",severity:"religious"},{word:"holy moly",severity:"religious"},{word:"holy mother",severity:"religious"},{word:"holy mother of god",severity:"religious"},{word:"for christ's sake",severity:"religious"},{word:"for christs sake",severity:"religious"},{word:"chrissake",severity:"religious"},{word:"crissake",severity:"religious"},{word:"fuck",severity:"severe"},{word:"fucking",severity:"severe"},{word:"fucked",severity:"severe"},{word:"fucker",severity:"severe"},{word:"fuckers",severity:"severe"},{word:"fucks",severity:"severe"},{word:"motherfucker",severity:"severe"},{word:"motherfucking",severity:"severe"},{word:"motherfuckers",severity:"severe"},{word:"cunt",severity:"severe"},{word:"cunts",severity:"severe"},{word:"nigger",severity:"severe"},{word:"niggers",severity:"severe"},{word:"nigga",severity:"severe"},{word:"niggas",severity:"severe"},{word:"faggot",severity:"severe"},{word:"faggots",severity:"severe"},{word:"fag",severity:"severe"},{word:"fags",severity:"severe"},{word:"retard",severity:"severe"},{word:"retarded",severity:"severe"},{word:"retards",severity:"severe"},{word:"shit",severity:"moderate"},{word:"shits",severity:"moderate"},{word:"shitty",severity:"moderate"},{word:"bullshit",severity:"moderate"},{word:"horseshit",severity:"moderate"},{word:"shithead",severity:"moderate"},{word:"shitheads",severity:"moderate"},{word:"ass",severity:"moderate"},{word:"asses",severity:"moderate"},{word:"asshole",severity:"moderate"},{word:"assholes",severity:"moderate"},{word:"bastard",severity:"moderate"},{word:"bastards",severity:"moderate"},{word:"bitch",severity:"moderate"},{word:"bitches",severity:"moderate"},{word:"bitchy",severity:"moderate"},{word:"cock",severity:"moderate"},{word:"cocks",severity:"moderate"},{word:"cocksucker",severity:"moderate"},{word:"cocksuckers",severity:"moderate"},{word:"dick",severity:"moderate"},{word:"dicks",severity:"moderate"},{word:"dickhead",severity:"moderate"},{word:"dickheads",severity:"moderate"},{word:"pussy",severity:"moderate"},{word:"pussies",severity:"moderate"},{word:"prick",severity:"moderate"},{word:"pricks",severity:"moderate"},{word:"slut",severity:"moderate"},{word:"sluts",severity:"moderate"},{word:"slutty",severity:"moderate"},{word:"whore",severity:"moderate"},{word:"whores",severity:"moderate"},{word:"twat",severity:"moderate"},{word:"twats",severity:"moderate"},{word:"wanker",severity:"moderate"},{word:"wankers",severity:"moderate"},{word:"bollocks",severity:"moderate"},{word:"damn",severity:"mild"},{word:"damned",severity:"mild"},{word:"dammit",severity:"mild"},{word:"damnit",severity:"mild"},{word:"hell",severity:"mild"},{word:"crap",severity:"mild"},{word:"crappy",severity:"mild"},{word:"piss",severity:"mild"},{word:"pissed",severity:"mild"},{word:"pissing",severity:"mild"},{word:"suck",severity:"mild"},{word:"sucks",severity:"mild"},{word:"sucked",severity:"mild"},{word:"balls",severity:"mild"},{word:"butt",severity:"mild"},{word:"butthole",severity:"mild"},{word:"screw",severity:"mild"},{word:"screwed",severity:"mild"},{word:"douche",severity:"mild"},{word:"douchebag",severity:"mild"},{word:"douchebags",severity:"mild"}].map(e=>[e.word.toLowerCase(),e.severity])),l=new Set(["class","classes","classic","classical","classics","classify","classified","classification","classmate","classmates","classroom","classrooms","classy","grass","grassy","grassland","grasshopper","pass","passed","passes","passing","passable","passage","passages","passenger","passengers","passport","passports","password","passwords","bypass","bypassed","bypasses","bypassing","compass","compasses","bass","bassist","bassline","mass","masses","massive","massively","massacre","brass","brassy","glass","glasses","glassy","glassware","sass","sassy","sassafras","lass","lassie","lasso","cassette","cassettes","casserole","assassin","assassins","assassinate","assassination","embassy","embassies","ambassador","ambassadors","harass","harassed","harassing","harassment","amass","amassed","amassing","morass","trespass","trespassed","trespassing","trespasser","carcass","carcasses","canvas","canvases","canvass","canvassed","molasses","assume","assumed","assumes","assuming","assumption","assumptions","assure","assured","assures","assuring","assurance","assess","assessed","assesses","assessing","assessment","assessments","asset","assets","assign","assigned","assigns","assigning","assignment","assignments","assist","assisted","assists","assisting","assistant","assistants","assistance","associate","associated","associates","associating","association","associations","assort","assorted","assortment","hello","hellos","shell","shells","shelled","shelling","shellfish","bombshell","nutshell","eggshell","seashell","clamshell","dwell","dwells","dwelled","dwelling","dwellings","swell","swells","swelled","swelling","swollen","well","wells","wellness","farewell","stairwell","spell","spells","spelled","spelling","misspell","misspelled","smell","smells","smelled","smelling","smelly","bell","bells","doorbell","bellhop","bluebell","dumbbell","barbell","cell","cells","cellular","cellar","cellars","fell","fella","fellas","fellow","fellows","fellowship","jell","jelly","jellyfish","tell","tells","telling","teller","storytelling","foretell","sell","sells","selling","seller","sellers","bestseller","bestselling","yell","yells","yelled","yelling","propel","propelled","propeller","propelling","excel","excels","excelled","excelling","excellent","excellence","expel","expels","expelled","expelling","compel","compels","compelled","compelling","repel","repels","repelled","repelling","repellent","rebellion","rebellious","rebel","rebels","rebelled","hellenic","hellenistic","amsterdam","macadam","madame","madam","peacock","peacocks","cockpit","cockpits","cocktail","cocktails","cockatoo","cockatoos","cockerel","hancock","hitchcock","babcock","woodcock","stopcock","weathercock","dickens","benedict","benediction","predict","predicts","predicted","predicting","prediction","predictions","addict","addicts","addicted","addicting","addiction","addictions","addictive","verdict","verdicts","indict","indicts","indicted","indicting","indictment","contradict","contradicts","contradicted","contradicting","contradiction","dictionary","dictionaries","diction","dictate","dictates","dictated","dictating","dictation","dictator","edict","edicts","jurisdiction","scrap","scraps","scrapped","scrapping","scrappy","scrapbook","scrapyard","mississippi","title","titles","titled","titling","subtitle","subtitles","subtitled","entitle","entitled","entitles","entitling","entitlement","constitution","constitutional","constitutions","institution","institutional","institutions","restitution","stitute","substitute","substitutes","substituted","substitution","institute","institutes","instituted","institution","prostitute","prostitutes","prostitution","titan","titans","titanic","appetite","appetites","appetizer","appetizers","competition","competitions","competitive","competitor","competitors","petition","petitions","petitioned","petitioning","repetition","repetitions","repetitive","partition","partitions","partitioned","quantity","quantities","quantitative","identity","identities","entity","entities","utility","utilities","fertility","infertility","document","documents","documented","documenting","documentation","documentary","circumstance","circumstances","circumstantial","circumference","accumulate","accumulated","accumulates","accumulating","accumulation","cucumber","cucumbers","incumbent","succumb","succumbed","succumbing","faggot","sextant","sextet","sextuple","shoe","shoes","shoed","shoeing","horseshoe","hoe","hoes","hoeing","whole","wholesome","wholesale","wholly","honest","honestly","honesty","dishonest","honor","honors","honored","honoring","honorable","honorary","dishonor","hope","hopes","hoped","hoping","hopeful","hopefully","hopeless","home","homes","homed","homing","homeless","homemade","hometown","homework","horse","horses","horseback","horsepower","hotel","hotels","horizon","horizons","horizontal","hour","hours","hourly","house","houses","housed","housing","household","housewife","housekeeper","night","nights","nightly","nighttime","nightmare","nightmares","nightclub","tonight","overnight","midnight","goodnight","fortnight","knight","knights","knighthood","ignite","ignites","ignited","igniting","ignition","insignificant","significance","significant","significantly","nude","nudes","nudity","analog","analogue","analogous","analogy","analogies","analysis","analyses","analyst","analysts","analytical","analyze","analyzed","banal","canal","canals","final","finals","finally","finalist","finalize","finalized","journal","journals","journalism","journalist","journalists","national","nationally","international","internationally","personal","personally","personality","personalities","professional","professionally","professionals","regional","regionally","original","originally","originals","criminal","criminally","criminals","terminal","terminals","cardinal","cardinals","signal","signals","signaled","signaling","minute","minutes","minutely","peanut","peanuts","coconut","coconuts","chestnut","chestnuts","walnut","walnuts","doughnut","doughnuts","donut","donuts","nutmeg","nutrition","nutritious","nutritional","nutrient","nutrients","godfather","godfathers","godmother","godmothers","godchild","godchildren","godson","godsons","goddaughter","goddaughters","godly","godliness","ungodly","goddess","goddesses","godspeed","godsend","landlord","landlords","landlady","warlord","warlords","overlord","overlords","lordship","holiday","holidays","wholly","christen","christened","christening","christian","christians","christianity","christmas","christmastime","christopher","hellfire","hellbound"]),d={0:"o",1:"i",3:"e",4:"a",5:"s",7:"t",8:"b","@":"a",$:"s","!":"i","*":"","#":"","+":"t","(":"c","<":"c","|":"i",ph:"f",ck:"k"},c=[["ph","f"],["ck","k"],["kk","ck"],["cc","ck"],["xx","x"]];function h(e){return l.has(e.toLowerCase())}function u(e){const t=e.toLowerCase().trim();if(l.has(t))return[];const i=[],s=function(e){let t=e.toLowerCase();for(const[e,i]of c)t=t.split(e).join(i);let i="";for(const e of t)i+=d[e]??e;return i=i.replace(/(.)\1{2,}/g,"$1$1"),i}(t),n=[t];s!==t&&n.push(s);for(const e of n)for(const[t,s]of a){let n=e.indexOf(t);for(;-1!==n;){const r=e===t,o=!(0!==n&&/[a-z]/.test(e[n-1])||n+t.length!==e.length&&/[a-z]/.test(e[n+t.length]));(r||o)&&i.push({word:t,severity:s,startIndex:n,endIndex:n+t.length}),n=e.indexOf(t,n+1)}}i.sort((e,t)=>e.startIndex-t.startIndex);const r=[];for(const e of i){const t=r[r.length-1];!t||e.startIndex>=t.endIndex?r.push(e):e.endIndex-e.startIndex>t.endIndex-t.startIndex&&(r[r.length-1]=e)}const o=new Set;return r.filter(e=>{const t=`${e.word}-${e.startIndex}`;return!o.has(t)&&(o.add(t),!0)})}class p{constructor(e){this.preferences=e,this.customBlacklistMap=new Map(e.customBlacklist.map(e=>[e.toLowerCase(),"severe"])),this.customWhitelistSet=new Set(e.customWhitelist.map(e=>e.toLowerCase()))}shouldFilterSeverity(e){return this.preferences.severityLevels[e]}shouldFilterWord(e,t){const i=e.toLowerCase();return!this.customWhitelistSet.has(i)&&(!!this.customBlacklistMap.has(i)||this.shouldFilterSeverity(t))}getWordSeverity(e){const t=e.toLowerCase();return this.customBlacklistMap.has(t)?this.customBlacklistMap.get(t):h(t)?null:a.get(t)||null}getCharacterLevelTiming(e,t,i){let s=e.start_time,n=e.end_time;if(e.characters&&e.characters.length>0){const r=e.characters[t],o=e.characters[Math.min(i-1,e.characters.length-1)];r&&(s=r.start),o&&(n=o.end),console.log(`[SafePlay Parser] Character timing: "${e.text.substring(t,i)}" chars[${t}..${i-1}] -> ${s.toFixed(3)}s - ${n.toFixed(3)}s`)}return{startTime:s,endTime:n}}findProfanityMatches(e){const t=[];for(let i=0;i<e.length;i++){const s=e[i],n=s.text.toLowerCase().trim(),r=this.getWordSeverity(n);if(r&&this.shouldFilterWord(n,r)){const{startTime:e,endTime:n}=this.getCharacterLevelTiming(s,0,s.text.length);t.push({segmentIndex:i,word:s.text,severity:r,startTime:e,endTime:n,isPartialMatch:!1});continue}const o=u(n);for(const[e]of this.customBlacklistMap){const t=n.indexOf(e);-1!==t&&o.push({word:e,severity:"severe",startIndex:t,endIndex:t+e.length})}for(const e of o){if(!this.shouldFilterWord(e.word,e.severity))continue;const{startTime:n,endTime:r}=this.getCharacterLevelTiming(s,e.startIndex,e.endIndex);t.push({segmentIndex:i,word:e.word,severity:e.severity,startTime:n,endTime:r,isPartialMatch:!0,matchedPortion:s.text.substring(e.startIndex,e.endIndex)})}}return t}createMuteIntervals(e){const t=(this.preferences.paddingBeforeMs??this.preferences.paddingMs)/1e3,i=(this.preferences.paddingAfterMs??this.preferences.paddingMs)/1e3;return e.map(e=>{const s={start:Math.max(0,e.startTime-t),end:e.endTime+i,word:e.word,severity:e.severity};return console.log(`[SafePlay Parser] Mute interval: "${e.word}" ${s.start.toFixed(3)}s - ${s.end.toFixed(3)}s (padding: -${1e3*t}ms / +${1e3*i}ms)`),s})}mergeIntervals(e){if(0===e.length)return[];const t=[...e].sort((e,t)=>e.start-t.start),i=this.preferences.mergeThresholdMs/1e3,s=[t[0]];for(let e=1;e<t.length;e++){const n=t[e],r=s[s.length-1];n.start<=r.end+i?(r.end=Math.max(r.end,n.end),this.severityRank(n.severity)>this.severityRank(r.severity)&&(r.severity=n.severity),r.word.includes(n.word)||(r.word=`${r.word}, ${n.word}`)):s.push({...n})}return s}severityRank(e){return{mild:1,religious:2,moderate:3,severe:4}[e]}parse(e){const t=this.findProfanityMatches(e.segments),i=this.createMuteIntervals(t);return this.mergeIntervals(i)}}function g(e,t){return new p(t).parse(e)}class y{constructor(e={}){this.youtubeId=null,this.video=null,this.transcript=null,this.muteIntervals=[],this.preferences=null,this.status="idle",this.progress=0,this.statusOverlay=null,this.options=e,this.audioFilter=new o({onMuteStart:e=>this.onMuteStart(e),onMuteEnd:()=>this.onMuteEnd()})}async initialize(e,t){this.youtubeId=e,this.preferences=t,this.updateStatus("idle"),this.video=this.findVideoElement(),this.video||(this.log("Video element not found, waiting..."),await this.waitForVideo()),this.video?this.log("Video controller initialized for:",e):this.updateStatus("error",0,"Could not find video element")}async applyFilter(){if(this.youtubeId&&this.video&&this.preferences)if(this.preferences.enabled)try{if(this.updateStatus("loading"),!function(){try{return!!chrome.runtime?.id}catch{return!1}}())return void this.updateStatus("error",0,"Extension reloaded. Please refresh the page.");const e=await chrome.runtime.sendMessage({type:"GET_FILTER",payload:{youtubeId:this.youtubeId}});if(!e)return void this.updateStatus("error",0,"Extension reloaded. Please refresh the page.");if(!e.success)throw new Error(e.error||"Failed to get transcript");if("processing"===e.data.status)return void this.updateStatus("processing",e.data.progress||0);this.transcript=e.data.transcript,await this.processTranscript()}catch(e){const t=e instanceof Error?e.message:"Unknown error";this.updateStatus("error",0,t),this.log("Filter error:",e)}else this.updateStatus("disabled");else this.log("Cannot apply filter: missing required data")}async processTranscript(){if(this.transcript&&this.preferences&&this.video){if(this.muteIntervals=g(this.transcript,this.preferences),this.log("Found",this.muteIntervals.length,"mute intervals"),0===this.muteIntervals.length)return this.updateStatus("active"),void this.log("No profanity detected in video");this.audioFilter.initialize(this.video,this.muteIntervals,this.preferences.filterMode),this.audioFilter.start(),this.updateStatus("active"),this.showStatusOverlay()}}onTranscriptReceived(e){this.transcript=e,this.processTranscript()}onProcessingProgress(e){this.updateStatus("processing",e)}onProcessingError(e){this.updateStatus("error",0,e)}stop(){this.audioFilter.stop(),this.hideStatusOverlay(),this.updateStatus("idle")}resume(){this.video&&0!==this.muteIntervals.length&&(this.audioFilter.start(),this.updateStatus("active"),this.showStatusOverlay())}updatePreferences(e){this.preferences=e,e.enabled?this.transcript&&(this.muteIntervals=g(this.transcript,e),this.audioFilter.updateIntervals(this.muteIntervals),this.audioFilter.updateMode(e.filterMode)):this.stop()}getState(){const e=this.audioFilter.getState();return{status:this.status,progress:this.progress,error:this.error,intervalCount:e.intervalCount,currentlyMuting:e.isMuted}}getMuteIntervals(){return this.muteIntervals}findVideoElement(){const e=["video.html5-main-video","video.video-stream","#movie_player video","ytd-player video","video"];for(const t of e){const e=document.querySelector(t);if(e&&e.src)return e}return null}waitForVideo(e=1e4){return new Promise(t=>{const i=Date.now(),s=()=>{this.video=this.findVideoElement(),this.video?t(this.video):Date.now()-i>e?t(null):requestAnimationFrame(s)};s()})}updateStatus(e,t=0,i){this.status=e,this.progress=t,this.error=i,this.options.onStateChange&&this.options.onStateChange(this.getState())}showStatusOverlay(){if(this.statusOverlay)return;const e=document.querySelector("#movie_player");e&&(this.statusOverlay=document.createElement("div"),this.statusOverlay.className="safeplay-status-overlay",this.statusOverlay.innerHTML='\n      <div class="safeplay-status-badge">\n        <svg class="safeplay-status-icon" viewBox="0 0 24 24" fill="currentColor">\n          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>\n        </svg>\n        <span>SafePlay Active</span>\n      </div>\n    ',e.appendChild(this.statusOverlay),setTimeout(()=>{this.statusOverlay?.classList.add("safeplay-status-hidden")},3e3))}hideStatusOverlay(){this.statusOverlay&&(this.statusOverlay.remove(),this.statusOverlay=null)}onMuteStart(e){this.log("Muting:",e.word),this.notifyStateChange()}onMuteEnd(){this.notifyStateChange()}notifyStateChange(){this.options.onStateChange&&this.options.onStateChange(this.getState())}log(...e){this.options.debug&&console.log("[SafePlay Controller]",...e)}}class v{constructor(e,t="Analyzing"){this.displayProgress=0,this.targetProgress=0,this.isComplete=!1,this.animationId=null,this.ANIMATION_INTERVAL=100,this.CATCH_UP_SPEED=.15,this.MIN_INCREMENT=.2,this.MAX_INCREMENT=3,this.callback=e,this.baseText=t}start(){this.displayProgress=0,this.targetProgress=0,this.isComplete=!1,this.startAnimation(),this.callback(0,`${this.baseText} 0%`)}setTarget(e){this.targetProgress=Math.max(e,this.targetProgress)}complete(){this.isComplete=!0,this.targetProgress=100}stop(){null!==this.animationId&&(clearInterval(this.animationId),this.animationId=null)}getProgress(){return this.displayProgress}startAnimation(){null===this.animationId&&(this.animationId=window.setInterval(()=>{this.tick()},this.ANIMATION_INTERVAL))}tick(){const e=this.targetProgress-this.displayProgress;if(e>.5){let t=e*this.CATCH_UP_SPEED;t=Math.max(t,this.MIN_INCREMENT),t=Math.min(t,this.MAX_INCREMENT),this.displayProgress=Math.min(this.displayProgress+t,this.targetProgress);const i=Math.round(this.displayProgress);this.callback(i,`${this.baseText} ${i}%`)}this.isComplete&&this.displayProgress>=99.5&&(this.displayProgress=100,this.callback(100,`${this.baseText} 100%`),this.stop())}}function f(...e){console.log("[SafePlay:Captions]",...e)}const m="(?=\\s|[.,!?;:'\"\\)\\-]|$)",b=[{pattern:new RegExp(`\\bf+[\\*\\#\\-\\_]+(?:ck(?:ing|ed|er|ers|s)?)?${m}`,"gi"),severity:"severe"},{pattern:new RegExp(`\\bf+u+[\\*\\#\\-\\_]+k*(?:ing|ed|er|ers|s)?${m}`,"gi"),severity:"severe"},{pattern:new RegExp(`\\bf[\\*\\#\\-\\_]{2,}(?:ing|ed|er|ers|s)?${m}`,"gi"),severity:"severe"},{pattern:new RegExp(`\\bs+h+[\\*\\#\\-\\_]+t*(?:ty|s|head|heads)?${m}`,"gi"),severity:"moderate"},{pattern:new RegExp(`\\bs[\\*\\#\\-\\_]{2,}t?${m}`,"gi"),severity:"moderate"},{pattern:new RegExp(`\\bb+[\\*\\#\\-\\_]+(?:tch(?:es|y)?)?${m}`,"gi"),severity:"moderate"},{pattern:new RegExp(`\\bb[\\*\\#\\-\\_]{2,}(?:es|y)?${m}`,"gi"),severity:"moderate"},{pattern:new RegExp(`\\ba+[\\*\\#\\-\\_]+(?:ss(?:hole|holes)?)?${m}`,"gi"),severity:"moderate"},{pattern:new RegExp(`\\ba[\\*\\#\\-\\_]{1,}(?:hole|holes)?${m}`,"gi"),severity:"moderate"},{pattern:new RegExp(`\\bc+[\\*\\#\\-\\_]+(?:nt|nts)?${m}`,"gi"),severity:"severe"},{pattern:new RegExp(`\\bd+[\\*\\#\\-\\_]+(?:ck|cks|ckhead)?${m}`,"gi"),severity:"moderate"},{pattern:new RegExp(`\\bp+[\\*\\#\\-\\_]+(?:ssy|ss(?:ies|y)?)?${m}`,"gi"),severity:"moderate"},{pattern:new RegExp(`\\bn+[\\*\\#\\-\\_]+(?:gg|gga|gger|ggers|ggas)?${m}`,"gi"),severity:"severe"},{pattern:new RegExp(`\\b\\w+[\\*\\#]+\\w*${m}`,"gi"),severity:"moderate"}];class w{constructor(e={}){this.observer=null,this.preferences=null,this.isActive=!1,this.censoredWordCount=0,this.lastProcessedTexts=new Map}initialize(e,t){this.preferences=e,f("Caption filter initialized")}start(){this.isActive?f("Caption filter already active"):(f("Starting caption filter - hijacking YouTube captions"),this.isActive=!0,this.censoredWordCount=0,this.lastProcessedTexts.clear(),this.setupCaptionObserver())}stop(){this.isActive&&(f("Stopping caption filter. Censored",this.censoredWordCount,"words total."),this.isActive=!1,this.observer&&(this.observer.disconnect(),this.observer=null),this.lastProcessedTexts.clear())}updatePreferences(e){this.preferences=e}getCensoredCount(){return this.censoredWordCount}setupCaptionObserver(){const e=[".ytp-caption-window-container",".caption-window","#movie_player .ytp-caption-window-bottom","#movie_player"];let t=null;for(const i of e)if(t=document.querySelector(i),t)break;if(!t)return f("Caption container not found, retrying in 500ms"),void setTimeout(()=>{this.isActive&&this.setupCaptionObserver()},500);f("Found caption container, setting up observer"),this.observer=new MutationObserver(e=>{if(this.isActive)for(const t of e)if("childList"===t.type&&t.addedNodes.forEach(e=>{this.processCaptionNode(e)}),"characterData"===t.type){const e=t.target;e.nodeType===Node.TEXT_NODE&&this.filterTextNode(e)}}),this.observer.observe(t,{childList:!0,subtree:!0,characterData:!0}),this.scanForCaptions(t),f("Caption observer active on container")}scanForCaptions(e){e.querySelectorAll(".ytp-caption-segment").forEach(e=>{this.filterCaptionElement(e)})}processCaptionNode(e){if(this.isActive)if(e.nodeType!==Node.TEXT_NODE){if(e.nodeType===Node.ELEMENT_NODE){const t=e;this.isCaptionElement(t)&&this.filterCaptionElement(t),t.querySelectorAll(".ytp-caption-segment").forEach(e=>{this.filterCaptionElement(e)})}}else this.filterTextNode(e)}isCaptionElement(e){if(!e)return!1;const t="string"==typeof e.className?e.className:e.className?.baseVal||"";return!!(t.includes("ytp-caption-segment")||t.includes("captions-text")||t.includes("caption-visual-line")||e.closest(".ytp-caption-window-container")||e.closest(".caption-window"))}filterCaptionElement(e){if(!this.preferences)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null),i=[];let s;for(;s=t.nextNode();)i.push(s);i.forEach(e=>{this.filterTextNode(e)})}filterTextNode(e){if(!this.preferences)return;const t=e.textContent||"";if(!t.trim())return;if(this.lastProcessedTexts.get(e)===t)return;const i=this.censorText(t);i!==t?(e.textContent=i,this.lastProcessedTexts.set(e,i),f("Censored:",t,"->",i)):this.lastProcessedTexts.set(e,t)}censorText(e){if(!this.preferences)return e;let t=e,i=!1;t=this.replaceCensoredPatterns(t),t!==e&&(i=!0);const s=t.split(/(\s+)/);let n="";for(const e of s){if(!e||/^\s+$/.test(e)){n+=e;continue}if("(bleep)"===e){n+=e;continue}if(h(e)){n+=e;continue}const t=u(e);if(t.length>0){const e=t.filter(e=>{const t=e.severity;return this.preferences.severityLevels[t]});if(e.length>0){n+="(bleep)",this.censoredWordCount+=e.length,i=!0;continue}}const s=e.toLowerCase().replace(/[.,!?;:'"()-]/g,"");this.preferences.customBlacklist.some(e=>s===e.toLowerCase())?(n+="(bleep)",this.censoredWordCount++,i=!0):n+=e}return i?n:e}replaceCensoredPatterns(e){if(!this.preferences)return e;let t=e;for(const{pattern:e,severity:i}of b)if(this.preferences.severityLevels[i]&&(e.lastIndex=0,e.test(t))){e.lastIndex=0;const i=t.match(e);i&&(this.censoredWordCount+=i.length),t=t.replace(e,"(bleep)")}return t}}function x(...e){}class S{constructor(e){this.muteIntervals=[],this.video=null,this.overlayContainer=null,this.resizeObserver=null,this.progressBarElement=null,this.isInitialized=!1,this.retryCount=0,this.maxRetries=20,this.retryDelay=500}initialize(e,t){this.video=e,this.muteIntervals=t,t.length,this.injectOverlayWithRetry(),this.setupEventListeners()}injectOverlayWithRetry(){const e=this.findProgressBar();e?(this.progressBarElement=e,this.createOverlay(),this.isInitialized=!0):this.retryCount<this.maxRetries?(this.retryCount++,setTimeout(()=>this.injectOverlayWithRetry(),this.retryDelay)):this.maxRetries}findProgressBar(){const e=document.querySelector(".ytp-timed-markers-container");if(e?.parentElement)return e.parentElement.className,e.parentElement;const t=[".ytp-progress-bar-container",".ytp-chapter-hover-container",".ytp-progress-bar","#movie_player .ytp-progress-bar-container"];for(const e of t){const t=document.querySelector(e);if(t)return x(),t}return null}createOverlay(){if(!this.progressBarElement)return;this.removeOverlay(),this.overlayContainer=document.createElement("div"),this.overlayContainer.className="safeplay-timeline-overlay",this.overlayContainer.style.cssText="\n      position: absolute;\n      left: 0;\n      right: 0;\n      top: 0;\n      bottom: 0;\n      height: 100%;\n      width: 100%;\n      pointer-events: none;\n      z-index: 77;\n    ",this.progressBarElement.style.position="relative",this.progressBarElement.appendChild(this.overlayContainer);const e=document.querySelector(".ytp-timed-markers-container");e&&(e.style.pointerEvents="none"),this.renderMarkers(),this.setupResizeObserver()}renderMarkers(){if(!this.overlayContainer||!this.video)return;const e=this.video.duration;if(e&&isFinite(e)){this.overlayContainer.innerHTML="",this.muteIntervals.length;for(const t of this.muteIntervals){const i=this.createMarker(t,e);i&&this.overlayContainer.appendChild(i)}}else this.video.addEventListener("loadedmetadata",()=>this.renderMarkers(),{once:!0})}createMarker(e,t){if(e.start>=t)return null;const i=document.createElement("div");i.className="safeplay-timeline-marker";const s=e.start/t*100,n=(Math.min(e.end,t)-e.start)/t*100,r=Math.max(n,.8),o=n<.8?Math.max(0,s-(.8-n)/2):s;return i.style.cssText=`\n      position: absolute;\n      left: ${o}%;\n      width: ${r}%;\n      height: 6px;\n      bottom: 0;\n      background-color: #FFFFFF;\n      opacity: 0.9;\n      border-radius: 2px;\n      pointer-events: auto;\n      cursor: pointer;\n      z-index: 78;\n      box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);\n      transition: opacity 0.2s ease, transform 0.2s ease;\n    `,i.title=`${this.formatTimestamp(e.start)} - "${e.word}"`,i.addEventListener("mouseenter",()=>{i.style.opacity="1",i.style.transform="scaleY(1.5)",i.style.zIndex="99",i.style.boxShadow="0 0 8px 2px rgba(255, 255, 255, 0.8)"}),i.addEventListener("mouseleave",()=>{i.style.opacity="0.9",i.style.transform="scaleY(1)",i.style.zIndex="78",i.style.boxShadow="0 0 2px rgba(0, 0, 0, 0.5)"}),i.addEventListener("click",t=>{e.word,t.stopPropagation(),t.preventDefault(),this.video&&(this.video.currentTime=Math.max(0,e.start-2),e.start,e.word)}),i}formatTimestamp(e){return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}setupEventListeners(){this.video&&(this.video.addEventListener("durationchange",()=>{this.video,this.isInitialized&&this.renderMarkers()}),this.video.addEventListener("loadedmetadata",()=>{this.video,this.isInitialized&&this.renderMarkers()}))}setupResizeObserver(){this.progressBarElement&&(this.resizeObserver=new ResizeObserver(()=>{}),this.resizeObserver.observe(this.progressBarElement))}update(e){this.muteIntervals=e,this.isInitialized&&this.renderMarkers()}show(){this.overlayContainer&&(this.overlayContainer.style.display="block")}hide(){this.overlayContainer&&(this.overlayContainer.style.display="none")}removeOverlay(){this.overlayContainer&&(this.overlayContainer.remove(),this.overlayContainer=null)}destroy(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.removeOverlay(),this.video=null,this.progressBarElement=null,this.muteIntervals=[],this.isInitialized=!1,this.retryCount=0}}function C(e,...t){e&&console.log("[SafePlay CreditConfirm]",...t)}function E(e){const t=Math.floor(e/60),i=e%60;return 0===t?`${i}s`:0===i?`${t}m`:`${t}m ${i}s`}class I{constructor(e){this.options=e,this.dialog=null,this.debug=e.debug||!1}show(e){C(this.debug,"Showing credit confirmation dialog:",e),this.hide(),this.dialog=document.createElement("div"),this.dialog.className="safeplay-credit-dialog-overlay",this.dialog.innerHTML=this.createDialogHTML(e),this.injectStyles(),document.body.appendChild(this.dialog),this.setupListeners(e);const t=this.dialog.querySelector(".safeplay-credit-dialog");t&&t.focus()}hide(){this.dialog&&(this.dialog.remove(),this.dialog=null)}createDialogHTML(e){const{video:t,creditCost:i,creditCostNote:s,creditCostUnknown:n,userCredits:r,hasSufficientCredits:o,isCached:a}=e,l=n?s||"~1 credit per minute":`${i} credit${1!==i?"s":""}`;return a?'\n        <div class="safeplay-credit-dialog" tabindex="-1" role="dialog" aria-labelledby="safeplay-dialog-title">\n          <div class="safeplay-dialog-header">\n            <div class="safeplay-dialog-icon safeplay-icon-cached">\n              <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">\n                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>\n              </svg>\n            </div>\n            <h2 id="safeplay-dialog-title">Video Ready</h2>\n          </div>\n          <div class="safeplay-dialog-body">\n            <p class="safeplay-dialog-message">\n              This video has already been processed. Filtering is free!\n            </p>\n          </div>\n          <div class="safeplay-dialog-actions">\n            <button class="safeplay-btn safeplay-btn-primary" data-action="confirm">\n              Start Filtering\n            </button>\n          </div>\n        </div>\n      ':o?`\n      <div class="safeplay-credit-dialog" tabindex="-1" role="dialog" aria-labelledby="safeplay-dialog-title">\n        <div class="safeplay-dialog-header">\n          <div class="safeplay-dialog-icon">\n            <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">\n              <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>\n            </svg>\n          </div>\n          <h2 id="safeplay-dialog-title">Confirm Filtering</h2>\n        </div>\n        <div class="safeplay-dialog-body">\n          <div class="safeplay-video-info">\n            <span class="safeplay-video-title">${this.escapeHtml(t.title)}</span>\n            <span class="safeplay-video-duration">${E(t.duration)}</span>\n          </div>\n          <p class="safeplay-dialog-message safeplay-credit-explanation">\n            Filtering this video will use credits from your account.\n          </p>\n          <div class="safeplay-credit-info">\n            <div class="safeplay-credit-row">\n              <span>Your current credits:</span>\n              <span class="safeplay-credit-value">${r}</span>\n            </div>\n            <div class="safeplay-credit-row safeplay-deduct">\n              <span>${n?"Estimated deduction:":"Will be deducted:"}</span>\n              <span class="safeplay-credit-value safeplay-cost">-${i}</span>\n            </div>\n            ${n?'\n            <div class="safeplay-credit-row safeplay-after">\n              <span class="safeplay-cost-note">Exact cost calculated after processing (~1 credit/minute)</span>\n            </div>\n            ':`\n            <div class="safeplay-credit-row safeplay-after">\n              <span>You'll have left:</span>\n              <span class="safeplay-credit-value safeplay-remaining">${r-i}</span>\n            </div>\n            `}\n          </div>\n        </div>\n        <div class="safeplay-dialog-actions">\n          <button class="safeplay-btn safeplay-btn-secondary" data-action="cancel">\n            Cancel\n          </button>\n          <button class="safeplay-btn safeplay-btn-primary" data-action="confirm">\n            Use ${n?"~"+i:i} Credit${1!==i?"s":""} & Filter\n          </button>\n        </div>\n      </div>\n    `:`\n        <div class="safeplay-credit-dialog" tabindex="-1" role="dialog" aria-labelledby="safeplay-dialog-title">\n          <div class="safeplay-dialog-header">\n            <div class="safeplay-dialog-icon safeplay-icon-warning">\n              <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">\n                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>\n              </svg>\n            </div>\n            <h2 id="safeplay-dialog-title">Not Enough Credits</h2>\n          </div>\n          <div class="safeplay-dialog-body">\n            <div class="safeplay-video-info">\n              <span class="safeplay-video-title">${this.escapeHtml(t.title)}</span>\n              <span class="safeplay-video-duration">${E(t.duration)}</span>\n            </div>\n            <p class="safeplay-dialog-message safeplay-credit-explanation">\n              You don't have enough credits to filter this video.\n            </p>\n            <div class="safeplay-credit-info safeplay-insufficient">\n              <div class="safeplay-credit-row">\n                <span>This video requires:</span>\n                <span class="safeplay-credit-value">${l}</span>\n              </div>\n              <div class="safeplay-credit-row">\n                <span>You currently have:</span>\n                <span class="safeplay-credit-value safeplay-low">${r} credit${1!==r?"s":""}</span>\n              </div>\n              ${n?"":`\n              <div class="safeplay-credit-row safeplay-need">\n                <span>You need:</span>\n                <span class="safeplay-credit-value">${i-r} more credit${i-r!==1?"s":""}</span>\n              </div>\n              `}\n            </div>\n          </div>\n          <div class="safeplay-dialog-actions">\n            <button class="safeplay-btn safeplay-btn-secondary" data-action="cancel">\n              Cancel\n            </button>\n            <a href="https://trysafeplay.com/pricing" target="_blank" class="safeplay-btn safeplay-btn-primary">\n              Get More Credits\n            </a>\n          </div>\n        </div>\n      `}setupListeners(e){if(!this.dialog)return;const t=this.dialog.querySelector('[data-action="confirm"]');t&&t.addEventListener("click",()=>{C(this.debug,"Confirm clicked"),this.hide(),this.options.onConfirm()});const i=this.dialog.querySelector('[data-action="cancel"]');i&&i.addEventListener("click",()=>{C(this.debug,"Cancel clicked"),this.hide(),this.options.onCancel()}),this.dialog.addEventListener("click",e=>{e.target===this.dialog&&(C(this.debug,"Clicked outside, canceling"),this.hide(),this.options.onCancel())});const s=e=>{"Escape"===e.key&&(C(this.debug,"Escape pressed, canceling"),this.hide(),this.options.onCancel(),document.removeEventListener("keydown",s))};document.addEventListener("keydown",s)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}injectStyles(){if(document.getElementById("safeplay-credit-dialog-styles"))return;const e=document.createElement("style");e.id="safeplay-credit-dialog-styles",e.textContent="\n      .safeplay-credit-dialog-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0, 0, 0, 0.75);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 999999;\n        font-family: 'Roboto', 'YouTube Sans', -apple-system, BlinkMacSystemFont, sans-serif;\n      }\n\n      .safeplay-credit-dialog {\n        background: #212121;\n        border: 1px solid #3F3F3F;\n        border-radius: 12px;\n        padding: 24px;\n        max-width: 380px;\n        width: 90%;\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n        outline: none;\n        animation: safeplay-dialog-appear 0.2s ease-out;\n      }\n\n      @keyframes safeplay-dialog-appear {\n        from {\n          opacity: 0;\n          transform: scale(0.95);\n        }\n        to {\n          opacity: 1;\n          transform: scale(1);\n        }\n      }\n\n      .safeplay-dialog-header {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        margin-bottom: 20px;\n      }\n\n      .safeplay-dialog-icon {\n        width: 40px;\n        height: 40px;\n        border-radius: 50%;\n        background: #FF0000;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: white;\n        flex-shrink: 0;\n      }\n\n      .safeplay-dialog-icon.safeplay-icon-cached {\n        background: #2BA640;\n      }\n\n      .safeplay-dialog-icon.safeplay-icon-warning {\n        background: #F9A825;\n      }\n\n      .safeplay-dialog-header h2 {\n        margin: 0;\n        font-size: 18px;\n        font-weight: 600;\n        color: #F1F1F1;\n      }\n\n      .safeplay-dialog-body {\n        margin-bottom: 24px;\n      }\n\n      .safeplay-dialog-message {\n        color: #AAAAAA;\n        font-size: 14px;\n        line-height: 1.5;\n        margin: 0;\n      }\n\n      .safeplay-video-info {\n        background: #272727;\n        border-radius: 8px;\n        padding: 12px;\n        margin-bottom: 16px;\n      }\n\n      .safeplay-video-title {\n        display: block;\n        color: #F1F1F1;\n        font-size: 14px;\n        font-weight: 500;\n        margin-bottom: 4px;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }\n\n      .safeplay-video-duration {\n        display: block;\n        color: #606060;\n        font-size: 12px;\n      }\n\n      .safeplay-credit-info {\n        background: #272727;\n        border-radius: 8px;\n        padding: 12px;\n      }\n\n      .safeplay-credit-info.safeplay-insufficient {\n        border: 1px solid #FF4E45;\n      }\n\n      .safeplay-credit-row {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 6px 0;\n        color: #AAAAAA;\n        font-size: 14px;\n      }\n\n      .safeplay-credit-row:not(:last-child) {\n        border-bottom: 1px solid #3F3F3F;\n      }\n\n      .safeplay-credit-value {\n        font-weight: 600;\n        color: #2BA640;\n      }\n\n      .safeplay-credit-value.safeplay-low {\n        color: #FF4E45;\n      }\n\n      .safeplay-credit-row.safeplay-need .safeplay-credit-value {\n        color: #F9A825;\n      }\n\n      .safeplay-credit-explanation {\n        margin: 0 0 12px 0;\n        font-size: 13px;\n        color: #AAAAAA;\n        line-height: 1.4;\n      }\n\n      .safeplay-credit-row.safeplay-deduct {\n        background: rgba(255, 78, 69, 0.1);\n        margin: 0 -12px;\n        padding: 8px 12px;\n      }\n\n      .safeplay-credit-value.safeplay-cost {\n        color: #FF4E45;\n        font-weight: 700;\n      }\n\n      .safeplay-credit-value.safeplay-remaining {\n        color: #2BA640;\n        font-weight: 600;\n      }\n\n      .safeplay-credit-row.safeplay-after {\n        color: #888888;\n        font-size: 13px;\n      }\n\n      .safeplay-cost-note {\n        font-size: 12px;\n        font-style: italic;\n        color: #888888;\n      }\n\n      .safeplay-dialog-actions {\n        display: flex;\n        gap: 12px;\n        justify-content: flex-end;\n      }\n\n      .safeplay-btn {\n        padding: 10px 20px;\n        border-radius: 8px;\n        font-size: 14px;\n        font-weight: 500;\n        cursor: pointer;\n        border: none;\n        transition: all 0.2s;\n        text-decoration: none;\n        display: inline-flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .safeplay-btn-primary {\n        background: #FF0000;\n        color: white;\n      }\n\n      .safeplay-btn-primary:hover {\n        background: #CC0000;\n        transform: translateY(-1px);\n      }\n\n      .safeplay-btn-secondary {\n        background: #272727;\n        border: 1px solid #3F3F3F;\n        color: #F1F1F1;\n      }\n\n      .safeplay-btn-secondary:hover {\n        background: #3F3F3F;\n      }\n    ",document.head.appendChild(e)}}function k(){const e=document.createElement("div");e.style.cssText="\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: rgba(0, 0, 0, 0.75);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 999999;\n    font-family: 'Roboto', 'YouTube Sans', -apple-system, BlinkMacSystemFont, sans-serif;\n  ",e.innerHTML='\n    <div tabindex="-1" role="dialog" style="background: #212121; border: 1px solid #3F3F3F; border-radius: 12px; padding: 24px; max-width: 380px; width: 90%; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); outline: none;">\n      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">\n        <div style="width: 40px; height: 40px; border-radius: 50%; background: #FF4E45; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">\n          <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">\n            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>\n          </svg>\n        </div>\n        <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #F1F1F1;">Having Trouble Filtering</h2>\n      </div>\n      <div style="margin-bottom: 24px;">\n        <p style="color: #AAAAAA; font-size: 14px; line-height: 1.5; margin: 0;">\n          We\'re experiencing some difficulty censoring this video right now. Our team has been notified and is working on it.\n        </p>\n        <p style="color: #888888; font-size: 14px; line-height: 1.5; margin: 12px 0 0 0;">\n          We\'ll notify you when the video is ready to be filtered. You can also try again later by clicking the Retry button.\n        </p>\n      </div>\n      <div style="display: flex; gap: 12px; justify-content: flex-end;">\n        <button data-action="close" style="padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; background: #FF0000; color: white;">\n          Got It\n        </button>\n      </div>\n    </div>\n  ',document.body.appendChild(e);const t=()=>{e.remove()};e.querySelector('[data-action="close"]')?.addEventListener("click",t),e.addEventListener("click",i=>{i.target===e&&t()}),document.addEventListener("keydown",function e(i){"Escape"===i.key&&(t(),document.removeEventListener("keydown",e))})}function F(){const e=document.createElement("div");if(e.className="safeplay-credit-dialog-overlay",e.innerHTML='\n    <div class="safeplay-credit-dialog" tabindex="-1" role="dialog">\n      <div class="safeplay-dialog-header">\n        <div class="safeplay-dialog-icon safeplay-icon-warning">\n          <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">\n            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>\n          </svg>\n        </div>\n        <h2>Sign In to SafePlay</h2>\n      </div>\n      <div class="safeplay-dialog-body">\n        <p class="safeplay-dialog-message">\n          You need to be signed in to filter videos with SafePlay.\n        </p>\n        <div style="background: #272727; border-radius: 8px; padding: 12px; margin-top: 12px;">\n          <p style="color: #F1F1F1; font-size: 14px; margin: 0 0 8px 0; font-weight: 500;">\n            New to SafePlay?\n          </p>\n          <p style="color: #AAAAAA; font-size: 13px; margin: 0; line-height: 1.4;">\n            Create a free account and get 30 credits per month to start filtering profanity from YouTube videos.\n          </p>\n        </div>\n      </div>\n      <div class="safeplay-dialog-actions" style="flex-direction: column; gap: 8px;">\n        <div style="display: flex; gap: 12px; width: 100%; justify-content: flex-end;">\n          <button class="safeplay-btn safeplay-btn-secondary" data-action="cancel">\n            Cancel\n          </button>\n          <a href="https://trysafeplay.com/login" target="_blank" class="safeplay-btn safeplay-btn-primary">\n            Sign In\n          </a>\n        </div>\n        <div style="width: 100%; text-align: center; padding-top: 8px; border-top: 1px solid #3F3F3F;">\n          <span style="color: #888; font-size: 13px;">Don\'t have an account? </span>\n          <a href="https://trysafeplay.com/signup" target="_blank" style="color: #FF0000; font-size: 13px; text-decoration: none; font-weight: 500;">\n            Sign Up Free\n          </a>\n        </div>\n      </div>\n    </div>\n  ',!document.getElementById("safeplay-credit-dialog-styles")){const e=document.createElement("style");e.id="safeplay-credit-dialog-styles",e.textContent="\n      .safeplay-credit-dialog-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0, 0, 0, 0.75);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 999999;\n        font-family: 'Roboto', 'YouTube Sans', -apple-system, BlinkMacSystemFont, sans-serif;\n      }\n      .safeplay-credit-dialog {\n        background: #212121;\n        border: 1px solid #3F3F3F;\n        border-radius: 12px;\n        padding: 24px;\n        max-width: 380px;\n        width: 90%;\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n        outline: none;\n      }\n      .safeplay-dialog-header {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        margin-bottom: 20px;\n      }\n      .safeplay-dialog-icon {\n        width: 40px;\n        height: 40px;\n        border-radius: 50%;\n        background: #FF0000;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: white;\n      }\n      .safeplay-dialog-icon.safeplay-icon-warning {\n        background: #F9A825;\n      }\n      .safeplay-dialog-header h2 {\n        margin: 0;\n        font-size: 18px;\n        font-weight: 600;\n        color: #F1F1F1;\n      }\n      .safeplay-dialog-body {\n        margin-bottom: 24px;\n      }\n      .safeplay-dialog-message {\n        color: #AAAAAA;\n        font-size: 14px;\n        line-height: 1.5;\n        margin: 0;\n      }\n      .safeplay-dialog-actions {\n        display: flex;\n        gap: 12px;\n        justify-content: flex-end;\n      }\n      .safeplay-btn {\n        padding: 10px 20px;\n        border-radius: 8px;\n        font-size: 14px;\n        font-weight: 500;\n        cursor: pointer;\n        border: none;\n        text-decoration: none;\n        display: inline-flex;\n        align-items: center;\n      }\n      .safeplay-btn-primary {\n        background: #FF0000;\n        color: white;\n      }\n      .safeplay-btn-primary:hover {\n        background: #CC0000;\n      }\n      .safeplay-btn-secondary {\n        background: #272727;\n        border: 1px solid #3F3F3F;\n        color: #F1F1F1;\n      }\n      .safeplay-btn-secondary:hover {\n        background: #3F3F3F;\n      }\n    ",document.head.appendChild(e)}document.body.appendChild(e);const t=()=>{e.remove()};e.querySelector('[data-action="cancel"]')?.addEventListener("click",t),e.addEventListener("click",i=>{i.target===e&&t()}),document.addEventListener("keydown",function e(i){"Escape"===i.key&&(t(),document.removeEventListener("keydown",e))})}const A={enabled:!0,filterMode:"mute",severityLevels:{mild:!1,moderate:!0,severe:!0,religious:!1},customBlacklist:[],customWhitelist:[],paddingMs:50,paddingBeforeMs:100,paddingAfterMs:30,mergeThresholdMs:100,autoEnableForFilteredVideos:!0},P="safeplay_filtered_videos";async function T(){try{return(await chrome.storage.local.get(P))[P]||[]}catch(e){return console.error("[SafePlay Storage] Error getting filtered videos:",e),[]}}const M=!0;function V(...e){console.log("[SafePlay]",...e)}function B(){try{return!!chrome.runtime?.id}catch{return!1}}async function L(e){if(!B())return V("Extension context invalidated, skipping message"),null;try{return await chrome.runtime.sendMessage(e)}catch(e){if(String(e).includes("Extension context invalidated"))return V("Extension context invalidated during message"),null;throw e}}class ${constructor(){this.videoController=null,this.preferences=A,this.currentVideoId=null,this.filteringVideoId=null,this.isProcessing=!1,this.videoWasPlaying=!1,this.progressAnimator=null,this.lastIntervalCount=0,this.isFilterActive=!1,this.timelineMarkers=null,this.navigationId=0,this.injector=new n({onButtonClick:e=>this.onFilterButtonClick(e),onToggleFilter:()=>this.toggleFilterFromButton(),debug:M}),this.videoController=new y({onStateChange:e=>this.onVideoStateChange(e),debug:M}),this.captionFilter=new w({debug:M})}async initialize(){V("Initializing SafePlay content script"),await this.loadPreferences(),this.injector.start(),(this.isWatchPage()||this.isShortsPage())&&(this.currentVideoId=this.getVideoIdFromUrl(),this.currentVideoId&&setTimeout(()=>this.checkAutoEnable(),1e3)),this.setupMessageListener(),this.setupNavigationListener(),V("SafePlay initialized")}async loadPreferences(){try{const e=await L({type:"GET_PREFERENCES"});e?.success&&e.data&&(this.preferences=e.data)}catch(e){V("Failed to load preferences:",e)}}isWatchPage(){return"/watch"===window.location.pathname}isShortsPage(){return window.location.pathname.startsWith("/shorts")}getVideoIdFromUrl(){if(this.isWatchPage())return new URLSearchParams(window.location.search).get("v");if(this.isShortsPage()){const e=window.location.pathname.match(/\/shorts\/([a-zA-Z0-9_-]+)/);return e?e[1]:null}return null}updateButtonState(e){this.injector.updateButtonState(e)}getVideoElement(){return document.querySelector("video.html5-main-video")||document.querySelector("video.video-stream")||document.querySelector("#movie_player video")||document.querySelector("video")}resumeVideoIfNeeded(){if(this.videoWasPlaying){const e=this.getVideoElement();e&&(e.play(),V("Video resumed")),this.videoWasPlaying=!1}}async onFilterButtonClick(e){if(this.isProcessing)V("Already processing, ignoring click");else{V("Filter button clicked for:",e);try{const e=await L({type:"CHECK_AUTH_STRICT"});if(!e?.success||!e?.data?.authenticated)return V("User not authenticated, showing sign in modal"),void F()}catch(e){return V("Auth check failed:",e),void F()}this.isProcessing=!0,this.currentVideoId=e,this.filteringVideoId=e;try{this.updateButtonState({state:"connecting",text:"Checking...",videoId:e});const t=await L({type:"GET_PREVIEW",payload:{youtubeId:e}});if(!t)return this.isProcessing=!1,this.filteringVideoId=null,void this.updateButtonState({state:"error",text:"Reload page",error:"Extension reloaded",videoId:e});if(!t.success){if(t.error?.includes("UNAUTHORIZED")||t.error?.includes("401"))return this.isProcessing=!1,this.filteringVideoId=null,this.updateButtonState({state:"idle",text:"SafePlay",videoId:e}),void F();throw new Error(t.error||"Failed to get preview")}if(!t.data)throw new Error("No preview data received");const i=t.data;if(i.isCached&&0===i.creditCost)return V("Video is cached, skipping confirmation"),this.isProcessing=!1,void await this.proceedWithFiltering(e);const s=this.getVideoElement(),n=!(!s||s.paused);s&&n&&(s.pause(),V("Video paused for credit confirmation")),this.updateButtonState({state:"idle",text:"SafePlay",videoId:e}),this.isProcessing=!1,new I({onConfirm:async()=>{V("User confirmed filtering"),this.videoWasPlaying=n,await this.proceedWithFiltering(e)},onCancel:()=>{V("User cancelled filtering"),this.filteringVideoId=null,n&&s&&(s.play(),V("Video resumed after cancel"))},debug:M}).show(i)}catch(t){V("Preview request failed:",t);const i=t instanceof Error?t.message:"Unknown error";this.updateButtonState({state:"error",text:"Retry",error:`${i} - Click to retry`,videoId:e}),this.isProcessing=!1,this.filteringVideoId=null,k()}}}async proceedWithFiltering(e){if(this.isProcessing)return void V("Already processing, ignoring");V("Proceeding with filtering for:",e),this.isProcessing=!0,this.filteringVideoId=e;const t=this.navigationId,i=this.getVideoElement();this.videoWasPlaying||(this.videoWasPlaying=!(!i||i.paused),i&&this.videoWasPlaying&&(i.pause(),V("Video paused while loading filter")));try{this.updateButtonState({state:"connecting",text:"Connecting...",videoId:e});const i=await L({type:"START_FILTER",payload:{youtubeId:e,filterType:this.preferences.filterMode}});if(this.navigationId!==t)return void V(`Filtering aborted for ${e}: user navigated away during START_FILTER`);if(!i)return this.updateButtonState({state:"error",text:"Reload page",error:"Extension reloaded",videoId:e}),void this.resumeVideoIfNeeded();if(!i.success)throw new Error(i.error||"Failed to request filter");if(!i.data)throw new Error("No filter data received");const{status:s,transcript:n,jobId:r,error_code:o,error:a}=i.data;if("failed"===s){if("AGE_RESTRICTED"===o?this.updateButtonState({state:"age-restricted",text:"Age-Restricted",error:a||"This video is age-restricted by YouTube. SafePlay cannot filter age-restricted content.",videoId:e}):"INSUFFICIENT_CREDITS"===o?this.updateButtonState({state:"error",text:"No Credits",error:a||"Insufficient credits. Please purchase more credits at safeplay.app",videoId:e}):(this.updateButtonState({state:"error",text:"Retry",error:(a||"Failed to filter video")+" - Click to retry",videoId:e}),k()),this.videoWasPlaying){const e=this.getVideoElement();e&&(e.play(),V("Video resumed after error")),this.videoWasPlaying=!1}return this.isProcessing=!1,void(this.filteringVideoId=null)}if("cached"!==s&&"completed"!==s||!n){if("processing"!==s||!r)throw new Error("Unexpected API response");V("Job started, polling for completion:",r),await this.pollJobStatus(r)}else{if(V("Using cached transcript"),this.navigationId!==t)return void V(`Filtering aborted for ${e}: user navigated away before applying cached filter`);this.updateButtonState({state:"processing",text:"Processing...",videoId:e}),await this.applyFilter(n)}}catch(t){V("Filter request failed:",t);const i=t instanceof Error?t.message:"Unknown error";if(this.updateButtonState({state:"error",text:"Retry",error:`${i} - Click to retry`,videoId:e}),this.videoWasPlaying){const e=this.getVideoElement();e&&(e.play(),V("Video resumed after error")),this.videoWasPlaying=!1}this.isProcessing=!1,this.filteringVideoId=null,k()}}async pollJobStatus(e){let t=0;const i=this.filteringVideoId,s=this.navigationId;for(this.progressAnimator=new v((e,t)=>{this.updateButtonState({state:"processing",text:t,progress:e,videoId:i||void 0})},"Analyzing"),this.progressAnimator.start();t<180;){if(this.navigationId!==s)return V(`Polling aborted for ${i}: user navigated away`),void(this.progressAnimator&&(this.progressAnimator.stop(),this.progressAnimator=null));try{const n=await L({type:"CHECK_JOB",payload:{jobId:e}});if(this.navigationId!==s)return V(`Polling aborted for ${i}: user navigated away during request`),void(this.progressAnimator&&(this.progressAnimator.stop(),this.progressAnimator=null));if(!n)return this.progressAnimator?.stop(),this.progressAnimator=null,this.updateButtonState({state:"error",text:"Reload page",error:"Extension reloaded",videoId:i||void 0}),void this.resumeVideoIfNeeded();if(!n.success)throw new Error(n.error||"Failed to check job status");if(!n.data)throw new Error("No job status data received");const{status:r,progress:o,transcript:a,error:l,error_code:d}=n.data;switch(V(`Job status: ${r}, progress: ${o}%`),r){case"pending":this.progressAnimator.setTarget(5);break;case"downloading":this.progressAnimator.setTarget(5+.25*o);break;case"transcribing":this.progressAnimator.setTarget(30+.55*o);break;case"completed":if(a)return this.progressAnimator.setTarget(95),await new Promise(e=>setTimeout(e,300)),this.navigationId!==s?(V(`Polling aborted for ${i}: user navigated away during completion animation`),void(this.progressAnimator&&(this.progressAnimator.stop(),this.progressAnimator=null))):(this.progressAnimator.complete(),await new Promise(e=>setTimeout(e,500)),this.navigationId!==s?(V(`Polling aborted for ${i}: user navigated away before filter apply`),void(this.progressAnimator&&(this.progressAnimator.stop(),this.progressAnimator=null))):(this.progressAnimator.stop(),this.progressAnimator=null,void await this.applyFilter(a)));throw new Error("Job completed but no transcript returned");case"failed":if("AGE_RESTRICTED"===d){if(this.progressAnimator&&(this.progressAnimator.stop(),this.progressAnimator=null),this.updateButtonState({state:"age-restricted",text:"Age-Restricted",error:l||"This video is age-restricted by YouTube. SafePlay cannot filter age-restricted content.",videoId:i||void 0}),this.isProcessing=!1,this.filteringVideoId=null,this.videoWasPlaying){const e=this.getVideoElement();e&&(e.play(),V("Video resumed after age-restricted detection")),this.videoWasPlaying=!1}return}throw new Error(l||"Processing failed");default:this.progressAnimator.setTarget(o)}await new Promise(e=>setTimeout(e,2e3)),t++}catch(e){V("Poll error:",e),this.progressAnimator&&(this.progressAnimator.stop(),this.progressAnimator=null);const t=e instanceof Error?e.message:"Unknown error";return this.updateButtonState({state:"error",text:"Retry",error:`${t} - Click to retry`,videoId:i||void 0}),this.isProcessing=!1,this.filteringVideoId=null,void k()}}this.progressAnimator&&(this.progressAnimator.stop(),this.progressAnimator=null),this.updateButtonState({state:"error",text:"Retry",error:"Processing timed out - Click to retry",videoId:i||void 0}),this.isProcessing=!1,this.filteringVideoId=null,k()}async applyFilter(e){if(!this.videoController)throw new Error("Video controller not initialized");const t=this.filteringVideoId||this.currentVideoId;if(!t)throw new Error("No video ID");const i=this.navigationId;V("Transcript received for filtering:",{id:e.id,segmentCount:e.segments?.length,sampleSegment:e.segments?.[0]?{text:e.segments[0].text,times:`${e.segments[0].start_time}s - ${e.segments[0].end_time}s`,hasCharacters:!!e.segments[0].characters,charCount:e.segments[0].characters?.length,sampleChars:e.segments[0].characters?.slice(0,3)}:null});try{if(await this.videoController.initialize(t,this.preferences),this.navigationId!==i)return void V(`Filter apply aborted for ${t}: user navigated away during initialization`);if(this.videoController.onTranscriptReceived(e),await this.videoController.applyFilter(),this.navigationId!==i)return void V(`Filter apply aborted for ${t}: user navigated away during filter application`);const s=this.videoController.getState().intervalCount||0,n=this.videoController.getMuteIntervals();this.lastIntervalCount=s,this.isFilterActive=!0,this.captionFilter.initialize(this.preferences,n),this.captionFilter.start(),V("Caption filter started");const r=this.getVideoElement();if(r&&n.length>0&&(this.timelineMarkers=new S({debug:M}),this.timelineMarkers.initialize(r,n),V("Timeline markers initialized")),this.updateButtonState({state:"filtering",text:`Censored (${s})`,intervalCount:s,videoId:t}),V(`Filter applied successfully. ${s} profanity instances will be muted.`),t&&await async function(e){try{const t=await T();if(!t.includes(e)){t.push(e);const i=t.slice(-500);await chrome.storage.local.set({[P]:i})}}catch(e){console.error("[SafePlay Storage] Error adding filtered video:",e)}}(t),this.videoWasPlaying){const e=this.getVideoElement();e&&(e.play(),V("Video resumed after filter applied")),this.videoWasPlaying=!1}this.injectPlayerControls()}catch(e){if(V("Failed to apply filter:",e),this.videoWasPlaying){const e=this.getVideoElement();e&&(e.play(),V("Video resumed after filter error")),this.videoWasPlaying=!1}throw e}finally{this.isProcessing=!1,this.filteringVideoId=null}}injectPlayerControls(){if(document.querySelector(".safeplay-player-controls"))return;const e=()=>{const t=document.querySelector(".ytp-right-controls");t?this.createPlayerButton(t):setTimeout(e,500)};e()}createPlayerButton(e){const t=document.createElement("button");t.className="ytp-button safeplay-player-controls safeplay-active",t.title="SafePlay Filter Active - Click to toggle",t.innerHTML='\n      <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">\n        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>\n      </svg>\n    ',t.addEventListener("click",()=>this.toggleFilter());const i=e.querySelector(".ytp-settings-button");i&&i.parentElement===e?e.insertBefore(t,i):e.insertBefore(t,e.firstChild)}async toggleFilter(){await this.toggleFilterFromButton()}async toggleFilterFromButton(){if(!this.videoController)return;const e=document.querySelector(".safeplay-player-controls");this.isFilterActive?(this.videoController.stop(),this.captionFilter.stop(),this.timelineMarkers?.hide(),this.isFilterActive=!1,e?.classList.remove("safeplay-active"),e?.setAttribute("title","SafePlay Filter Paused - Click to resume"),this.updateButtonState({state:"paused",text:"Paused",intervalCount:this.lastIntervalCount}),V("Filter paused by user")):this.currentVideoId&&this.lastIntervalCount>0&&(this.videoController.resume(),this.captionFilter.start(),this.timelineMarkers?.show(),this.isFilterActive=!0,e?.classList.add("safeplay-active"),e?.setAttribute("title","SafePlay Filter Active - Click to toggle"),this.updateButtonState({state:"filtering",text:`Censored (${this.lastIntervalCount})`,intervalCount:this.lastIntervalCount}),V("Filter resumed by user"))}onVideoStateChange(e){V("Video state changed:",e),B()?chrome.runtime.sendMessage({type:"VIDEO_STATE_CHANGED",payload:e}).catch(()=>{}):V("Extension context invalidated, skipping state change notification")}setupMessageListener(){if(B())try{chrome.runtime.onMessage.addListener((e,t,i)=>(this.handleMessage(e).then(i),!0))}catch(e){V("Failed to setup message listener (extension context may be invalidated):",e)}else V("Extension context invalidated, skipping message listener setup")}async handleMessage(e){switch(e.type){case"PREFERENCES_UPDATED":{const t=e.payload;return this.preferences=t,this.videoController?.updatePreferences(t),this.captionFilter.updatePreferences(t),{success:!0}}case"GET_VIDEO_STATE":return{success:!0,data:this.videoController?.getState()||null};default:return{success:!1,error:"Unknown message type"}}}setupNavigationListener(){document.addEventListener("yt-navigate-finish",()=>{V("YouTube navigation detected"),this.onNavigation()}),window.addEventListener("popstate",()=>{this.onNavigation()})}onNavigation(){this.navigationId++,V(`Navigation detected, navigationId: ${this.navigationId}`),this.videoController&&this.videoController.stop(),this.captionFilter.stop(),this.progressAnimator&&(this.progressAnimator.stop(),this.progressAnimator=null),this.timelineMarkers&&(this.timelineMarkers.destroy(),this.timelineMarkers=null),this.currentVideoId=null,this.filteringVideoId=null,this.isProcessing=!1,this.isFilterActive=!1,this.lastIntervalCount=0,this.videoWasPlaying=!1;const e=document.querySelector(".safeplay-player-controls");e&&e.remove(),(this.isWatchPage()||this.isShortsPage())&&(this.currentVideoId=this.getVideoIdFromUrl(),this.currentVideoId&&setTimeout(()=>this.checkAutoEnable(),500))}async checkAutoEnable(){if(this.currentVideoId&&!1!==this.preferences.autoEnableForFilteredVideos&&!this.isProcessing)try{const e=await L({type:"CHECK_AUTH_STRICT"});if(!e?.success||!e?.data?.authenticated)return void V("Auto-enable skipped: user not authenticated");await async function(e){try{return(await T()).includes(e)}catch(e){return console.error("[SafePlay Storage] Error checking if video filtered:",e),!1}}(this.currentVideoId)&&(V(`Auto-enabling filter for previously filtered video: ${this.currentVideoId}`),this.onFilterButtonClick(this.currentVideoId))}catch(e){V("Error checking auto-enable:",e)}}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{(new $).initialize()}):(new $).initialize()})();
//# sourceMappingURL=content.js.map