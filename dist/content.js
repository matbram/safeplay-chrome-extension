(()=>{"use strict";const t="safeplay-video-page-button-container",e={idle:{bg:"linear-gradient(135deg, #4CAF50 0%, #45a049 100%)",hoverBg:"linear-gradient(135deg, #45a049 0%, #3d8b40 100%)",text:"SafePlay",shadow:"rgba(76, 175, 80, 0.3)"},connecting:{bg:"linear-gradient(135deg, #607D8B 0%, #546E7A 100%)",hoverBg:"linear-gradient(135deg, #546E7A 0%, #455A64 100%)",text:"Connecting...",shadow:"rgba(96, 125, 139, 0.3)"},downloading:{bg:"linear-gradient(135deg, #7E57C2 0%, #673AB7 100%)",hoverBg:"linear-gradient(135deg, #673AB7 0%, #5E35B1 100%)",text:"Analyzing...",shadow:"rgba(126, 87, 194, 0.3)"},transcribing:{bg:"linear-gradient(135deg, #7E57C2 0%, #673AB7 100%)",hoverBg:"linear-gradient(135deg, #673AB7 0%, #5E35B1 100%)",text:"Analyzing...",shadow:"rgba(126, 87, 194, 0.3)"},processing:{bg:"linear-gradient(135deg, #7E57C2 0%, #673AB7 100%)",hoverBg:"linear-gradient(135deg, #673AB7 0%, #5E35B1 100%)",text:"Analyzing...",shadow:"rgba(126, 87, 194, 0.3)"},filtering:{bg:"linear-gradient(135deg, #26A69A 0%, #00897B 100%)",hoverBg:"linear-gradient(135deg, #00897B 0%, #00796B 100%)",text:"Active",shadow:"rgba(38, 166, 154, 0.3)"},error:{bg:"linear-gradient(135deg, #EF5350 0%, #E53935 100%)",hoverBg:"linear-gradient(135deg, #E53935 0%, #D32F2F 100%)",text:"Retry",shadow:"rgba(239, 83, 80, 0.3)"}};class s{constructor(t){this.observer=null,this.currentVideoId=null,this.injectionAttempts=0,this.maxAttempts=50,this.retryInterval=null,this.currentState="idle",this.options=t}start(){this.log("Starting video page injector"),this.attemptInjection(),this.setupMutationObserver(),this.setupNavigationListener()}stop(){this.observer&&(this.observer.disconnect(),this.observer=null),null!==this.retryInterval&&(clearInterval(this.retryInterval),this.retryInterval=null),this.log("Stopped video page injector")}isWatchPage(){return"/watch"===window.location.pathname&&window.location.search.includes("v=")}getVideoId(){return new URLSearchParams(window.location.search).get("v")}attemptInjection(){if(!this.isWatchPage())return;const t=this.getVideoId();if(!t)return void this.log("No video ID found");if(this.currentVideoId===t&&this.isButtonPresent())return void this.log("Button already present for this video");const e=this.findSubscribeButton();e?(this.injectButton(e,t),this.currentVideoId=t,this.injectionAttempts=0,null!==this.retryInterval&&(clearInterval(this.retryInterval),this.retryInterval=null)):(this.injectionAttempts++,this.log(`Subscribe button not found, attempt ${this.injectionAttempts}/${this.maxAttempts}`),this.injectionAttempts<this.maxAttempts&&null===this.retryInterval&&(this.retryInterval=window.setInterval(()=>{this.attemptInjection()},200)))}findSubscribeButton(){const t=["#subscribe-button.ytd-watch-metadata","ytd-watch-metadata #subscribe-button","#owner #subscribe-button","#subscribe-button"];for(const e of t){const t=document.querySelector(e);if(t)return this.log(`Found subscribe button with selector: ${e}`),t}return null}isButtonPresent(){return null!==document.querySelector(`.${t}`)}injectButton(s,i){const r=document.querySelector(`.${t}`);r&&r.remove(),this.currentState="idle";const n=document.createElement("div");n.className=`${t} style-scope ytd-watch-metadata`,n.style.cssText="display: inline-flex; align-items: center; margin-left: 8px;",n.setAttribute("data-safeplay-processed","true");const o=document.createElement("button");o.className="safeplay-main-button yt-spec-button-shape-next yt-spec-button-shape-next--tonal yt-spec-button-shape-next--mono yt-spec-button-shape-next--size-m yt-spec-button-shape-next--icon-leading",o.title="Filter profanity with SafePlay",o.setAttribute("aria-label","SafePlay Filter"),o.setAttribute("data-video-id",i);const a=e.idle;o.style.cssText=`\n      border: none;\n      background: ${a.bg};\n      color: #ffffff;\n      border-radius: 18px;\n      padding: 0 16px;\n      height: 36px;\n      font-family: "Roboto", "Arial", sans-serif;\n      font-size: 14px;\n      font-weight: 500;\n      line-height: 36px;\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      gap: 6px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      min-width: 120px;\n      box-shadow: 0 2px 4px ${a.shadow};\n      position: relative;\n      overflow: hidden;\n    `;const l=document.createElement("div");l.className="safeplay-progress-bar",l.style.cssText="\n      position: absolute;\n      bottom: 0;\n      left: 0;\n      height: 3px;\n      width: 0%;\n      background: rgba(255, 255, 255, 0.5);\n      transition: width 0.3s ease;\n      border-radius: 0 0 18px 18px;\n    ";const d=document.createElement("div");d.className="safeplay-icon",d.style.cssText="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; flex-shrink: 0;",d.innerHTML=this.getIconSVG("idle");const c=document.createElement("span");c.className="safeplay-text",c.style.cssText="color: currentColor; font-size: 14px; font-weight: 500; line-height: 1; white-space: nowrap;",c.textContent=a.text,o.appendChild(d),o.appendChild(c),o.appendChild(l),o.addEventListener("mouseenter",()=>{const t=e[this.currentState];o.style.background=t.hoverBg,o.style.boxShadow=`0 4px 8px ${t.shadow}`,o.style.transform="translateY(-1px)"}),o.addEventListener("mouseleave",()=>{const t=e[this.currentState];o.style.background=t.bg,o.style.boxShadow=`0 2px 4px ${t.shadow}`,o.style.transform="translateY(0)"}),o.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),"idle"!==this.currentState&&"error"!==this.currentState||this.options.onButtonClick(i)}),n.appendChild(o),s.parentElement?.insertBefore(n,s.nextSibling),this.log(`Injected SafePlay button for video: ${i}`)}getIconSVG(t){switch(t){case"connecting":case"downloading":case"transcribing":case"processing":return'\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="safeplay-spinner">\n            <style>.safeplay-spinner { animation: safeplay-spin 1s linear infinite; } @keyframes safeplay-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>\n            <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>\n            <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/>\n          </svg>\n        ';case"filtering":return'\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>\n          </svg>\n        ';case"error":return'\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>\n          </svg>\n        ';default:return'\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>\n          </svg>\n        '}}updateButtonState(s){const i=document.querySelector(`.${t}`);if(!i)return;const r=i.querySelector(".safeplay-main-button"),n=i.querySelector(".safeplay-text"),o=i.querySelector(".safeplay-icon"),a=i.querySelector(".safeplay-progress-bar");if(!r||!n||!o)return;this.currentState=s.state;const l=e[s.state];r.style.background=l.bg,r.style.boxShadow=`0 2px 4px ${l.shadow}`,o.innerHTML=this.getIconSVG(s.state);let d=s.text||l.text;switch(void 0!==s.progress&&s.progress>0&&("downloading"!==s.state&&"transcribing"!==s.state&&"processing"!==s.state||(d=`${l.text.replace("...","")} ${Math.round(s.progress)}%`)),"filtering"===s.state&&void 0!==s.intervalCount&&(d=`Filtering (${s.intervalCount})`),n.textContent=d,a&&(void 0!==s.progress&&s.progress>0&&s.progress<100?(a.style.width=`${s.progress}%`,a.style.display="block"):(a.style.width="0%",a.style.display="none")),"idle"===s.state||"error"===s.state?r.style.cursor="pointer":r.style.cursor="default",s.state){case"connecting":r.title="Connecting to SafePlay service...";break;case"downloading":r.title="Downloading video audio"+(s.progress?` (${Math.round(s.progress)}%)`:"...");break;case"transcribing":r.title="Transcribing audio"+(s.progress?` (${Math.round(s.progress)}%)`:"...");break;case"processing":r.title="Processing transcript...";break;case"filtering":r.title="Filtering profanity"+(s.intervalCount?` - ${s.intervalCount} instances found`:"");break;case"error":r.title=s.error||"An error occurred. Click to retry.";break;default:r.title="Click to filter profanity with SafePlay"}this.log(`Button state updated to: ${s.state}`,s)}setButtonState(t,e,s){this.updateButtonState({state:t,text:e||"",progress:s})}setupMutationObserver(){this.observer=new MutationObserver(t=>{for(const e of t)if("childList"===e.type&&e.addedNodes.length>0)for(const t of e.addedNodes)if(t instanceof HTMLElement&&("subscribe-button"===t.id||t.querySelector?.("#subscribe-button")||t.closest?.("ytd-watch-metadata")))return this.log("Subscribe button area changed, re-injecting"),void this.attemptInjection()}),this.observer.observe(document.body,{childList:!0,subtree:!0})}setupNavigationListener(){const t=history.pushState,e=history.replaceState;history.pushState=(...e)=>{t.apply(history,e),this.onNavigation()},history.replaceState=(...t)=>{e.apply(history,t),this.onNavigation()},window.addEventListener("popstate",()=>{this.onNavigation()}),document.addEventListener("yt-navigate-finish",()=>{this.onNavigation()}),document.addEventListener("yt-page-data-updated",()=>{this.log("Page data updated"),this.onNavigation()})}onNavigation(){this.log("Navigation detected"),this.currentVideoId=null,this.currentState="idle",this.injectionAttempts=0,null!==this.retryInterval&&(clearInterval(this.retryInterval),this.retryInterval=null),setTimeout(()=>{this.attemptInjection()},300)}getCurrentVideoId(){return this.currentVideoId}log(...t){this.options.debug&&console.log("[SafePlay Injector]",...t)}}class i{constructor(t){this.video=null,this.muteIntervals=[],this.filterMode="mute",this.isActive=!1,this.checkIntervalId=null,this.isMuted=!1,this.audioContext=null,this.bleepOscillator=null,this.bleepGain=null,this.onMuteStart=t?.onMuteStart,this.onMuteEnd=t?.onMuteEnd}initialize(t,e,s="mute"){this.video=t,this.muteIntervals=e,this.filterMode=s,this.muteIntervals.sort((t,e)=>t.start-e.start),"bleep"===s&&this.initializeAudioContext()}initializeAudioContext(){try{this.audioContext=new AudioContext,this.bleepGain=this.audioContext.createGain(),this.bleepGain.gain.value=0,this.bleepGain.connect(this.audioContext.destination)}catch(t){console.error("[SafePlay] Failed to initialize audio context:",t)}}start(){!this.isActive&&this.video&&(this.isActive=!0,this.checkIntervalId=window.setInterval(()=>{this.checkCurrentTime()},10),console.log("[SafePlay] Audio filter started with",this.muteIntervals.length,"intervals"))}stop(){this.isActive&&(this.isActive=!1,null!==this.checkIntervalId&&(clearInterval(this.checkIntervalId),this.checkIntervalId=null),this.unmute(),this.bleepOscillator&&(this.bleepOscillator.stop(),this.bleepOscillator=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null),console.log("[SafePlay] Audio filter stopped"))}checkCurrentTime(){if(!this.video||!this.isActive)return;const t=this.video.currentTime,e=this.findActiveInterval(t);e&&!this.isMuted?this.mute(e):!e&&this.isMuted&&this.unmute()}findActiveInterval(t){let e=0,s=this.muteIntervals.length-1;for(;e<=s;){const i=Math.floor((e+s)/2),r=this.muteIntervals[i];if(t>=r.start&&t<=r.end)return r;t<r.start?s=i-1:e=i+1}return null}mute(t){this.video&&(this.isMuted=!0,"mute"===this.filterMode?this.video.muted=!0:"bleep"===this.filterMode&&(this.video.muted=!0,this.startBleep()),this.onMuteStart&&this.onMuteStart(t))}unmute(){this.video&&(this.isMuted=!1,this.video.muted=!1,"bleep"===this.filterMode&&this.stopBleep(),this.onMuteEnd&&this.onMuteEnd())}startBleep(){this.audioContext&&this.bleepGain&&("suspended"===this.audioContext.state&&this.audioContext.resume(),this.bleepOscillator=this.audioContext.createOscillator(),this.bleepOscillator.type="sine",this.bleepOscillator.frequency.value=1e3,this.bleepOscillator.connect(this.bleepGain),this.bleepGain.gain.setValueAtTime(0,this.audioContext.currentTime),this.bleepGain.gain.linearRampToValueAtTime(.3,this.audioContext.currentTime+.01),this.bleepOscillator.start())}stopBleep(){this.audioContext&&this.bleepGain&&this.bleepOscillator&&(this.bleepGain.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+.01),setTimeout(()=>{this.bleepOscillator&&(this.bleepOscillator.stop(),this.bleepOscillator.disconnect(),this.bleepOscillator=null)},20))}updateIntervals(t){this.muteIntervals=t,this.muteIntervals.sort((t,e)=>t.start-e.start)}updateMode(t){this.filterMode=t,"bleep"!==t||this.audioContext||this.initializeAudioContext()}getState(){return{isActive:this.isActive,isMuted:this.isMuted,intervalCount:this.muteIntervals.length,filterMode:this.filterMode}}isFiltering(){return this.isActive}getIntervals(){return[...this.muteIntervals]}}const r=new Map([{word:"fuck",severity:"severe"},{word:"fucking",severity:"severe"},{word:"fucked",severity:"severe"},{word:"fucker",severity:"severe"},{word:"fuckers",severity:"severe"},{word:"fucks",severity:"severe"},{word:"motherfucker",severity:"severe"},{word:"motherfucking",severity:"severe"},{word:"motherfuckers",severity:"severe"},{word:"cunt",severity:"severe"},{word:"cunts",severity:"severe"},{word:"nigger",severity:"severe"},{word:"niggers",severity:"severe"},{word:"nigga",severity:"severe"},{word:"niggas",severity:"severe"},{word:"faggot",severity:"severe"},{word:"faggots",severity:"severe"},{word:"fag",severity:"severe"},{word:"fags",severity:"severe"},{word:"retard",severity:"severe"},{word:"retarded",severity:"severe"},{word:"retards",severity:"severe"},{word:"shit",severity:"moderate"},{word:"shits",severity:"moderate"},{word:"shitty",severity:"moderate"},{word:"bullshit",severity:"moderate"},{word:"horseshit",severity:"moderate"},{word:"shithead",severity:"moderate"},{word:"shitheads",severity:"moderate"},{word:"ass",severity:"moderate"},{word:"asses",severity:"moderate"},{word:"asshole",severity:"moderate"},{word:"assholes",severity:"moderate"},{word:"bastard",severity:"moderate"},{word:"bastards",severity:"moderate"},{word:"bitch",severity:"moderate"},{word:"bitches",severity:"moderate"},{word:"bitchy",severity:"moderate"},{word:"cock",severity:"moderate"},{word:"cocks",severity:"moderate"},{word:"cocksucker",severity:"moderate"},{word:"cocksuckers",severity:"moderate"},{word:"dick",severity:"moderate"},{word:"dicks",severity:"moderate"},{word:"dickhead",severity:"moderate"},{word:"dickheads",severity:"moderate"},{word:"pussy",severity:"moderate"},{word:"pussies",severity:"moderate"},{word:"prick",severity:"moderate"},{word:"pricks",severity:"moderate"},{word:"slut",severity:"moderate"},{word:"sluts",severity:"moderate"},{word:"slutty",severity:"moderate"},{word:"whore",severity:"moderate"},{word:"whores",severity:"moderate"},{word:"twat",severity:"moderate"},{word:"twats",severity:"moderate"},{word:"wanker",severity:"moderate"},{word:"wankers",severity:"moderate"},{word:"bollocks",severity:"moderate"},{word:"damn",severity:"mild"},{word:"damned",severity:"mild"},{word:"dammit",severity:"mild"},{word:"goddamn",severity:"mild"},{word:"goddamnit",severity:"mild"},{word:"hell",severity:"mild"},{word:"crap",severity:"mild"},{word:"crappy",severity:"mild"},{word:"piss",severity:"mild"},{word:"pissed",severity:"mild"},{word:"pissing",severity:"mild"},{word:"suck",severity:"mild"},{word:"sucks",severity:"mild"},{word:"sucked",severity:"mild"},{word:"balls",severity:"mild"},{word:"butt",severity:"mild"},{word:"butthole",severity:"mild"},{word:"screw",severity:"mild"},{word:"screwed",severity:"mild"},{word:"douche",severity:"mild"},{word:"douchebag",severity:"mild"},{word:"douchebags",severity:"mild"}].map(t=>[t.word.toLowerCase(),t.severity]));function n(t){const e=[],s=t.toLowerCase();for(const[t,i]of r){let r=s.indexOf(t);for(;-1!==r;)e.push({word:t,severity:i,startIndex:r,endIndex:r+t.length}),r=s.indexOf(t,r+1)}e.sort((t,e)=>t.startIndex-e.startIndex);const i=[];for(const t of e){const e=i[i.length-1];!e||t.startIndex>=e.endIndex?i.push(t):t.endIndex-t.startIndex>e.endIndex-e.startIndex&&(i[i.length-1]=t)}return i}class o{constructor(t){this.preferences=t,this.customBlacklistMap=new Map(t.customBlacklist.map(t=>[t.toLowerCase(),"severe"])),this.customWhitelistSet=new Set(t.customWhitelist.map(t=>t.toLowerCase()))}shouldFilterSeverity(t){return this.preferences.severityLevels[t]}shouldFilterWord(t,e){const s=t.toLowerCase();return!this.customWhitelistSet.has(s)&&(!!this.customBlacklistMap.has(s)||this.shouldFilterSeverity(e))}getWordSeverity(t){const e=t.toLowerCase();return this.customBlacklistMap.has(e)?this.customBlacklistMap.get(e):r.get(e)||null}getCharacterLevelTiming(t,e,s){let i=t.start_time,r=t.end_time;if(t.characters&&t.characters.length>0){const n=t.characters[e],o=t.characters[Math.min(s-1,t.characters.length-1)];n&&(i=n.start),o&&(r=o.end),console.log(`[SafePlay Parser] Character timing: "${t.text.substring(e,s)}" chars[${e}..${s-1}] -> ${i.toFixed(3)}s - ${r.toFixed(3)}s`)}return{startTime:i,endTime:r}}findProfanityMatches(t){const e=[];for(let s=0;s<t.length;s++){const i=t[s],r=i.text.toLowerCase().trim(),o=this.getWordSeverity(r);if(o&&this.shouldFilterWord(r,o)){const{startTime:t,endTime:r}=this.getCharacterLevelTiming(i,0,i.text.length);e.push({segmentIndex:s,word:i.text,severity:o,startTime:t,endTime:r,isPartialMatch:!1});continue}const a=n(r);for(const[t]of this.customBlacklistMap){const e=r.indexOf(t);-1!==e&&a.push({word:t,severity:"severe",startIndex:e,endIndex:e+t.length})}for(const t of a){if(!this.shouldFilterWord(t.word,t.severity))continue;const{startTime:r,endTime:n}=this.getCharacterLevelTiming(i,t.startIndex,t.endIndex);e.push({segmentIndex:s,word:t.word,severity:t.severity,startTime:r,endTime:n,isPartialMatch:!0,matchedPortion:i.text.substring(t.startIndex,t.endIndex)})}}return e}createMuteIntervals(t){const e=this.preferences.paddingMs/1e3;return t.map(t=>{const s={start:Math.max(0,t.startTime-e),end:t.endTime+e,word:t.word,severity:t.severity};return console.log(`[SafePlay Parser] Mute interval: "${t.word}" ${s.start.toFixed(3)}s - ${s.end.toFixed(3)}s (padding: ${this.preferences.paddingMs}ms)`),s})}mergeIntervals(t){if(0===t.length)return[];const e=[...t].sort((t,e)=>t.start-e.start),s=this.preferences.mergeThresholdMs/1e3,i=[e[0]];for(let t=1;t<e.length;t++){const r=e[t],n=i[i.length-1];r.start<=n.end+s?(n.end=Math.max(n.end,r.end),this.severityRank(r.severity)>this.severityRank(n.severity)&&(n.severity=r.severity),n.word.includes(r.word)||(n.word=`${n.word}, ${r.word}`)):i.push({...r})}return i}severityRank(t){return{mild:1,moderate:2,severe:3}[t]}parse(t){const e=this.findProfanityMatches(t.segments),s=this.createMuteIntervals(e);return this.mergeIntervals(s)}}function a(t,e){return new o(e).parse(t)}class l{constructor(t={}){this.youtubeId=null,this.video=null,this.transcript=null,this.muteIntervals=[],this.preferences=null,this.status="idle",this.progress=0,this.statusOverlay=null,this.options=t,this.audioFilter=new i({onMuteStart:t=>this.onMuteStart(t),onMuteEnd:()=>this.onMuteEnd()})}async initialize(t,e){this.youtubeId=t,this.preferences=e,this.updateStatus("idle"),this.video=this.findVideoElement(),this.video||(this.log("Video element not found, waiting..."),await this.waitForVideo()),this.video?this.log("Video controller initialized for:",t):this.updateStatus("error",0,"Could not find video element")}async applyFilter(){if(this.youtubeId&&this.video&&this.preferences)if(this.preferences.enabled)try{this.updateStatus("loading");const t=await chrome.runtime.sendMessage({type:"GET_FILTER",payload:{youtubeId:this.youtubeId}});if(!t.success)throw new Error(t.error||"Failed to get transcript");if("processing"===t.data.status)return void this.updateStatus("processing",t.data.progress||0);this.transcript=t.data.transcript,await this.processTranscript()}catch(t){const e=t instanceof Error?t.message:"Unknown error";this.updateStatus("error",0,e),this.log("Filter error:",t)}else this.updateStatus("disabled");else this.log("Cannot apply filter: missing required data")}async processTranscript(){if(this.transcript&&this.preferences&&this.video){if(this.muteIntervals=a(this.transcript,this.preferences),this.log("Found",this.muteIntervals.length,"mute intervals"),0===this.muteIntervals.length)return this.updateStatus("active"),void this.log("No profanity detected in video");this.audioFilter.initialize(this.video,this.muteIntervals,this.preferences.filterMode),this.audioFilter.start(),this.updateStatus("active"),this.showStatusOverlay()}}onTranscriptReceived(t){this.transcript=t,this.processTranscript()}onProcessingProgress(t){this.updateStatus("processing",t)}onProcessingError(t){this.updateStatus("error",0,t)}stop(){this.audioFilter.stop(),this.hideStatusOverlay(),this.updateStatus("idle")}resume(){this.video&&0!==this.muteIntervals.length&&(this.audioFilter.start(),this.updateStatus("active"),this.showStatusOverlay())}updatePreferences(t){this.preferences=t,t.enabled?this.transcript&&(this.muteIntervals=a(this.transcript,t),this.audioFilter.updateIntervals(this.muteIntervals),this.audioFilter.updateMode(t.filterMode)):this.stop()}getState(){const t=this.audioFilter.getState();return{status:this.status,progress:this.progress,error:this.error,intervalCount:t.intervalCount,currentlyMuting:t.isMuted}}findVideoElement(){const t=["video.html5-main-video","video.video-stream","#movie_player video","ytd-player video","video"];for(const e of t){const t=document.querySelector(e);if(t&&t.src)return t}return null}waitForVideo(t=1e4){return new Promise(e=>{const s=Date.now(),i=()=>{this.video=this.findVideoElement(),this.video?e(this.video):Date.now()-s>t?e(null):requestAnimationFrame(i)};i()})}updateStatus(t,e=0,s){this.status=t,this.progress=e,this.error=s,this.options.onStateChange&&this.options.onStateChange(this.getState())}showStatusOverlay(){if(this.statusOverlay)return;const t=document.querySelector("#movie_player");t&&(this.statusOverlay=document.createElement("div"),this.statusOverlay.className="safeplay-status-overlay",this.statusOverlay.innerHTML='\n      <div class="safeplay-status-badge">\n        <svg class="safeplay-status-icon" viewBox="0 0 24 24" fill="currentColor">\n          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>\n        </svg>\n        <span>SafePlay Active</span>\n      </div>\n    ',t.appendChild(this.statusOverlay),setTimeout(()=>{this.statusOverlay?.classList.add("safeplay-status-hidden")},3e3))}hideStatusOverlay(){this.statusOverlay&&(this.statusOverlay.remove(),this.statusOverlay=null)}onMuteStart(t){this.log("Muting:",t.word),this.notifyStateChange()}onMuteEnd(){this.notifyStateChange()}notifyStateChange(){this.options.onStateChange&&this.options.onStateChange(this.getState())}log(...t){this.options.debug&&console.log("[SafePlay Controller]",...t)}}const d={enabled:!0,filterMode:"mute",severityLevels:{mild:!1,moderate:!0,severe:!0},customBlacklist:[],customWhitelist:[],paddingMs:50,mergeThresholdMs:100},c=!0;function h(...t){console.log("[SafePlay]",...t)}class u{constructor(){this.videoController=null,this.preferences=d,this.currentVideoId=null,this.isProcessing=!1,this.injector=new s({onButtonClick:t=>this.onFilterButtonClick(t),debug:c}),this.videoController=new l({onStateChange:t=>this.onVideoStateChange(t),debug:c})}async initialize(){h("Initializing SafePlay content script"),await this.loadPreferences(),this.injector.start(),this.isWatchPage()&&(this.currentVideoId=this.getVideoIdFromUrl()),this.setupMessageListener(),this.setupNavigationListener(),h("SafePlay initialized")}async loadPreferences(){try{const t=await chrome.runtime.sendMessage({type:"GET_PREFERENCES"});t.success&&t.data&&(this.preferences=t.data)}catch(t){h("Failed to load preferences:",t)}}isWatchPage(){return"/watch"===window.location.pathname}getVideoIdFromUrl(){return new URLSearchParams(window.location.search).get("v")}updateButtonState(t){this.injector.updateButtonState(t)}async onFilterButtonClick(t){if(this.isProcessing)h("Already processing, ignoring click");else{h("Filter button clicked for:",t),this.isProcessing=!0,this.currentVideoId=t;try{this.updateButtonState({state:"connecting",text:"Connecting..."});const e=await chrome.runtime.sendMessage({type:"GET_FILTER",payload:{youtubeId:t}});if(!e.success)throw new Error(e.error||"Failed to request filter");const{status:s,transcript:i,jobId:r}=e.data;if("cached"!==s&&"completed"!==s||!i){if("processing"!==s||!r)throw new Error("Unexpected API response");h("Job started, polling for completion:",r),await this.pollJobStatus(r)}else h("Using cached transcript"),this.updateButtonState({state:"processing",text:"Processing..."}),await this.applyFilter(i)}catch(t){h("Filter request failed:",t);const e=t instanceof Error?t.message:"Unknown error";this.updateButtonState({state:"error",text:"Error",error:e}),this.isProcessing=!1}}}async pollJobStatus(t){let e=0;for(;e<180;)try{const s=await chrome.runtime.sendMessage({type:"CHECK_JOB",payload:{jobId:t}});if(!s.success)throw new Error(s.error||"Failed to check job status");const{status:i,progress:r,transcript:n,error:o}=s.data;switch(h(`Job status: ${i}, progress: ${r}%`),i){case"pending":this.updateButtonState({state:"processing",text:"Starting...",progress:5});break;case"downloading":case"transcribing":const t="downloading"===i?Math.round(.3*r):Math.round(30+.6*r);this.updateButtonState({state:"processing",text:`Analyzing ${t}%`,progress:t});break;case"completed":if(n)return this.updateButtonState({state:"processing",text:"Analyzing 95%",progress:95}),void await this.applyFilter(n);throw new Error("Job completed but no transcript returned");case"failed":throw new Error(o||"Processing failed");default:this.updateButtonState({state:"processing",text:`Analyzing ${Math.round(r)}%`,progress:r})}await new Promise(t=>setTimeout(t,2e3)),e++}catch(t){h("Poll error:",t);const e=t instanceof Error?t.message:"Unknown error";return this.updateButtonState({state:"error",text:"Error",error:e}),void(this.isProcessing=!1)}this.updateButtonState({state:"error",text:"Timeout",error:"Processing took too long. Please try again."}),this.isProcessing=!1}async applyFilter(t){if(!this.videoController)throw new Error("Video controller not initialized");const e=this.currentVideoId;if(!e)throw new Error("No video ID");h("Transcript received for filtering:",{id:t.id,segmentCount:t.segments?.length,sampleSegment:t.segments?.[0]?{text:t.segments[0].text,times:`${t.segments[0].start_time}s - ${t.segments[0].end_time}s`,hasCharacters:!!t.segments[0].characters,charCount:t.segments[0].characters?.length,sampleChars:t.segments[0].characters?.slice(0,3)}:null});try{await this.videoController.initialize(e,this.preferences),this.videoController.onTranscriptReceived(t),await this.videoController.applyFilter();const s=this.videoController.getState().intervalCount||0;this.updateButtonState({state:"filtering",text:`Filtering (${s})`,intervalCount:s}),h(`Filter applied successfully. ${s} profanity instances will be muted.`),this.injectPlayerControls()}catch(t){throw h("Failed to apply filter:",t),t}finally{this.isProcessing=!1}}injectPlayerControls(){if(document.querySelector(".safeplay-player-controls"))return;const t=()=>{const e=document.querySelector(".ytp-right-controls");e?this.createPlayerButton(e):setTimeout(t,500)};t()}createPlayerButton(t){const e=document.createElement("button");e.className="ytp-button safeplay-player-controls safeplay-active",e.title="SafePlay Filter Active - Click to toggle",e.innerHTML='\n      <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">\n        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>\n      </svg>\n    ',e.addEventListener("click",()=>this.toggleFilter());const s=t.querySelector(".ytp-settings-button");s&&s.parentElement===t?t.insertBefore(e,s):t.insertBefore(e,t.firstChild)}async toggleFilter(){if(!this.videoController)return;const t=this.videoController.getState(),e=document.querySelector(".safeplay-player-controls");if("active"===t.status)this.videoController.stop(),e?.classList.remove("safeplay-active"),e?.setAttribute("title","SafePlay Filter Paused - Click to resume"),this.updateButtonState({state:"idle",text:"SafePlay"});else if(this.currentVideoId){this.videoController.resume(),e?.classList.add("safeplay-active"),e?.setAttribute("title","SafePlay Filter Active - Click to toggle");const s=t.intervalCount||0;this.updateButtonState({state:"filtering",text:`Filtering (${s})`,intervalCount:s})}}onVideoStateChange(t){h("Video state changed:",t),chrome.runtime.sendMessage({type:"VIDEO_STATE_CHANGED",payload:t}).catch(()=>{})}setupMessageListener(){chrome.runtime.onMessage.addListener((t,e,s)=>(this.handleMessage(t).then(s),!0))}async handleMessage(t){switch(t.type){case"PREFERENCES_UPDATED":{const e=t.payload;return this.preferences=e,this.videoController?.updatePreferences(e),{success:!0}}case"GET_VIDEO_STATE":return{success:!0,data:this.videoController?.getState()||null};default:return{success:!1,error:"Unknown message type"}}}setupNavigationListener(){document.addEventListener("yt-navigate-finish",()=>{h("YouTube navigation detected"),this.onNavigation()}),window.addEventListener("popstate",()=>{this.onNavigation()})}onNavigation(){this.videoController&&this.videoController.stop(),this.currentVideoId=null,this.isProcessing=!1;const t=document.querySelector(".safeplay-player-controls");t&&t.remove(),this.isWatchPage()&&(this.currentVideoId=this.getVideoIdFromUrl())}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{(new u).initialize()}):(new u).initialize()})();
//# sourceMappingURL=content.js.map