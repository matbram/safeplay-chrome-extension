(()=>{"use strict";const e="data-safeplay-processed",t="safeplay-video-page-button-container",s="safeplay-shorts-button",i={idle:{bg:"#ff0000",hoverBg:"#cc0000",text:"SafePlay",shadow:"rgba(255, 0, 0, 0.3)"},connecting:{bg:"#3f3f3f",hoverBg:"#4f4f4f",text:"Connecting...",shadow:"rgba(63, 63, 63, 0.3)"},downloading:{bg:"#212121",hoverBg:"#2a2a2a",text:"Filtering...",shadow:"rgba(59, 130, 246, 0.4)",useWater:!0},transcribing:{bg:"#212121",hoverBg:"#2a2a2a",text:"Filtering...",shadow:"rgba(59, 130, 246, 0.4)",useWater:!0},processing:{bg:"#212121",hoverBg:"#2a2a2a",text:"Filtering...",shadow:"rgba(59, 130, 246, 0.4)",useWater:!0},filtering:{bg:"#3b82f6",hoverBg:"#2563eb",text:"Censored",shadow:"rgba(59, 130, 246, 0.4)"},paused:{bg:"#6b7280",hoverBg:"#4b5563",text:"Paused",shadow:"rgba(107, 114, 128, 0.4)"},error:{bg:"#ff4e45",hoverBg:"#e63e35",text:"Retry",shadow:"rgba(255, 78, 69, 0.4)"}};class r{constructor(e){this.observer=null,this.currentVideoId=null,this.injectionAttempts=0,this.maxAttempts=50,this.retryInterval=null,this.currentState="idle",this.shortsButtonStates=new Map,this.shortsScrollObserver=null,this.options=e}start(){this.log("Starting video page injector"),this.attemptInjection(),this.setupMutationObserver(),this.setupNavigationListener(),this.setupShortsScrollObserver()}stop(){this.observer&&(this.observer.disconnect(),this.observer=null),null!==this.retryInterval&&(clearInterval(this.retryInterval),this.retryInterval=null),this.shortsScrollObserver&&(this.shortsScrollObserver.disconnect(),this.shortsScrollObserver=null),this.log("Stopped video page injector")}isWatchPage(){return"/watch"===window.location.pathname&&window.location.search.includes("v=")}isShortsPage(){return window.location.pathname.startsWith("/shorts")}getVideoId(){return new URLSearchParams(window.location.search).get("v")}getShortsVideoId(){const e=window.location.pathname.match(/\/shorts\/([a-zA-Z0-9_-]+)/);return e?e[1]:null}attemptInjection(){if(this.isShortsPage())return void this.attemptShortsInjection();if(!this.isWatchPage())return;const e=this.getVideoId();if(!e)return void this.log("No video ID found");if(this.currentVideoId===e&&this.isButtonPresent())return void this.log("Button already present for this video");const t=this.findSubscribeButton();t?(this.injectButton(t,e),this.currentVideoId=e,this.injectionAttempts=0,null!==this.retryInterval&&(clearInterval(this.retryInterval),this.retryInterval=null)):(this.injectionAttempts++,this.log(`Subscribe button not found, attempt ${this.injectionAttempts}/${this.maxAttempts}`),this.injectionAttempts<this.maxAttempts&&null===this.retryInterval&&(this.retryInterval=window.setInterval(()=>{this.attemptInjection()},200)))}attemptShortsInjection(){document.querySelectorAll("ytd-reel-video-renderer, ytd-shorts").forEach(t=>{if("true"===t.getAttribute(e))return;const s=this.getShortsVideoIdFromRenderer(t);if(!s)return;const i=this.findShortsActionsContainer(t);i?(this.injectShortsButton(i,s,t),t.setAttribute(e,"true")):this.log("Shorts actions container not found for",s)}),this.injectIntoVisibleShort()}getShortsVideoIdFromRenderer(e){const t=e.querySelector('a[href*="/shorts/"]');if(t){const e=t.getAttribute("href"),s=e?.match(/\/shorts\/([a-zA-Z0-9_-]+)/);if(s)return s[1]}const s=this.getShortsVideoId();if(s)return s;const i=e.querySelector("video");if(i){const e=i.src||i.currentSrc;if(e){const t=e.match(/\/([a-zA-Z0-9_-]{11})\//);if(t)return t[1]}}return null}findShortsActionsContainer(e){const t=["#actions","ytd-reel-player-overlay-renderer #actions","#like-button",'[id="like-button"]',"ytd-like-button-renderer"];for(const s of t){const t=e.querySelector(s);if(t)return this.log(`Found Shorts actions with selector: ${s}`),t}for(const e of t){const t=document.querySelector(`ytd-shorts ${e}, ytd-reel-video-renderer ${e}`);if(t)return this.log(`Found Shorts actions at document level: ${e}`),t}return null}injectIntoVisibleShort(){const e=this.getShortsVideoId();if(!e)return;if(document.querySelector(`.${s}[data-video-id="${e}"]`))return;const t=document.querySelector("ytd-shorts #actions, ytd-reel-video-renderer[is-active] #actions, #shorts-player #actions");if(t&&!t.querySelector(`.${s}`)){const s=t.closest("ytd-reel-video-renderer, ytd-shorts")||document.body;this.injectShortsButton(t,e,s)}}injectShortsButton(e,t,r){const o=r.querySelector(`.${s}[data-video-id="${t}"]`);o&&o.remove(),this.shortsButtonStates.has(t)||this.shortsButtonStates.set(t,"idle");const n=document.createElement("div");n.className=`${s}`,n.setAttribute("data-video-id",t),n.style.cssText="\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      margin-bottom: 16px;\n      cursor: pointer;\n    ";const a=document.createElement("button");a.className="safeplay-shorts-action-button";const l=this.shortsButtonStates.get(t)||"idle",d=i[l];a.style.cssText=`\n      width: 48px;\n      height: 48px;\n      border-radius: 50%;\n      border: none;\n      background: ${d.bg};\n      color: white;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n      position: relative;\n      overflow: hidden;\n    `;const c=document.createElement("div");c.className="safeplay-shorts-icon",c.style.cssText="display: flex; align-items: center; justify-content: center; position: relative; z-index: 1;",c.innerHTML=this.getShortsIconSVG(l),a.appendChild(c);const h=document.createElement("span");h.className="safeplay-shorts-label",h.style.cssText='\n      color: white;\n      font-size: 12px;\n      margin-top: 4px;\n      text-shadow: 0 1px 2px rgba(0,0,0,0.5);\n      font-family: "Roboto", "Arial", sans-serif;\n    ',h.textContent="filtering"===l?"Censored":"idle"===l?"SafePlay":d.text,a.addEventListener("mouseenter",()=>{const e=this.shortsButtonStates.get(t)||"idle",s=i[e];a.style.background=s.hoverBg,a.style.transform="scale(1.1)"}),a.addEventListener("mouseleave",()=>{const e=this.shortsButtonStates.get(t)||"idle",s=i[e];a.style.background=s.bg,a.style.transform="scale(1)"}),a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const s=this.shortsButtonStates.get(t)||"idle";"idle"===s||"error"===s?(this.currentVideoId=t,this.options.onButtonClick(t)):"filtering"!==s&&"paused"!==s||(this.currentVideoId=t,this.options.onToggleFilter&&this.options.onToggleFilter())}),n.appendChild(a),n.appendChild(h),e.insertBefore(n,e.firstChild),this.log(`Injected SafePlay Shorts button for video: ${t}`)}getShortsIconSVG(e){switch(e){case"connecting":case"downloading":case"transcribing":case"processing":return'\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="safeplay-spinner">\n            <style>.safeplay-spinner { animation: safeplay-spin 1s linear infinite; } @keyframes safeplay-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>\n            <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>\n            <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/>\n          </svg>\n        ';case"filtering":return'\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>\n          </svg>\n        ';case"paused":return'\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-1 14H9V9h2v6zm4 0h-2V9h2v6z"/>\n          </svg>\n        ';case"error":return'\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>\n          </svg>\n        ';default:return'\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>\n          </svg>\n        '}}setupShortsScrollObserver(){this.shortsScrollObserver&&this.shortsScrollObserver.disconnect(),this.shortsScrollObserver=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target,i=this.getShortsVideoIdFromRenderer(t);i&&(this.log(`Short scrolled into view: ${i}`),this.currentVideoId=i,t.querySelector(`.${s}`)||this.attemptShortsInjection())}})},{threshold:.5}),this.observeShortsRenderers()}observeShortsRenderers(){this.shortsScrollObserver&&document.querySelectorAll("ytd-reel-video-renderer, ytd-shorts").forEach(e=>{this.shortsScrollObserver.observe(e)})}findSubscribeButton(){const e=["#subscribe-button.ytd-watch-metadata","ytd-watch-metadata #subscribe-button","#owner #subscribe-button","#subscribe-button"];for(const t of e){const e=document.querySelector(t);if(e)return this.log(`Found subscribe button with selector: ${t}`),e}return null}isButtonPresent(){return null!==document.querySelector(`.${t}`)}injectButton(s,r){const o=document.querySelector(`.${t}`);o&&o.remove(),this.currentState="idle";const n=document.createElement("div");n.className=`${t} style-scope ytd-watch-metadata`,n.style.cssText="display: inline-flex; align-items: center; margin-left: 8px;",n.setAttribute(e,"true");const a=document.createElement("button");a.className="safeplay-main-button yt-spec-button-shape-next yt-spec-button-shape-next--tonal yt-spec-button-shape-next--mono yt-spec-button-shape-next--size-m yt-spec-button-shape-next--icon-leading",a.title="Filter profanity with SafePlay",a.setAttribute("aria-label","SafePlay Filter"),a.setAttribute("data-video-id",r);const l=i.idle;a.style.cssText=`\n      border: none;\n      background: ${l.bg};\n      color: #ffffff;\n      border-radius: 18px;\n      padding: 0 16px;\n      height: 36px;\n      font-family: "Roboto", "Arial", sans-serif;\n      font-size: 14px;\n      font-weight: 500;\n      line-height: 36px;\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      gap: 6px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      min-width: 120px;\n      box-shadow: 0 2px 4px ${l.shadow};\n      position: relative;\n      overflow: hidden;\n    `;const d=document.createElement("div");d.className="safeplay-water-fill",d.style.cssText="\n      position: absolute;\n      bottom: 0;\n      left: 0;\n      right: 0;\n      height: 0%;\n      background: linear-gradient(to top, #3b82f6, #60a5fa);\n      transition: height 0.3s ease-out;\n      overflow: hidden;\n      border-radius: 18px;\n      z-index: 0;\n    ";const c=document.createElement("div");c.className="safeplay-icon",c.style.cssText="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; flex-shrink: 0; position: relative; z-index: 1;",c.innerHTML=this.getIconSVG("idle");const h=document.createElement("span");h.className="safeplay-text",h.style.cssText="color: currentColor; font-size: 14px; font-weight: 500; line-height: 1; white-space: nowrap; position: relative; z-index: 1;",h.textContent=l.text,a.appendChild(d),a.appendChild(c),a.appendChild(h),a.addEventListener("mouseenter",()=>{const e=i[this.currentState];a.style.background=e.hoverBg,a.style.boxShadow=`0 4px 8px ${e.shadow}`,a.style.transform="translateY(-1px)"}),a.addEventListener("mouseleave",()=>{const e=i[this.currentState];a.style.background=e.bg,a.style.boxShadow=`0 2px 4px ${e.shadow}`,a.style.transform="translateY(0)"}),a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),"idle"===this.currentState||"error"===this.currentState?this.options.onButtonClick(r):"filtering"!==this.currentState&&"paused"!==this.currentState||this.options.onToggleFilter&&this.options.onToggleFilter()}),n.appendChild(a),s.parentElement?.insertBefore(n,s.nextSibling),this.log(`Injected SafePlay button for video: ${r}`)}getIconSVG(e){switch(e){case"connecting":case"downloading":case"transcribing":case"processing":return'\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="safeplay-spinner">\n            <style>.safeplay-spinner { animation: safeplay-spin 1s linear infinite; } @keyframes safeplay-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>\n            <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>\n            <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/>\n          </svg>\n        ';case"filtering":return'\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>\n          </svg>\n        ';case"paused":return'\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-1 14H9V9h2v6zm4 0h-2V9h2v6z"/>\n          </svg>\n        ';case"error":return'\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>\n          </svg>\n        ';default:return'\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>\n          </svg>\n        '}}updateButtonState(e){this.updateWatchPageButton(e);const t=e.videoId||this.currentVideoId;t&&this.updateShortsButton(t,e)}updateWatchPageButton(e){const s=document.querySelector(`.${t}`);if(!s)return;const r=s.querySelector(".safeplay-main-button"),o=s.querySelector(".safeplay-text"),n=s.querySelector(".safeplay-icon"),a=s.querySelector(".safeplay-water-fill");if(!r||!o||!n)return;this.currentState=e.state;const l=i[e.state];r.style.background=l.bg,r.style.boxShadow=`0 2px 4px ${l.shadow}`,n.innerHTML=this.getIconSVG(e.state);let d=e.text||l.text;switch(void 0!==e.progress&&e.progress>0&&("downloading"!==e.state&&"transcribing"!==e.state&&"processing"!==e.state||(d=`${l.text.replace("...","")} ${Math.round(e.progress)}%`)),"filtering"===e.state&&void 0!==e.intervalCount&&(d=`Censored (${e.intervalCount})`),o.textContent=d,a&&(l.useWater&&void 0!==e.progress&&e.progress>0?(a.style.height=`${e.progress}%`,a.classList.remove("safeplay-water-full")):"filtering"===e.state?(a.style.height="100%",a.classList.add("safeplay-water-full")):(e.state,a.style.height="0%",a.classList.remove("safeplay-water-full"))),"idle"===e.state||"error"===e.state||"filtering"===e.state||"paused"===e.state?r.style.cursor="pointer":r.style.cursor="default",e.state){case"connecting":r.title="Connecting to SafePlay service...";break;case"downloading":r.title="Filtering: Downloading audio"+(e.progress?` (${Math.round(e.progress)}%)`:"...");break;case"transcribing":r.title="Filtering: Transcribing audio"+(e.progress?` (${Math.round(e.progress)}%)`:"...");break;case"processing":r.title="Filtering: Processing transcript...";break;case"filtering":r.title=`Censored${e.intervalCount?` - ${e.intervalCount} words filtered`:""} - Click to disable`;break;case"paused":r.title="Filter paused - Click to re-enable";break;case"error":r.title=e.error||"An error occurred. Click to retry.";break;default:r.title="Click to filter profanity with SafePlay"}this.log(`Button state updated to: ${e.state}`,e)}setButtonState(e,t,s){this.updateButtonState({state:e,text:t||"",progress:s})}updateShortsButton(e,t){const r=document.querySelector(`.${s}[data-video-id="${e}"]`);if(!r)return;const o=r.querySelector(".safeplay-shorts-action-button"),n=r.querySelector(".safeplay-shorts-icon"),a=r.querySelector(".safeplay-shorts-label");if(!o||!n)return;this.shortsButtonStates.set(e,t.state);const l=i[t.state];if(o.style.background=l.bg,n.innerHTML=this.getShortsIconSVG(t.state),a){let e="idle"===t.state?"SafePlay":l.text;"filtering"===t.state&&void 0!==t.intervalCount?e=`${t.intervalCount}`:"filtering"===t.state&&(e="Censored"),void 0!==t.progress&&t.progress>0&&("downloading"!==t.state&&"transcribing"!==t.state&&"processing"!==t.state||(e=`${Math.round(t.progress)}%`)),a.textContent=e}"idle"===t.state||"error"===t.state||"filtering"===t.state||"paused"===t.state?o.style.cursor="pointer":o.style.cursor="default",this.log(`Shorts button state updated to: ${t.state} for ${e}`)}setupMutationObserver(){this.observer=new MutationObserver(e=>{for(const t of e)if("childList"===t.type&&t.addedNodes.length>0)for(const e of t.addedNodes)if(e instanceof HTMLElement){if("subscribe-button"===e.id||e.querySelector?.("#subscribe-button")||e.closest?.("ytd-watch-metadata"))return this.log("Subscribe button area changed, re-injecting"),void this.attemptInjection();if("YTD-REEL-VIDEO-RENDERER"===e.tagName||"YTD-SHORTS"===e.tagName||e.querySelector?.("ytd-reel-video-renderer"))return this.log("Shorts renderer added, attempting injection"),this.observeShortsRenderers(),void this.attemptShortsInjection();if(("actions"===e.id||e.querySelector?.("#actions"))&&this.isShortsPage())return this.log("Shorts actions container added"),void this.attemptShortsInjection()}}),this.observer.observe(document.body,{childList:!0,subtree:!0})}setupNavigationListener(){const e=history.pushState,t=history.replaceState;history.pushState=(...t)=>{e.apply(history,t),this.onNavigation()},history.replaceState=(...e)=>{t.apply(history,e),this.onNavigation()},window.addEventListener("popstate",()=>{this.onNavigation()}),document.addEventListener("yt-navigate-finish",()=>{this.onNavigation()}),document.addEventListener("yt-page-data-updated",()=>{this.log("Page data updated"),this.onNavigation()})}onNavigation(){this.log("Navigation detected"),this.currentVideoId=null,this.currentState="idle",this.injectionAttempts=0,null!==this.retryInterval&&(clearInterval(this.retryInterval),this.retryInterval=null),setTimeout(()=>{this.attemptInjection()},300)}getCurrentVideoId(){return this.currentVideoId}log(...e){this.options.debug&&console.log("[SafePlay Injector]",...e)}}const o=.08;class n{constructor(e){this.video=null,this.muteIntervals=[],this.filterMode="mute",this.isActive=!1,this.checkIntervalId=null,this.isMuted=!1,this.isFading=!1,this.audioContext=null,this.sourceNode=null,this.gainNode=null,this.bleepOscillator=null,this.bleepGain=null,this.currentGainTarget=1,this.BLEEP_FREQUENCY=1e3,this.BLEEP_VOLUME=.35,this.BLEEP_ATTACK=.008,this.BLEEP_RELEASE=.025,this.onMuteStart=e?.onMuteStart,this.onMuteEnd=e?.onMuteEnd}initialize(e,t,s="mute"){this.video=e,this.muteIntervals=t,this.filterMode=s,this.muteIntervals.sort((e,t)=>e.start-t.start),this.initializeAudioContext()}initializeAudioContext(){if(this.video&&!this.audioContext)try{this.audioContext=new AudioContext,this.sourceNode=this.audioContext.createMediaElementSource(this.video),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=1,this.sourceNode.connect(this.gainNode),this.gainNode.connect(this.audioContext.destination),"bleep"===this.filterMode&&(this.bleepGain=this.audioContext.createGain(),this.bleepGain.gain.value=0,this.bleepGain.connect(this.audioContext.destination)),console.log("[SafePlay] Audio context initialized with smooth fading")}catch(e){console.error("[SafePlay] Failed to initialize audio context:",e)}}start(){!this.isActive&&this.video&&(this.isActive=!0,"suspended"===this.audioContext?.state&&this.audioContext.resume(),this.checkIntervalId=window.setInterval(()=>{this.checkCurrentTime()},5),console.log("[SafePlay] Audio filter started with",this.muteIntervals.length,"intervals (smooth fading enabled)"))}stop(){this.isActive&&(this.isActive=!1,null!==this.checkIntervalId&&(clearInterval(this.checkIntervalId),this.checkIntervalId=null),this.fadeToVolume(1),this.bleepOscillator&&(this.bleepOscillator.stop(),this.bleepOscillator=null),console.log("[SafePlay] Audio filter stopped"))}destroy(){this.stop(),this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null)}checkCurrentTime(){if(!this.video||!this.isActive)return;const e=this.video.currentTime,t=this.findActiveInterval(e),s=this.findApproachingInterval(e);t?this.isMuted||this.startMute(t):s?this.isMuted||this.isFading||this.startFadeOut(s):this.isMuted&&this.endMute()}findActiveInterval(e){for(const t of this.muteIntervals){if(e>=t.start&&e<=t.end)return t;if(t.start>e+o)break}return null}findApproachingInterval(e){for(const t of this.muteIntervals){if(e>=t.start-o&&e<t.start)return t;if(t.start>e+o)break}return null}startFadeOut(e){this.isFading=!0,this.fadeToVolume(0,()=>{this.isFading=!1,this.isMuted=!0,this.onMuteStart&&this.onMuteStart(e)}),"bleep"===this.filterMode&&this.startBleep()}startMute(e){this.isMuted=!0,this.fadeToVolume(0),"bleep"===this.filterMode&&this.startBleep(),this.onMuteStart&&this.onMuteStart(e)}endMute(){this.isMuted=!1,this.fadeToVolume(1),"bleep"===this.filterMode&&this.stopBleep(),this.onMuteEnd&&this.onMuteEnd()}fadeToVolume(e,t){if(this.currentGainTarget!==e)if(this.currentGainTarget=e,this.gainNode&&this.audioContext){const s=this.audioContext.currentTime;this.gainNode.gain.cancelScheduledValues(s),this.gainNode.gain.setValueAtTime(this.gainNode.gain.value,s),this.gainNode.gain.linearRampToValueAtTime(e,s+.05),t&&setTimeout(t,50)}else this.video&&(this.video.muted=0===e),t?.();else t?.()}startBleep(){if(!this.audioContext||!this.bleepGain)return;"suspended"===this.audioContext.state&&this.audioContext.resume(),this.bleepOscillator=this.audioContext.createOscillator(),this.bleepOscillator.type="sine",this.bleepOscillator.frequency.value=this.BLEEP_FREQUENCY;const e=this.audioContext.createOscillator();e.type="sine",e.frequency.value=1.001*this.BLEEP_FREQUENCY;const t=this.audioContext.createGain();t.gain.value=.5,this.bleepOscillator.connect(this.bleepGain),e.connect(t),t.connect(this.bleepGain);const s=this.audioContext.currentTime;this.bleepGain.gain.setValueAtTime(0,s),this.bleepGain.gain.linearRampToValueAtTime(this.BLEEP_VOLUME,s+this.BLEEP_ATTACK),this.bleepOscillator.start(s),e.start(s),this.bleepOscillator._secondOscillator=e,this.bleepOscillator._mixer=t}stopBleep(){if(!this.audioContext||!this.bleepGain||!this.bleepOscillator)return;const e=this.audioContext.currentTime;this.bleepGain.gain.setValueAtTime(this.bleepGain.gain.value,e),this.bleepGain.gain.linearRampToValueAtTime(0,e+this.BLEEP_RELEASE);const t=this.bleepOscillator,s=t._secondOscillator,i=t._mixer;setTimeout(()=>{try{t.stop(),t.disconnect(),s&&(s.stop(),s.disconnect()),i&&i.disconnect()}catch(e){}},1e3*this.BLEEP_RELEASE+10),this.bleepOscillator=null}updateIntervals(e){this.muteIntervals=e,this.muteIntervals.sort((e,t)=>e.start-t.start)}updateMode(e){this.filterMode=e,"bleep"===e&&this.audioContext&&!this.bleepGain&&(this.bleepGain=this.audioContext.createGain(),this.bleepGain.gain.value=0,this.bleepGain.connect(this.audioContext.destination))}getState(){return{isActive:this.isActive,isMuted:this.isMuted,intervalCount:this.muteIntervals.length,filterMode:this.filterMode}}isFiltering(){return this.isActive}getIntervals(){return[...this.muteIntervals]}}const a=new Map([{word:"jesus",severity:"religious"},{word:"jesus christ",severity:"religious"},{word:"jesus fucking christ",severity:"religious"},{word:"christ",severity:"religious"},{word:"christ almighty",severity:"religious"},{word:"god",severity:"religious"},{word:"oh my god",severity:"religious"},{word:"omg",severity:"religious"},{word:"oh god",severity:"religious"},{word:"my god",severity:"religious"},{word:"for gods sake",severity:"religious"},{word:"for god's sake",severity:"religious"},{word:"god almighty",severity:"religious"},{word:"swear to god",severity:"religious"},{word:"i swear to god",severity:"religious"},{word:"goddamn",severity:"religious"},{word:"goddamned",severity:"religious"},{word:"goddamnit",severity:"religious"},{word:"goddammit",severity:"religious"},{word:"goddamit",severity:"religious"},{word:"goddam",severity:"religious"},{word:"goddams",severity:"religious"},{word:"god damn",severity:"religious"},{word:"god damned",severity:"religious"},{word:"god damnit",severity:"religious"},{word:"god dammit",severity:"religious"},{word:"god damn it",severity:"religious"},{word:"god-damn",severity:"religious"},{word:"god-damned",severity:"religious"},{word:"god-damnit",severity:"religious"},{word:"god-dammit",severity:"religious"},{word:"godd*mn",severity:"religious"},{word:"g*ddamn",severity:"religious"},{word:"gd",severity:"religious"},{word:"gdamn",severity:"religious"},{word:"gotdamn",severity:"religious"},{word:"gotdam",severity:"religious"},{word:"got damn",severity:"religious"},{word:"got dam",severity:"religious"},{word:"gahdamn",severity:"religious"},{word:"gawddamn",severity:"religious"},{word:"gahdam",severity:"religious"},{word:"lord",severity:"religious"},{word:"oh lord",severity:"religious"},{word:"dear lord",severity:"religious"},{word:"good lord",severity:"religious"},{word:"lord almighty",severity:"religious"},{word:"lord have mercy",severity:"religious"},{word:"lordy",severity:"religious"},{word:"lawdy",severity:"religious"},{word:"lawd",severity:"religious"},{word:"oh lawd",severity:"religious"},{word:"holy",severity:"religious"},{word:"holy shit",severity:"religious"},{word:"holy crap",severity:"religious"},{word:"holy hell",severity:"religious"},{word:"holy fuck",severity:"religious"},{word:"holy cow",severity:"religious"},{word:"holy smokes",severity:"religious"},{word:"holy moly",severity:"religious"},{word:"holy mother",severity:"religious"},{word:"holy mother of god",severity:"religious"},{word:"for christ's sake",severity:"religious"},{word:"for christs sake",severity:"religious"},{word:"chrissake",severity:"religious"},{word:"crissake",severity:"religious"},{word:"fuck",severity:"severe"},{word:"fucking",severity:"severe"},{word:"fucked",severity:"severe"},{word:"fucker",severity:"severe"},{word:"fuckers",severity:"severe"},{word:"fucks",severity:"severe"},{word:"motherfucker",severity:"severe"},{word:"motherfucking",severity:"severe"},{word:"motherfuckers",severity:"severe"},{word:"cunt",severity:"severe"},{word:"cunts",severity:"severe"},{word:"nigger",severity:"severe"},{word:"niggers",severity:"severe"},{word:"nigga",severity:"severe"},{word:"niggas",severity:"severe"},{word:"faggot",severity:"severe"},{word:"faggots",severity:"severe"},{word:"fag",severity:"severe"},{word:"fags",severity:"severe"},{word:"retard",severity:"severe"},{word:"retarded",severity:"severe"},{word:"retards",severity:"severe"},{word:"shit",severity:"moderate"},{word:"shits",severity:"moderate"},{word:"shitty",severity:"moderate"},{word:"bullshit",severity:"moderate"},{word:"horseshit",severity:"moderate"},{word:"shithead",severity:"moderate"},{word:"shitheads",severity:"moderate"},{word:"ass",severity:"moderate"},{word:"asses",severity:"moderate"},{word:"asshole",severity:"moderate"},{word:"assholes",severity:"moderate"},{word:"bastard",severity:"moderate"},{word:"bastards",severity:"moderate"},{word:"bitch",severity:"moderate"},{word:"bitches",severity:"moderate"},{word:"bitchy",severity:"moderate"},{word:"cock",severity:"moderate"},{word:"cocks",severity:"moderate"},{word:"cocksucker",severity:"moderate"},{word:"cocksuckers",severity:"moderate"},{word:"dick",severity:"moderate"},{word:"dicks",severity:"moderate"},{word:"dickhead",severity:"moderate"},{word:"dickheads",severity:"moderate"},{word:"pussy",severity:"moderate"},{word:"pussies",severity:"moderate"},{word:"prick",severity:"moderate"},{word:"pricks",severity:"moderate"},{word:"slut",severity:"moderate"},{word:"sluts",severity:"moderate"},{word:"slutty",severity:"moderate"},{word:"whore",severity:"moderate"},{word:"whores",severity:"moderate"},{word:"twat",severity:"moderate"},{word:"twats",severity:"moderate"},{word:"wanker",severity:"moderate"},{word:"wankers",severity:"moderate"},{word:"bollocks",severity:"moderate"},{word:"damn",severity:"mild"},{word:"damned",severity:"mild"},{word:"dammit",severity:"mild"},{word:"damnit",severity:"mild"},{word:"hell",severity:"mild"},{word:"crap",severity:"mild"},{word:"crappy",severity:"mild"},{word:"piss",severity:"mild"},{word:"pissed",severity:"mild"},{word:"pissing",severity:"mild"},{word:"suck",severity:"mild"},{word:"sucks",severity:"mild"},{word:"sucked",severity:"mild"},{word:"balls",severity:"mild"},{word:"butt",severity:"mild"},{word:"butthole",severity:"mild"},{word:"screw",severity:"mild"},{word:"screwed",severity:"mild"},{word:"douche",severity:"mild"},{word:"douchebag",severity:"mild"},{word:"douchebags",severity:"mild"}].map(e=>[e.word.toLowerCase(),e.severity])),l=new Set(["class","classes","classic","classical","classics","classify","classified","classification","classmate","classmates","classroom","classrooms","classy","grass","grassy","grassland","grasshopper","pass","passed","passes","passing","passable","passage","passages","passenger","passengers","passport","passports","password","passwords","bypass","bypassed","bypasses","bypassing","compass","compasses","bass","bassist","bassline","mass","masses","massive","massively","massacre","brass","brassy","glass","glasses","glassy","glassware","sass","sassy","sassafras","lass","lassie","lasso","cassette","cassettes","casserole","assassin","assassins","assassinate","assassination","embassy","embassies","ambassador","ambassadors","harass","harassed","harassing","harassment","amass","amassed","amassing","morass","trespass","trespassed","trespassing","trespasser","carcass","carcasses","canvas","canvases","canvass","canvassed","molasses","assume","assumed","assumes","assuming","assumption","assumptions","assure","assured","assures","assuring","assurance","assess","assessed","assesses","assessing","assessment","assessments","asset","assets","assign","assigned","assigns","assigning","assignment","assignments","assist","assisted","assists","assisting","assistant","assistants","assistance","associate","associated","associates","associating","association","associations","assort","assorted","assortment","hello","hellos","shell","shells","shelled","shelling","shellfish","bombshell","nutshell","eggshell","seashell","clamshell","dwell","dwells","dwelled","dwelling","dwellings","swell","swells","swelled","swelling","swollen","well","wells","wellness","farewell","stairwell","spell","spells","spelled","spelling","misspell","misspelled","smell","smells","smelled","smelling","smelly","bell","bells","doorbell","bellhop","bluebell","dumbbell","barbell","cell","cells","cellular","cellar","cellars","fell","fella","fellas","fellow","fellows","fellowship","jell","jelly","jellyfish","tell","tells","telling","teller","storytelling","foretell","sell","sells","selling","seller","sellers","bestseller","bestselling","yell","yells","yelled","yelling","propel","propelled","propeller","propelling","excel","excels","excelled","excelling","excellent","excellence","expel","expels","expelled","expelling","compel","compels","compelled","compelling","repel","repels","repelled","repelling","repellent","rebellion","rebellious","rebel","rebels","rebelled","hellenic","hellenistic","amsterdam","macadam","madame","madam","peacock","peacocks","cockpit","cockpits","cocktail","cocktails","cockatoo","cockatoos","cockerel","hancock","hitchcock","babcock","woodcock","stopcock","weathercock","dickens","benedict","benediction","predict","predicts","predicted","predicting","prediction","predictions","addict","addicts","addicted","addicting","addiction","addictions","addictive","verdict","verdicts","indict","indicts","indicted","indicting","indictment","contradict","contradicts","contradicted","contradicting","contradiction","dictionary","dictionaries","diction","dictate","dictates","dictated","dictating","dictation","dictator","edict","edicts","jurisdiction","scrap","scraps","scrapped","scrapping","scrappy","scrapbook","scrapyard","mississippi","title","titles","titled","titling","subtitle","subtitles","subtitled","entitle","entitled","entitles","entitling","entitlement","constitution","constitutional","constitutions","institution","institutional","institutions","restitution","stitute","substitute","substitutes","substituted","substitution","institute","institutes","instituted","institution","prostitute","prostitutes","prostitution","titan","titans","titanic","appetite","appetites","appetizer","appetizers","competition","competitions","competitive","competitor","competitors","petition","petitions","petitioned","petitioning","repetition","repetitions","repetitive","partition","partitions","partitioned","quantity","quantities","quantitative","identity","identities","entity","entities","utility","utilities","fertility","infertility","document","documents","documented","documenting","documentation","documentary","circumstance","circumstances","circumstantial","circumference","accumulate","accumulated","accumulates","accumulating","accumulation","cucumber","cucumbers","incumbent","succumb","succumbed","succumbing","faggot","sextant","sextet","sextuple","shoe","shoes","shoed","shoeing","horseshoe","hoe","hoes","hoeing","whole","wholesome","wholesale","wholly","honest","honestly","honesty","dishonest","honor","honors","honored","honoring","honorable","honorary","dishonor","hope","hopes","hoped","hoping","hopeful","hopefully","hopeless","home","homes","homed","homing","homeless","homemade","hometown","homework","horse","horses","horseback","horsepower","hotel","hotels","horizon","horizons","horizontal","hour","hours","hourly","house","houses","housed","housing","household","housewife","housekeeper","night","nights","nightly","nighttime","nightmare","nightmares","nightclub","tonight","overnight","midnight","goodnight","fortnight","knight","knights","knighthood","ignite","ignites","ignited","igniting","ignition","insignificant","significance","significant","significantly","nude","nudes","nudity","analog","analogue","analogous","analogy","analogies","analysis","analyses","analyst","analysts","analytical","analyze","analyzed","banal","canal","canals","final","finals","finally","finalist","finalize","finalized","journal","journals","journalism","journalist","journalists","national","nationally","international","internationally","personal","personally","personality","personalities","professional","professionally","professionals","regional","regionally","original","originally","originals","criminal","criminally","criminals","terminal","terminals","cardinal","cardinals","signal","signals","signaled","signaling","minute","minutes","minutely","peanut","peanuts","coconut","coconuts","chestnut","chestnuts","walnut","walnuts","doughnut","doughnuts","donut","donuts","nutmeg","nutrition","nutritious","nutritional","nutrient","nutrients","godfather","godfathers","godmother","godmothers","godchild","godchildren","godson","godsons","goddaughter","goddaughters","godly","godliness","ungodly","goddess","goddesses","godspeed","godsend","landlord","landlords","landlady","warlord","warlords","overlord","overlords","lordship","holiday","holidays","wholly","christen","christened","christening","christian","christians","christianity","christmas","christmastime","christopher","hellfire","hellbound"]),d={0:"o",1:"i",3:"e",4:"a",5:"s",7:"t",8:"b","@":"a",$:"s","!":"i","*":"","#":"","+":"t","(":"c","<":"c","|":"i",ph:"f",ck:"k"},c=[["ph","f"],["ck","k"],["kk","ck"],["cc","ck"],["xx","x"]];function h(e){return l.has(e.toLowerCase())}function u(e){const t=e.toLowerCase().trim();if(l.has(t))return[];const s=[],i=function(e){let t=e.toLowerCase();for(const[e,s]of c)t=t.split(e).join(s);let s="";for(const e of t)s+=d[e]??e;return s=s.replace(/(.)\1{2,}/g,"$1$1"),s}(t),r=[t];i!==t&&r.push(i);for(const e of r)for(const[t,i]of a){let r=e.indexOf(t);for(;-1!==r;){const o=e===t,n=!(0!==r&&/[a-z]/.test(e[r-1])||r+t.length!==e.length&&/[a-z]/.test(e[r+t.length]));(o||n)&&s.push({word:t,severity:i,startIndex:r,endIndex:r+t.length}),r=e.indexOf(t,r+1)}}s.sort((e,t)=>e.startIndex-t.startIndex);const o=[];for(const e of s){const t=o[o.length-1];!t||e.startIndex>=t.endIndex?o.push(e):e.endIndex-e.startIndex>t.endIndex-t.startIndex&&(o[o.length-1]=e)}const n=new Set;return o.filter(e=>{const t=`${e.word}-${e.startIndex}`;return!n.has(t)&&(n.add(t),!0)})}class g{constructor(e){this.preferences=e,this.customBlacklistMap=new Map(e.customBlacklist.map(e=>[e.toLowerCase(),"severe"])),this.customWhitelistSet=new Set(e.customWhitelist.map(e=>e.toLowerCase()))}shouldFilterSeverity(e){return this.preferences.severityLevels[e]}shouldFilterWord(e,t){const s=e.toLowerCase();return!this.customWhitelistSet.has(s)&&(!!this.customBlacklistMap.has(s)||this.shouldFilterSeverity(t))}getWordSeverity(e){const t=e.toLowerCase();return this.customBlacklistMap.has(t)?this.customBlacklistMap.get(t):h(t)?null:a.get(t)||null}getCharacterLevelTiming(e,t,s){let i=e.start_time,r=e.end_time;if(e.characters&&e.characters.length>0){const o=e.characters[t],n=e.characters[Math.min(s-1,e.characters.length-1)];o&&(i=o.start),n&&(r=n.end),console.log(`[SafePlay Parser] Character timing: "${e.text.substring(t,s)}" chars[${t}..${s-1}] -> ${i.toFixed(3)}s - ${r.toFixed(3)}s`)}return{startTime:i,endTime:r}}findProfanityMatches(e){const t=[];for(let s=0;s<e.length;s++){const i=e[s],r=i.text.toLowerCase().trim(),o=this.getWordSeverity(r);if(o&&this.shouldFilterWord(r,o)){const{startTime:e,endTime:r}=this.getCharacterLevelTiming(i,0,i.text.length);t.push({segmentIndex:s,word:i.text,severity:o,startTime:e,endTime:r,isPartialMatch:!1});continue}const n=u(r);for(const[e]of this.customBlacklistMap){const t=r.indexOf(e);-1!==t&&n.push({word:e,severity:"severe",startIndex:t,endIndex:t+e.length})}for(const e of n){if(!this.shouldFilterWord(e.word,e.severity))continue;const{startTime:r,endTime:o}=this.getCharacterLevelTiming(i,e.startIndex,e.endIndex);t.push({segmentIndex:s,word:e.word,severity:e.severity,startTime:r,endTime:o,isPartialMatch:!0,matchedPortion:i.text.substring(e.startIndex,e.endIndex)})}}return t}createMuteIntervals(e){const t=(this.preferences.paddingBeforeMs??this.preferences.paddingMs)/1e3,s=(this.preferences.paddingAfterMs??this.preferences.paddingMs)/1e3;return e.map(e=>{const i={start:Math.max(0,e.startTime-t),end:e.endTime+s,word:e.word,severity:e.severity};return console.log(`[SafePlay Parser] Mute interval: "${e.word}" ${i.start.toFixed(3)}s - ${i.end.toFixed(3)}s (padding: -${1e3*t}ms / +${1e3*s}ms)`),i})}mergeIntervals(e){if(0===e.length)return[];const t=[...e].sort((e,t)=>e.start-t.start),s=this.preferences.mergeThresholdMs/1e3,i=[t[0]];for(let e=1;e<t.length;e++){const r=t[e],o=i[i.length-1];r.start<=o.end+s?(o.end=Math.max(o.end,r.end),this.severityRank(r.severity)>this.severityRank(o.severity)&&(o.severity=r.severity),o.word.includes(r.word)||(o.word=`${o.word}, ${r.word}`)):i.push({...r})}return i}severityRank(e){return{mild:1,religious:2,moderate:3,severe:4}[e]}parse(e){const t=this.findProfanityMatches(e.segments),s=this.createMuteIntervals(t);return this.mergeIntervals(s)}}function p(e,t){return new g(t).parse(e)}class v{constructor(e={}){this.youtubeId=null,this.video=null,this.transcript=null,this.muteIntervals=[],this.preferences=null,this.status="idle",this.progress=0,this.statusOverlay=null,this.options=e,this.audioFilter=new n({onMuteStart:e=>this.onMuteStart(e),onMuteEnd:()=>this.onMuteEnd()})}async initialize(e,t){this.youtubeId=e,this.preferences=t,this.updateStatus("idle"),this.video=this.findVideoElement(),this.video||(this.log("Video element not found, waiting..."),await this.waitForVideo()),this.video?this.log("Video controller initialized for:",e):this.updateStatus("error",0,"Could not find video element")}async applyFilter(){if(this.youtubeId&&this.video&&this.preferences)if(this.preferences.enabled)try{this.updateStatus("loading");const e=await chrome.runtime.sendMessage({type:"GET_FILTER",payload:{youtubeId:this.youtubeId}});if(!e.success)throw new Error(e.error||"Failed to get transcript");if("processing"===e.data.status)return void this.updateStatus("processing",e.data.progress||0);this.transcript=e.data.transcript,await this.processTranscript()}catch(e){const t=e instanceof Error?e.message:"Unknown error";this.updateStatus("error",0,t),this.log("Filter error:",e)}else this.updateStatus("disabled");else this.log("Cannot apply filter: missing required data")}async processTranscript(){if(this.transcript&&this.preferences&&this.video){if(this.muteIntervals=p(this.transcript,this.preferences),this.log("Found",this.muteIntervals.length,"mute intervals"),0===this.muteIntervals.length)return this.updateStatus("active"),void this.log("No profanity detected in video");this.audioFilter.initialize(this.video,this.muteIntervals,this.preferences.filterMode),this.audioFilter.start(),this.updateStatus("active"),this.showStatusOverlay()}}onTranscriptReceived(e){this.transcript=e,this.processTranscript()}onProcessingProgress(e){this.updateStatus("processing",e)}onProcessingError(e){this.updateStatus("error",0,e)}stop(){this.audioFilter.stop(),this.hideStatusOverlay(),this.updateStatus("idle")}resume(){this.video&&0!==this.muteIntervals.length&&(this.audioFilter.start(),this.updateStatus("active"),this.showStatusOverlay())}updatePreferences(e){this.preferences=e,e.enabled?this.transcript&&(this.muteIntervals=p(this.transcript,e),this.audioFilter.updateIntervals(this.muteIntervals),this.audioFilter.updateMode(e.filterMode)):this.stop()}getState(){const e=this.audioFilter.getState();return{status:this.status,progress:this.progress,error:this.error,intervalCount:e.intervalCount,currentlyMuting:e.isMuted}}getMuteIntervals(){return this.muteIntervals}findVideoElement(){const e=["video.html5-main-video","video.video-stream","#movie_player video","ytd-player video","video"];for(const t of e){const e=document.querySelector(t);if(e&&e.src)return e}return null}waitForVideo(e=1e4){return new Promise(t=>{const s=Date.now(),i=()=>{this.video=this.findVideoElement(),this.video?t(this.video):Date.now()-s>e?t(null):requestAnimationFrame(i)};i()})}updateStatus(e,t=0,s){this.status=e,this.progress=t,this.error=s,this.options.onStateChange&&this.options.onStateChange(this.getState())}showStatusOverlay(){if(this.statusOverlay)return;const e=document.querySelector("#movie_player");e&&(this.statusOverlay=document.createElement("div"),this.statusOverlay.className="safeplay-status-overlay",this.statusOverlay.innerHTML='\n      <div class="safeplay-status-badge">\n        <svg class="safeplay-status-icon" viewBox="0 0 24 24" fill="currentColor">\n          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>\n        </svg>\n        <span>SafePlay Active</span>\n      </div>\n    ',e.appendChild(this.statusOverlay),setTimeout(()=>{this.statusOverlay?.classList.add("safeplay-status-hidden")},3e3))}hideStatusOverlay(){this.statusOverlay&&(this.statusOverlay.remove(),this.statusOverlay=null)}onMuteStart(e){this.log("Muting:",e.word),this.notifyStateChange()}onMuteEnd(){this.notifyStateChange()}notifyStateChange(){this.options.onStateChange&&this.options.onStateChange(this.getState())}log(...e){this.options.debug&&console.log("[SafePlay Controller]",...e)}}class m{constructor(e,t="Analyzing"){this.displayProgress=0,this.targetProgress=0,this.isComplete=!1,this.animationId=null,this.ANIMATION_INTERVAL=100,this.CATCH_UP_SPEED=.15,this.MIN_INCREMENT=.2,this.MAX_INCREMENT=3,this.callback=e,this.baseText=t}start(){this.displayProgress=0,this.targetProgress=0,this.isComplete=!1,this.startAnimation(),this.callback(0,`${this.baseText} 0%`)}setTarget(e){this.targetProgress=Math.max(e,this.targetProgress)}complete(){this.isComplete=!0,this.targetProgress=100}stop(){null!==this.animationId&&(clearInterval(this.animationId),this.animationId=null)}getProgress(){return this.displayProgress}startAnimation(){null===this.animationId&&(this.animationId=window.setInterval(()=>{this.tick()},this.ANIMATION_INTERVAL))}tick(){const e=this.targetProgress-this.displayProgress;if(e>.5){let t=e*this.CATCH_UP_SPEED;t=Math.max(t,this.MIN_INCREMENT),t=Math.min(t,this.MAX_INCREMENT),this.displayProgress=Math.min(this.displayProgress+t,this.targetProgress);const s=Math.round(this.displayProgress);this.callback(s,`${this.baseText} ${s}%`)}this.isComplete&&this.displayProgress>=99.5&&(this.displayProgress=100,this.callback(100,`${this.baseText} 100%`),this.stop())}}function y(...e){console.log("[SafePlay:Captions]",...e)}const f="(?=\\s|[.,!?;:'\"\\)\\-]|$)",w=[{pattern:new RegExp(`\\bf+[\\*\\#\\-\\_]+(?:ck(?:ing|ed|er|ers|s)?)?${f}`,"gi"),severity:"severe"},{pattern:new RegExp(`\\bf+u+[\\*\\#\\-\\_]+k*(?:ing|ed|er|ers|s)?${f}`,"gi"),severity:"severe"},{pattern:new RegExp(`\\bf[\\*\\#\\-\\_]{2,}(?:ing|ed|er|ers|s)?${f}`,"gi"),severity:"severe"},{pattern:new RegExp(`\\bs+h+[\\*\\#\\-\\_]+t*(?:ty|s|head|heads)?${f}`,"gi"),severity:"moderate"},{pattern:new RegExp(`\\bs[\\*\\#\\-\\_]{2,}t?${f}`,"gi"),severity:"moderate"},{pattern:new RegExp(`\\bb+[\\*\\#\\-\\_]+(?:tch(?:es|y)?)?${f}`,"gi"),severity:"moderate"},{pattern:new RegExp(`\\bb[\\*\\#\\-\\_]{2,}(?:es|y)?${f}`,"gi"),severity:"moderate"},{pattern:new RegExp(`\\ba+[\\*\\#\\-\\_]+(?:ss(?:hole|holes)?)?${f}`,"gi"),severity:"moderate"},{pattern:new RegExp(`\\ba[\\*\\#\\-\\_]{1,}(?:hole|holes)?${f}`,"gi"),severity:"moderate"},{pattern:new RegExp(`\\bc+[\\*\\#\\-\\_]+(?:nt|nts)?${f}`,"gi"),severity:"severe"},{pattern:new RegExp(`\\bd+[\\*\\#\\-\\_]+(?:ck|cks|ckhead)?${f}`,"gi"),severity:"moderate"},{pattern:new RegExp(`\\bp+[\\*\\#\\-\\_]+(?:ssy|ss(?:ies|y)?)?${f}`,"gi"),severity:"moderate"},{pattern:new RegExp(`\\bn+[\\*\\#\\-\\_]+(?:gg|gga|gger|ggers|ggas)?${f}`,"gi"),severity:"severe"},{pattern:new RegExp(`\\b\\w+[\\*\\#]+\\w*${f}`,"gi"),severity:"moderate"}];class b{constructor(e={}){this.observer=null,this.preferences=null,this.isActive=!1,this.censoredWordCount=0,this.lastProcessedTexts=new Map}initialize(e,t){this.preferences=e,y("Caption filter initialized")}start(){this.isActive?y("Caption filter already active"):(y("Starting caption filter - hijacking YouTube captions"),this.isActive=!0,this.censoredWordCount=0,this.lastProcessedTexts.clear(),this.setupCaptionObserver())}stop(){this.isActive&&(y("Stopping caption filter. Censored",this.censoredWordCount,"words total."),this.isActive=!1,this.observer&&(this.observer.disconnect(),this.observer=null),this.lastProcessedTexts.clear())}updatePreferences(e){this.preferences=e}getCensoredCount(){return this.censoredWordCount}setupCaptionObserver(){const e=[".ytp-caption-window-container",".caption-window","#movie_player .ytp-caption-window-bottom","#movie_player"];let t=null;for(const s of e)if(t=document.querySelector(s),t)break;if(!t)return y("Caption container not found, retrying in 500ms"),void setTimeout(()=>{this.isActive&&this.setupCaptionObserver()},500);y("Found caption container, setting up observer"),this.observer=new MutationObserver(e=>{if(this.isActive)for(const t of e)if("childList"===t.type&&t.addedNodes.forEach(e=>{this.processCaptionNode(e)}),"characterData"===t.type){const e=t.target;e.nodeType===Node.TEXT_NODE&&this.filterTextNode(e)}}),this.observer.observe(t,{childList:!0,subtree:!0,characterData:!0}),this.scanForCaptions(t),y("Caption observer active on container")}scanForCaptions(e){e.querySelectorAll(".ytp-caption-segment").forEach(e=>{this.filterCaptionElement(e)})}processCaptionNode(e){if(this.isActive)if(e.nodeType!==Node.TEXT_NODE){if(e.nodeType===Node.ELEMENT_NODE){const t=e;this.isCaptionElement(t)&&this.filterCaptionElement(t),t.querySelectorAll(".ytp-caption-segment").forEach(e=>{this.filterCaptionElement(e)})}}else this.filterTextNode(e)}isCaptionElement(e){if(!e)return!1;const t="string"==typeof e.className?e.className:e.className?.baseVal||"";return!!(t.includes("ytp-caption-segment")||t.includes("captions-text")||t.includes("caption-visual-line")||e.closest(".ytp-caption-window-container")||e.closest(".caption-window"))}filterCaptionElement(e){if(!this.preferences)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null),s=[];let i;for(;i=t.nextNode();)s.push(i);s.forEach(e=>{this.filterTextNode(e)})}filterTextNode(e){if(!this.preferences)return;const t=e.textContent||"";if(!t.trim())return;if(this.lastProcessedTexts.get(e)===t)return;const s=this.censorText(t);s!==t?(e.textContent=s,this.lastProcessedTexts.set(e,s),y("Censored:",t,"->",s)):this.lastProcessedTexts.set(e,t)}censorText(e){if(!this.preferences)return e;let t=e,s=!1;t=this.replaceCensoredPatterns(t),t!==e&&(s=!0);const i=t.split(/(\s+)/);let r="";for(const e of i){if(!e||/^\s+$/.test(e)){r+=e;continue}if("(bleep)"===e){r+=e;continue}if(h(e)){r+=e;continue}const t=u(e);if(t.length>0){const e=t.filter(e=>{const t=e.severity;return this.preferences.severityLevels[t]});if(e.length>0){r+="(bleep)",this.censoredWordCount+=e.length,s=!0;continue}}const i=e.toLowerCase().replace(/[.,!?;:'"()-]/g,"");this.preferences.customBlacklist.some(e=>i===e.toLowerCase())?(r+="(bleep)",this.censoredWordCount++,s=!0):r+=e}return s?r:e}replaceCensoredPatterns(e){if(!this.preferences)return e;let t=e;for(const{pattern:e,severity:s}of w)if(this.preferences.severityLevels[s]&&(e.lastIndex=0,e.test(t))){e.lastIndex=0;const s=t.match(e);s&&(this.censoredWordCount+=s.length),t=t.replace(e,"(bleep)")}return t}}const S={enabled:!0,filterMode:"mute",severityLevels:{mild:!1,moderate:!0,severe:!0,religious:!1},customBlacklist:[],customWhitelist:[],paddingMs:50,paddingBeforeMs:100,paddingAfterMs:30,mergeThresholdMs:100,autoEnableForFilteredVideos:!0},x="safeplay_filtered_videos";async function C(){try{return(await chrome.storage.local.get(x))[x]||[]}catch(e){return console.error("[SafePlay Storage] Error getting filtered videos:",e),[]}}const I=!0;function E(...e){console.log("[SafePlay]",...e)}class k{constructor(){this.videoController=null,this.preferences=S,this.currentVideoId=null,this.filteringVideoId=null,this.isProcessing=!1,this.videoWasPlaying=!1,this.progressAnimator=null,this.lastIntervalCount=0,this.isFilterActive=!1,this.injector=new r({onButtonClick:e=>this.onFilterButtonClick(e),onToggleFilter:()=>this.toggleFilterFromButton(),debug:I}),this.videoController=new v({onStateChange:e=>this.onVideoStateChange(e),debug:I}),this.captionFilter=new b({debug:I})}async initialize(){E("Initializing SafePlay content script"),await this.loadPreferences(),this.injector.start(),(this.isWatchPage()||this.isShortsPage())&&(this.currentVideoId=this.getVideoIdFromUrl(),this.currentVideoId&&setTimeout(()=>this.checkAutoEnable(),1e3)),this.setupMessageListener(),this.setupNavigationListener(),E("SafePlay initialized")}async loadPreferences(){try{const e=await chrome.runtime.sendMessage({type:"GET_PREFERENCES"});e.success&&e.data&&(this.preferences=e.data)}catch(e){E("Failed to load preferences:",e)}}isWatchPage(){return"/watch"===window.location.pathname}isShortsPage(){return window.location.pathname.startsWith("/shorts")}getVideoIdFromUrl(){if(this.isWatchPage())return new URLSearchParams(window.location.search).get("v");if(this.isShortsPage()){const e=window.location.pathname.match(/\/shorts\/([a-zA-Z0-9_-]+)/);return e?e[1]:null}return null}updateButtonState(e){this.injector.updateButtonState(e)}getVideoElement(){return document.querySelector("video.html5-main-video")||document.querySelector("video.video-stream")||document.querySelector("#movie_player video")||document.querySelector("video")}async onFilterButtonClick(e){if(this.isProcessing)return void E("Already processing, ignoring click");E("Filter button clicked for:",e),this.isProcessing=!0,this.currentVideoId=e,this.filteringVideoId=e;const t=this.getVideoElement();this.videoWasPlaying=!(!t||t.paused),t&&this.videoWasPlaying&&(t.pause(),E("Video paused while loading filter"));try{this.updateButtonState({state:"connecting",text:"Connecting...",videoId:e});const t=await chrome.runtime.sendMessage({type:"GET_FILTER",payload:{youtubeId:e}});if(!t.success)throw new Error(t.error||"Failed to request filter");const{status:s,transcript:i,jobId:r}=t.data;if("cached"!==s&&"completed"!==s||!i){if("processing"!==s||!r)throw new Error("Unexpected API response");E("Job started, polling for completion:",r),await this.pollJobStatus(r)}else E("Using cached transcript"),this.updateButtonState({state:"processing",text:"Processing...",videoId:e}),await this.applyFilter(i)}catch(t){E("Filter request failed:",t);const s=t instanceof Error?t.message:"Unknown error";if(this.updateButtonState({state:"error",text:"Error",error:s,videoId:e}),this.videoWasPlaying){const e=this.getVideoElement();e&&(e.play(),E("Video resumed after error")),this.videoWasPlaying=!1}this.isProcessing=!1,this.filteringVideoId=null}}async pollJobStatus(e){let t=0;const s=this.filteringVideoId;for(this.progressAnimator=new m((e,t)=>{this.updateButtonState({state:"processing",text:t,progress:e,videoId:s||void 0})},"Analyzing"),this.progressAnimator.start();t<180;)try{const s=await chrome.runtime.sendMessage({type:"CHECK_JOB",payload:{jobId:e}});if(!s.success)throw new Error(s.error||"Failed to check job status");const{status:i,progress:r,transcript:o,error:n}=s.data;switch(E(`Job status: ${i}, progress: ${r}%`),i){case"pending":this.progressAnimator.setTarget(5);break;case"downloading":this.progressAnimator.setTarget(5+.25*r);break;case"transcribing":this.progressAnimator.setTarget(30+.55*r);break;case"completed":if(o)return this.progressAnimator.setTarget(95),await new Promise(e=>setTimeout(e,300)),this.progressAnimator.complete(),await new Promise(e=>setTimeout(e,500)),this.progressAnimator.stop(),this.progressAnimator=null,void await this.applyFilter(o);throw new Error("Job completed but no transcript returned");case"failed":throw new Error(n||"Processing failed");default:this.progressAnimator.setTarget(r)}await new Promise(e=>setTimeout(e,2e3)),t++}catch(e){E("Poll error:",e),this.progressAnimator&&(this.progressAnimator.stop(),this.progressAnimator=null);const t=e instanceof Error?e.message:"Unknown error";return this.updateButtonState({state:"error",text:"Error",error:t,videoId:s||void 0}),this.isProcessing=!1,void(this.filteringVideoId=null)}this.progressAnimator&&(this.progressAnimator.stop(),this.progressAnimator=null),this.updateButtonState({state:"error",text:"Timeout",error:"Processing took too long. Please try again.",videoId:s||void 0}),this.isProcessing=!1,this.filteringVideoId=null}async applyFilter(e){if(!this.videoController)throw new Error("Video controller not initialized");const t=this.filteringVideoId||this.currentVideoId;if(!t)throw new Error("No video ID");E("Transcript received for filtering:",{id:e.id,segmentCount:e.segments?.length,sampleSegment:e.segments?.[0]?{text:e.segments[0].text,times:`${e.segments[0].start_time}s - ${e.segments[0].end_time}s`,hasCharacters:!!e.segments[0].characters,charCount:e.segments[0].characters?.length,sampleChars:e.segments[0].characters?.slice(0,3)}:null});try{await this.videoController.initialize(t,this.preferences),this.videoController.onTranscriptReceived(e),await this.videoController.applyFilter();const s=this.videoController.getState().intervalCount||0,i=this.videoController.getMuteIntervals();if(this.lastIntervalCount=s,this.isFilterActive=!0,this.captionFilter.initialize(this.preferences,i),this.captionFilter.start(),E("Caption filter started"),this.updateButtonState({state:"filtering",text:`Censored (${s})`,intervalCount:s,videoId:t}),E(`Filter applied successfully. ${s} profanity instances will be muted.`),t&&await async function(e){try{const t=await C();if(!t.includes(e)){t.push(e);const s=t.slice(-500);await chrome.storage.local.set({[x]:s})}}catch(e){console.error("[SafePlay Storage] Error adding filtered video:",e)}}(t),this.videoWasPlaying){const e=this.getVideoElement();e&&(e.play(),E("Video resumed after filter applied")),this.videoWasPlaying=!1}this.injectPlayerControls()}catch(e){if(E("Failed to apply filter:",e),this.videoWasPlaying){const e=this.getVideoElement();e&&(e.play(),E("Video resumed after filter error")),this.videoWasPlaying=!1}throw e}finally{this.isProcessing=!1,this.filteringVideoId=null}}injectPlayerControls(){if(document.querySelector(".safeplay-player-controls"))return;const e=()=>{const t=document.querySelector(".ytp-right-controls");t?this.createPlayerButton(t):setTimeout(e,500)};e()}createPlayerButton(e){const t=document.createElement("button");t.className="ytp-button safeplay-player-controls safeplay-active",t.title="SafePlay Filter Active - Click to toggle",t.innerHTML='\n      <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">\n        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>\n      </svg>\n    ',t.addEventListener("click",()=>this.toggleFilter());const s=e.querySelector(".ytp-settings-button");s&&s.parentElement===e?e.insertBefore(t,s):e.insertBefore(t,e.firstChild)}async toggleFilter(){await this.toggleFilterFromButton()}async toggleFilterFromButton(){if(!this.videoController)return;const e=document.querySelector(".safeplay-player-controls");this.isFilterActive?(this.videoController.stop(),this.captionFilter.stop(),this.isFilterActive=!1,e?.classList.remove("safeplay-active"),e?.setAttribute("title","SafePlay Filter Paused - Click to resume"),this.updateButtonState({state:"paused",text:"Paused",intervalCount:this.lastIntervalCount}),E("Filter paused by user")):this.currentVideoId&&this.lastIntervalCount>0&&(this.videoController.resume(),this.captionFilter.start(),this.isFilterActive=!0,e?.classList.add("safeplay-active"),e?.setAttribute("title","SafePlay Filter Active - Click to toggle"),this.updateButtonState({state:"filtering",text:`Censored (${this.lastIntervalCount})`,intervalCount:this.lastIntervalCount}),E("Filter resumed by user"))}onVideoStateChange(e){E("Video state changed:",e),chrome.runtime.sendMessage({type:"VIDEO_STATE_CHANGED",payload:e}).catch(()=>{})}setupMessageListener(){chrome.runtime.onMessage.addListener((e,t,s)=>(this.handleMessage(e).then(s),!0))}async handleMessage(e){switch(e.type){case"PREFERENCES_UPDATED":{const t=e.payload;return this.preferences=t,this.videoController?.updatePreferences(t),this.captionFilter.updatePreferences(t),{success:!0}}case"GET_VIDEO_STATE":return{success:!0,data:this.videoController?.getState()||null};default:return{success:!1,error:"Unknown message type"}}}setupNavigationListener(){document.addEventListener("yt-navigate-finish",()=>{E("YouTube navigation detected"),this.onNavigation()}),window.addEventListener("popstate",()=>{this.onNavigation()})}onNavigation(){this.videoController&&this.videoController.stop(),this.captionFilter.stop(),this.currentVideoId=null,this.isProcessing=!1,this.isFilterActive=!1,this.lastIntervalCount=0;const e=document.querySelector(".safeplay-player-controls");e&&e.remove(),(this.isWatchPage()||this.isShortsPage())&&(this.currentVideoId=this.getVideoIdFromUrl(),this.currentVideoId&&setTimeout(()=>this.checkAutoEnable(),500))}async checkAutoEnable(){if(this.currentVideoId&&!1!==this.preferences.autoEnableForFilteredVideos&&!this.isProcessing)try{await async function(e){try{return(await C()).includes(e)}catch(e){return console.error("[SafePlay Storage] Error checking if video filtered:",e),!1}}(this.currentVideoId)&&(E(`Auto-enabling filter for previously filtered video: ${this.currentVideoId}`),this.onFilterButtonClick(this.currentVideoId))}catch(e){E("Error checking auto-enable:",e)}}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{(new k).initialize()}):(new k).initialize()})();
//# sourceMappingURL=content.js.map